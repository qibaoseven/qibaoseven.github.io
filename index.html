<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudentOS ç­çº§ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* ==================== å®Œæ•´æ ·å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            width: 1400px;
            max-width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        /* åŠ è½½ç•Œé¢ */
        .loading-screen {
            padding: 40px;
            text-align: center;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loading-header {
            margin-bottom: 40px;
        }

        .loading-header h1 {
            font-size: 3em;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .loading-header .subtitle {
            color: #718096;
            font-size: 1.2em;
        }

        .loading-animation {
            font-size: 4em;
            margin: 30px 0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        .progress-bar {
            width: 80%;
            max-width: 500px;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .sync-status {
            color: #4a5568;
            margin: 20px 0;
            font-size: 1.1em;
        }

        /* ç™»å½•ç•Œé¢ */
        .login-screen {
            padding: 40px;
            text-align: center;
            display: none;
        }

        .login-header {
            margin-bottom: 40px;
        }

        .login-header h1 {
            font-size: 3em;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .login-header .subtitle {
            color: #718096;
            font-size: 1.2em;
        }

        .login-box {
            max-width: 400px;
            margin: 0 auto;
        }

        .user-select {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            background: white;
            cursor: pointer;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* ä¸»ç•Œé¢ */
        .main-screen {
            display: none;
            min-height: 700px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            font-size: 2.5em;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-details {
            text-align: left;
        }

        .user-name {
            font-size: 1.3em;
            font-weight: bold;
        }

        .user-role {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .cloud-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cloud-status.online {
            background: rgba(72, 187, 120, 0.3);
        }

        .cloud-status.offline {
            background: rgba(245, 101, 101, 0.3);
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 250px;
            background: #f7fafc;
            border-right: 1px solid #e2e8f0;
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4a5568;
            font-size: 1.1em;
        }

        .menu-item:hover {
            background: #edf2f7;
            padding-left: 30px;
        }

        .menu-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .menu-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: 600px;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.4em;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #718096;
            margin-top: 5px;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            background: #edf2f7;
            color: #4a5568;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-warning {
            background: #f6ad55;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th,
        .report-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .report-table th {
            background: #f7fafc;
            font-weight: 600;
        }

        .report-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .status-reported {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-unreported {
            background: #fed7d7;
            color: #742a2a;
        }

        .score-input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
        }

        .action-btn {
            padding: 5px 10px;
            margin: 0 2px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-minus {
            background: #f56565;
            color: white;
        }

        .btn-plus {
            background: #48bb78;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .folder-input {
            display: none;
        }

        .folder-label {
            display: block;
            padding: 30px;
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
            font-size: 1.1em;
        }

        .folder-label:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .folder-label .small {
            font-size: 0.9em;
            color: #718096;
            margin-top: 10px;
        }

        .file-list {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            padding: 5px;
            border-bottom: 1px solid #e2e8f0;
            font-family: monospace;
            font-size: 12px;
        }

        .file-item.success {
            color: #48bb78;
        }

        .file-item.error {
            color: #f56565;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .info-box {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .success-box {
            background: #f0fdf4;
            border-left: 4px solid #48bb78;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .reward-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .reward-card {
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            color: white;
        }

        .reward-rarity-SP { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .reward-rarity-SSR { background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%); }
        .reward-rarity-SR { background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); }
        .reward-rarity-R { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .reward-rarity-N { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }

        .reward-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .reward-type {
            opacity: 0.9;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .reward-desc {
            font-size: 0.95em;
            line-height: 1.4;
            opacity: 0.95;
        }

        .reward-prob {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.2);
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        /* æ–°å¢æ ·å¼ */
        .tab-container {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 8px 8px 0 0;
        }
        
        .tab.active {
            background: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
            font-weight: bold;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- åŠ è½½ç•Œé¢ -->
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-header">
                <h1>ğŸ“ StudentOS</h1>
                <div class="subtitle">æ­£åœ¨åŒæ­¥æ•°æ®...</div>
            </div>
            
            <div class="loading-animation" id="loadingAnimation">â˜ï¸</div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            
            <div class="sync-status" id="syncStatus">
                è¿æ¥ä¸­...
            </div>
        </div>

        <!-- ç™»å½•ç•Œé¢ -->
        <div class="login-screen" id="loginScreen">
            <div class="login-header">
                <h1>ğŸ“ StudentOS</h1>
                <div class="subtitle">ç­çº§ç®¡ç†ç³»ç»Ÿ</div>
            </div>
            <div class="login-box">
                <select class="user-select" id="userSelect">
                    <option value="">è¯·é€‰æ‹©è´¦å·...</option>
                </select>
                <input type="password" class="password-input" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                <button class="login-btn" onclick="handleLogin()">ç™»å½•ç³»ç»Ÿ</button>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div class="main-screen" id="mainScreen">
            <div class="header">
                <div class="user-info">
                    <span class="user-avatar" id="userAvatar" onclick="showAvatarSelector()">ğŸ‘¤</span>
                    <div class="user-details">
                        <div class="user-name" id="userDisplayName">åŠ è½½ä¸­...</div>
                        <div class="user-role" id="userRole">å­¦ç”Ÿ</div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div class="cloud-status" id="cloudStatus">
                        <span id="cloudIcon">â˜ï¸</span>
                        <span id="cloudText">æœ¬åœ°æ¨¡å¼</span>
                    </div>
                    <div class="friday-badge" id="fridayBadge">â° æŠ½å¥–æ—¶é—´ï¼šå‘¨äº”ä¸‹åˆ</div>
                </div>
            </div>
            
            <div class="main-content">
                <!-- ä¾§è¾¹æ èœå• -->
                <div class="sidebar" id="sidebar"></div>
                
                <!-- å†…å®¹åŒºåŸŸ -->
                <div class="content-area" id="contentArea"></div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨æ¨¡æ€æ¡† -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <div class="modal-title" id="modalTitle"></div>
            <div id="modalBody"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <script>
        // ==================== äº‘ç«¯é…ç½® ====================
        const CLOUD_CONFIG = {
            binId: "6975bf17d0ea881f4083a3af",
            masterKey: "$2a$10$jC76j4CEGgqz842YvvDucuoWG6emHsBbdqNr56rj8..53SEVCpp/u"
        };

        // ==================== æ•°æ®å­˜å‚¨é”® ====================
        const STORAGE_KEYS = {
            USERS: 'studentos_users',
            SCORES: 'studentos_scores',
            GROUPS: 'studentos_groups',
            RULES: 'studentos_rules',
            LOGS: 'studentos_logs',
            REWARDS: 'studentos_rewards',
            PUNISHMENTS: 'studentos_punishments',
            USER_PUNISHMENTS: 'studentos_user_punishments',
            GOLD: 'studentos_gold',
            EXCHANGE_RATE: 'studentos_exchange_rate',
            EMOJI: 'studentos_emoji',
            DAILY_REPORT: 'studentos_daily_report',
            CLOUD_META: 'studentos_cloud_meta'
        };

        // ==================== æ–‡ä»¶æ˜ å°„ ====================
        const FILE_MAPPING = {
            'user.json': 'users',
            'score.json': 'scores',
            'gold_data.json': 'gold',
            'rewards.json': 'rewards',
            'punishment.json': 'punishments',
            'usr_pun.json': 'userPunishments',
            'log.json': 'logs',
            'score_rules.json': 'rules',
            'exchange_rate.json': 'exchangeRate',
            'emoji.json': 'emoji'
        };

        // ==================== é»˜è®¤æ•°æ® ====================
        const DEFAULT_DATA = {
            users: {
                "è‹±è¯­-æ¢è€å¸ˆ": {
                    username: "è‹±è¯­-æ¢è€å¸ˆ",
                    password: "201709",
                    role: "root",
                    display_name: "è‹±è¯­-æ¢è€å¸ˆ",
                    student_id: "114",
                    avatar: "ğŸ‘©â€ğŸ«"
                },
                "è¯­æ–‡-ä»£è€å¸ˆ": {
                    username: "è¯­æ–‡-ä»£è€å¸ˆ",
                    password: "dai1117",
                    role: "root",
                    display_name: "è¯­æ–‡-ä»£è€å¸ˆ",
                    student_id: "514",
                    avatar: "ğŸ‘¨â€ğŸ«"
                },
                "user": {
                    username: "user",
                    password: "user",
                    role: "user",
                    display_name: "æ™®é€šç”¨æˆ·",
                    student_id: "0",
                    avatar: "ğŸ‘¤"
                },
                "admin": {
                    username: "admin",
                    password: "admins:1145",
                    role: "admin",
                    display_name: "ç®¡ç†å‘˜",
                    student_id: "999",
                    avatar: "ğŸ”§"
                },
                "root": {
                    username: "root",
                    password: "7949695D-141A-46A2-966F-A3E036ECB7A0",
                    role: "root",
                    display_name: "è¶…çº§ç®¡ç†å‘˜",
                    student_id: "9999",
                    avatar: "âš¡"
                },
                "ç¨‹ç…œå ƒ 23": {
                    username: "ç¨‹ç…œå ƒ 23",
                    password: "Mua52700!",
                    role: "root",
                    display_name: "ç¨‹ç…œå ƒ Bilibili@ä¸ƒå®-Seven",
                    student_id: "23",
                    avatar: "ğŸ˜«"
                },
                "å¢é’°æ£® 8": {
                    username: "å¢é’°æ£® 8",
                    password: "threebody",
                    role: "admin",
                    display_name: "å¢é’°æ£®",
                    student_id: "8",
                    avatar: "ğŸ‘¤"
                },
                "å‘¨é¸¿ç¿¼ 16": {
                    username: "å‘¨é¸¿ç¿¼ 16",
                    password: "zhy16",
                    role: "admin",
                    display_name: "å‘¨é¸¿ç¿¼",
                    student_id: "16",
                    avatar: "ğŸ‘¤"
                },
                "è®¸çš“å³° 29": {
                    username: "è®¸çš“å³° 29",
                    password: "xhf0316",
                    role: "admin",
                    display_name: "è®¸çš“å³°",
                    student_id: "29",
                    avatar: "ğŸ‘¤"
                },
                "è´¹é”¦è½© 41": {
                    username: "è´¹é”¦è½© 41",
                    password: "DTMFJX41",
                    role: "admin",
                    display_name: "è´¹é”¦è½©",
                    student_id: "41",
                    avatar: "ğŸ‘¤"
                },
                "èµµé›¨è¯º 50": {
                    username: "èµµé›¨è¯º 50",
                    password: "ZhaoYuNuo50",
                    role: "admin",
                    display_name: "èµµé›¨è¯º",
                    student_id: "50",
                    avatar: "ğŸ‘¤"
                },
                "å¾æµ© 24": {
                    username: "å¾æµ© 24",
                    password: "XuHao24",
                    role: "user",
                    display_name: "è¿…é£",
                    student_id: "24",
                    avatar: "ğŸ¤“"
                }
            },
            scores: {
                "0": ["testStudent", 3e71],
                "1": ["æ–¹æ¢¦åœ†", 117],
                "2": ["å§šä¼½æ‚¦", 148],
                "3": ["æ–¹ç‘¾æ¶µ", 122],
                "4": ["ä½•å¾å®‡è–‡", 129],
                "5": ["éƒ‘è‹¥æ¶›", 150],
                "6": ["è´ºé™å¥½", 165],
                "7": ["èŒƒæ™¨ç¿", 145],
                "8": ["å¢é’°æ£®", 222],
                "9": ["å‘¨ç°ä½³", 153],
                "10": ["é™ˆåŒæ˜•", 96],
                "11": ["æ–¹ç¥ˆä¹", 166],
                "12": ["é»„ç‰§ä¹‹", 75.5],
                "13": ["åˆ˜å®¶é½", 123],
                "14": ["å¼ æ¢“å®¸", 125],
                "15": ["ç‹å¯æ¶¦", 108],
                "16": ["å‘¨é¸¿ç¿¼", 119],
                "17": ["å·¦ç¥æ‰", 123.5],
                "18": ["æå­æ¶µ", 161.5],
                "19": ["åˆ˜æ¶¦æ³½", 114],
                "20": ["æ±ªæ«è¶Š", 131],
                "21": ["ç‹å‘ˆç‘€", 119],
                "22": ["é™ˆæ™¯å…ƒ", 130.5],
                "23": ["ç¨‹ç…œå ƒ", 165],
                "24": ["å¾æµ©", 120],
                "25": ["æå®¸é‘«", 100],
                "26": ["å‘¨æ©æµ¦", 103],
                "27": ["å‘¨æ€ç³", 106],
                "28": ["ç‹æ™ºå®¸", 97],
                "29": ["è®¸çš“å³°", 151],
                "30": ["ææ©å®‡", 215],
                "31": ["ç½—æ‰¬æ™´å·", 64],
                "32": ["æœ±æ°¸éœ–", 104],
                "33": ["ç‹èˆ’è±", 188],
                "34": ["ç”˜é‡‘æ££", 73],
                "35": ["æ¨æ¢¦å«", 106],
                "36": ["å‘¨å¦‚è±", 115],
                "37": ["å¼ æ‡¿è‘³", 177],
                "38": ["å‘¨å®‡æ¨", 159],
                "39": ["åˆ˜å¤©å®‡", 114],
                "40": ["é—µç›æ·", 105],
                "41": ["è´¹é”¦è½©", 112],
                "42": ["æ¨ç‰çª", 117],
                "43": ["ç‹æ™°é”", 91],
                "44": ["èƒ¡æ–‡ç«£è½©", 112],
                "45": ["é»„æ€ç¿", 172.5],
                "46": ["é™ˆä¸€æ­Œ", 122],
                "47": ["è´¾è´å¦®", 106],
                "48": ["å´æ¬£è‹’", 188],
                "49": ["ç‹è¯­æ±", 118],
                "50": ["èµµé›¨è¯º", 154],
                "51": ["è‚–ä¹çª", 120]
            },
            groups: {
                "1ç»„": ["1", "2", "3", "4", "5", "6", "7", "8"],
                "2ç»„": ["9", "10", "11", "12", "13", "14", "15", "16"],
                "3ç»„": ["17", "18", "19", "20", "21", "22", "23", "24", "25"],
                "4ç»„": ["26", "27", "28", "29", "30", "31", "32", "33", "34"],
                "5ç»„": ["35", "36", "37", "38", "39", "40", "41", "42"],
                "6ç»„": ["45", "46", "47", "48", "49", "50", "51", "43", "44"],
                "ç»„é•¿": ["6", "11", "19", "33", "37", "45"],
                "æœ‰èŒä½": ["2", "3", "4", "5", "8", "7", "6", "9", "11", "13", "14", "16", "17", "18", "21", "23", "22", "26", "28", "29", "30", "33", "37", "38", "39", "41", "45", "46", "48", "47", "50"]
            },
            rules: {
                "ä½œä¸šå®Œæˆ": {"value": 2, "column": "C", "type": "åŠ åˆ†"},
                "ä½œä¸šæœªå®Œæˆ": {"value": -2, "column": "D", "type": "æ‰£åˆ†"},
                "å€¼æ—¥ä¼˜ç§€": {"value": 2, "column": "E", "type": "åŠ åˆ†"},
                "å€¼æ—¥ä¸åˆæ ¼": {"value": -2, "column": "E", "type": "æ‰£åˆ†"},
                "çºªå¾‹è‰¯å¥½": {"value": 2, "column": "F", "type": "åŠ åˆ†"},
                "è¿åçºªå¾‹": {"value": -2, "column": "F", "type": "æ‰£åˆ†"},
                "ä¸äº¤å¹³æ¿": {"value": -6, "column": "S", "type": "æ‰£åˆ†"},
                "äº¤é”™å¹³æ¿": {"value": -3, "column": "S", "type": "æ‰£åˆ†"},
                "å¹³æ¿1æ¬¡": {"value": -1, "column": "S", "type": "æ‰£åˆ†"},
                "å¹³æ¿2æ¬¡": {"value": -3, "column": "S", "type": "æ‰£åˆ†"},
                "è¯¾ä»£è¡¨15/3æœˆ": {"value": 15, "column": "S", "type": "åŠ åˆ†"},
                "noæ¶å‡³å­": {"value": -2, "column": "S", "type": "æ‰£åˆ†"},
                "æ´»åŠ¨è·å¥–ä¸€ç­‰å¥–": {"value": 5, "column": "L", "type": "åŠ åˆ†"},
                "æ´»åŠ¨è·å¥–äºŒç­‰å¥–": {"value": 4, "column": "M", "type": "åŠ åˆ†"},
                "è€ƒè¯•å•ç§‘ç¬¬ä¸€": {"value": 5, "column": "O", "type": "åŠ åˆ†"}
            },
            rewards: {
                "SSR": [
                    {"name": "+50åˆ†", "type": "è™šæ‹Ÿ", "description": "+50å­¦åˆ†", "probability": 5},
                    {"name": "å…ä½œä¸šé€šè¡Œè¯", "type": "ç‰¹æƒ", "description": "ä¸€æ¬¡æ€§æŠµæ¶ˆä»»æ„ä¸€é—¨ç§‘ç›®çš„ä½œä¸š", "probability": 5},
                    {"name": "Bç«™å¹´åº¦å¤§ä¼šå‘˜ä½“éªŒå¡", "type": "è™šæ‹Ÿ", "description": "è€å¸ˆçš„Bç«™è´¦å·å€Ÿä½ åˆ·ä¸€å‘¨ï¼ˆåœ¨è€å¸ˆç›‘ç£ä¸‹ï¼‰", "probability": 5}
                ],
                "SR": [
                    {"name": "+25åˆ†", "type": "è™šæ‹Ÿ", "description": "+25å­¦åˆ†", "probability": 15},
                    {"name": "å…ç½ªé‡‘ç‰Œ", "type": "ç‰¹æƒ", "description": "æŠµæ¶ˆä¸€æ¬¡å°å¤±è¯¯å¸¦æ¥çš„æƒ©ç½š", "probability": 15},
                    {"name": "åº§ä½æŒ‡å®šç‹æƒ", "type": "ç‰¹æƒ", "description": "ä¸‹ä¸€å‘¨è‡ªé€‰åº§ä½æƒåŠ›", "probability": 15}
                ],
                "R": [
                    {"name": "+15åˆ†", "type": "è™šæ‹Ÿ", "description": "+15å­¦åˆ†", "probability": 30},
                    {"name": "è¯¾é—´ç‚¹æ­Œæƒ", "type": "ç‰¹æƒ", "description": "æŒ‡å®šæ’­æ”¾ä¸€é¦–è¯¾é—´éŸ³ä¹", "probability": 30},
                    {"name": "å­¦éœ¸æ–‡å…·åŒ…", "type": "å®ç‰©", "description": "é«˜é¢œå€¼æ–‡å…·å¥—è£…", "probability": 30}
                ],
                "N": [
                    {"name": "+2åˆ†", "type": "è™šæ‹Ÿ", "description": "+2å­¦åˆ†", "probability": 5},
                    {"name": "è€å¸ˆçš„è‚¯å®š", "type": "ä½“éªŒ", "description": "è€å¸ˆæ‰‹å†™æ˜ä¿¡ç‰‡å¯„è¯­", "probability": 5},
                    {"name": "æ¬§æ°”å–·é›¾", "type": "å®ç‰©", "description": "ä¸€ç“¶å“ç‰Œå¯ä¹", "probability": 5}
                ]
            },
            punishments: {
                "SP": [
                    {"name": "ç­çº§æˆé•¿æ—¥è®°", "description": "è®°å½•ç­çº§ä¸€å‘¨çš„æˆé•¿ç‚¹æ»´ï¼Œåˆ¶ä½œæˆå›¾æ–‡å¹¶èŒ‚çš„ç”µå­ç›¸å†Œ", "probability": 1, "score": [10, 8], "time": ["14d", "æŒç»­ä¸€å‘¨"]}
                ],
                "SSR": [
                    {"name": "ç¬¬ä¸€æ¬¡å‘Bç«™", "description": "åœ¨ç¨‹ç…œå ƒçš„Bç«™è´¦å·å‘é“æ­‰è§†é¢‘", "probability": 1, "score": [20, 5], "time": ["15d", "5m"]},
                    {"name": "ç¼–ç¨‹åˆä½“éªŒ", "description": "ç”¨Pythonå®Œæˆä¸€ä¸ªç®€å•çš„å°ç¨‹åº", "probability": 2, "score": [10, 5], "time": ["20d", "ä¸é™"]}
                ],
                "SR": [
                    {"name": "æ—§äº‹é‡èƒŒ", "description": "èƒŒè¯µã€ŠæœèŠ±å¤•æ‹¾ã€‹ä¸€ç¯‡", "probability": 10, "score": [10, -3], "time": ["8d", "20m"]}
                ],
                "R": [
                    {"name": "è¯¾æ–‡æŠ„å†™", "description": "æŠ„å†™è¯¾æ–‡2é", "probability": 20, "score": [5, -1], "time": ["3d", "25m"]},
                    {"name": "å•è¯é—¯å…³", "description": "è®°å¿†30ä¸ªè‹±è¯­å•è¯", "probability": 25, "score": [6, -1], "time": ["4d", "15m"]}
                ],
                "N": [
                    {"name": "å€¼æ—¥ä»»åŠ¡", "description": "é¢å¤–å€¼æ—¥ä¸‰å¤©", "probability": 50, "score": [3, -1], "time": ["3d", "10m"]},
                    {"name": "è¯¾åæé—®", "description": "å‘è€å¸ˆæ2ä¸ªé—®é¢˜", "probability": 45, "score": [2, -1], "time": ["2d", "5m"]}
                ]
            },
            exchangeRate: {
                score_to_gold: 11.91913310805437,
                gold_to_score: 0.0107428989499882,
                last_updated: "2025-12-16 17:51:42"
            },
            emoji: "ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜‡ğŸ™‚ğŸ™ƒğŸ˜‰ğŸ˜ŒğŸ˜ğŸ¥°ğŸ˜˜ğŸ˜—ğŸ˜™ğŸ˜šğŸ˜‹ğŸ˜›ğŸ˜ğŸ˜œğŸ¤ªğŸ¤¨ğŸ§ğŸ¤“ğŸ˜ğŸ¥¸ğŸ¤©ğŸ¥³ğŸ˜ğŸ˜’ğŸ˜ğŸ˜”ğŸ˜ŸğŸ˜•ğŸ™â˜¹ï¸ğŸ˜£ğŸ˜–ğŸ˜«ğŸ˜©ğŸ¥ºğŸ˜¢ğŸ˜­ğŸ˜¤ğŸ˜ ğŸ˜¡ğŸ¤¬ğŸ¤¯ğŸ˜³ğŸ¥µğŸ¥¶ğŸ˜±ğŸ˜¨ğŸ˜°ğŸ˜¥ğŸ˜“",
            userPunishments: {
                active: {
                    "0": [],
                    "23": []
                },
                completed: {
                    "0": [
                        {
                            "id": "pun_20251102215618",
                            "name": "è¯¾åæé—®",
                            "description": "å‘è€å¸ˆæå‡º2ä¸ªæœ‰æ·±åº¦çš„å­¦ç§‘é—®é¢˜",
                            "rarity": "N",
                            "time_limit": "2d",
                            "task_duration": "5m",
                            "success_gold": 20,
                            "fail_gold": -10,
                            "deadline": "2025-11-04T21:56:18.000Z",
                            "draw_time": "2025-11-02T21:56:18.000Z",
                            "status": "completed",
                            "completion_time": "2025-11-02T22:14:45.000Z",
                            "result": "æˆåŠŸå®Œæˆ",
                            "final_gold": 20,
                            "witness": "ç¨‹ç…œå ƒ",
                            "witness_id": "23"
                        }
                    ],
                    "23": [
                        {
                            "id": "pun_20251115123141",
                            "name": "ç¼–ç¨‹åˆä½“éªŒ",
                            "description": "ä½¿ç”¨Pythonå®Œæˆä¸€ä¸ªç®€å•çš„å°ç¨‹åº",
                            "rarity": "SSR",
                            "time_limit": "20d",
                            "task_duration": "ä¸é™",
                            "success_gold": 100,
                            "fail_gold": 50,
                            "deadline": "2025-12-05T12:31:41.000Z",
                            "draw_time": "2025-11-15T12:31:41.000Z",
                            "status": "completed",
                            "completion_time": "2025-11-15T12:35:01.000Z",
                            "result": "æˆåŠŸå®Œæˆ",
                            "final_gold": 100,
                            "witness": "testStudent",
                            "witness_id": "0"
                        }
                    ]
                }
            },
            gold: {
                "1": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "2": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "3": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "4": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "5": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "6": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "7": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "8": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "9": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "10": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "11": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "12": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "13": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "14": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "15": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "16": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "17": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "18": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "19": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "20": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "21": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "22": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "23": { "amount": 20.5, "last_updated": "2025-11-15 12:26:24" },
                "24": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "25": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "26": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "27": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "28": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "29": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "30": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "31": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "32": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "33": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "34": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "35": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "36": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "37": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "38": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "39": { "amount": 11, "last_updated": "2025-11-09 00:21:28" },
                "40": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "41": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "42": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "43": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "44": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "45": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "46": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "47": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "48": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "49": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "50": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "51": { "amount": 10, "last_updated": "2025-11-09 00:21:28" },
                "ç¨‹ç…œå ƒ 23": { "amount": 120.5, "last_updated": "2025-11-15 12:35:01" },
                "0": { "amount": 1.21e48, "last_updated": "2025-11-26 12:03:24" }
            },
            dailyReport: {},
            logs: [],
            cloudMeta: { updated: 0, lastSync: null }
        };

        // ==================== å…¨å±€çŠ¶æ€ ====================
        let currentUser = null;
        let appData = {
            users: {},
            scores: {},
            groups: {},
            rules: {},
            logs: [],
            rewards: {},
            punishments: {},
            userPunishments: { active: {}, completed: {} },
            gold: {},
            exchangeRate: {},
            emoji: '',
            dailyReport: {},
            cloudMeta: { updated: 0, lastSync: null }
        };

        // ==================== å·¥å…·å‡½æ•° ====================
        function formatDate(date = new Date()) {
            return date.toISOString().slice(0, 19).replace('T', ' ');
        }

        function getBeijingDate(date = new Date()) {
            const beijingTime = new Date(date.getTime() + 8 * 60 * 60 * 1000);
            return beijingTime.toISOString().split('T')[0];
        }

        function isFridayAfternoon() {
            const now = new Date();
            return now.getDay() === 5 && now.getHours() >= 12;
        }

        function saveData(key) {
            const storageKey = STORAGE_KEYS[key.toUpperCase()];
            if (storageKey && appData[key] !== undefined) {
                localStorage.setItem(storageKey, JSON.stringify(appData[key]));
            }
        }

        function saveAllData() {
            Object.keys(STORAGE_KEYS).forEach(key => {
                const dataKey = key.toLowerCase();
                if (appData[dataKey] !== undefined) {
                    localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(appData[dataKey]));
                }
            });
        }

        function loadFromStorage() {
            let hasData = false;
            for (const [key, storageKey] of Object.entries(STORAGE_KEYS)) {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    try {
                        appData[key.toLowerCase()] = JSON.parse(stored);
                        hasData = true;
                    } catch (e) {
                        console.error(`è§£æ ${key} å¤±è´¥:`, e);
                    }
                }
            }
            return hasData;
        }

        // ==================== äº‘ç«¯ä¸Šä¼  ====================
        async function uploadToCloud(data) {
            const url = `https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}`;
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": CLOUD_CONFIG.masterKey
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`ä¸Šä¼ å¤±è´¥: HTTP ${response.status}`);
            }
            
            return await response.json();
        }

        // ==================== ä»äº‘ç«¯ä¸‹è½½ ====================
        async function downloadFromCloud() {
            const url = `https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}/latest`;
            
            const response = await fetch(url, {
                headers: { "X-Master-Key": CLOUD_CONFIG.masterKey }
            });
            
            if (!response.ok) {
                throw new Error(`ä¸‹è½½å¤±è´¥: HTTP ${response.status}`);
            }
            
            const data = await response.json();
            return data.record || data;
        }

        // ==================== æƒé™æ£€æŸ¥ ====================
        function hasPermission(permission) {
            if (!currentUser) return false;
            const role = currentUser.role;
            
            const permissions = {
                user: ['æˆ‘çš„åˆ†æ•°', 'æ’åç®¡ç†', 'å­¦åˆ†æŠ½å¥–', 'æƒ©ç½šç®¡ç†', 'é‡‘å¸ç³»ç»Ÿ'],
                admin: ['åˆ†æ•°ç®¡ç†', 'åˆ†ç»„ç®¡ç†', 'æ’åç®¡ç†', 'æ•°æ®å¤‡ä»½', 'å­¦åˆ†æŠ½å¥–', 'æƒ©ç½šç®¡ç†', 'é‡‘å¸ç³»ç»Ÿ', 'æˆ‘çš„åˆ†æ•°', 'æ¯æ—¥æ±‡æŠ¥', 'äº‘ç«¯åŒæ­¥', 'æ“ä½œæ—¥å¿—'],
                root: ['åˆ†æ•°ç®¡ç†', 'åˆ†ç»„ç®¡ç†', 'æ’åç®¡ç†', 'æ“ä½œæ—¥å¿—', 'æ•°æ®å¤‡ä»½', 'å­¦åˆ†æŠ½å¥–', 'æƒ©ç½šç®¡ç†', 'é‡‘å¸ç³»ç»Ÿ', 'æˆ‘çš„åˆ†æ•°', 'æ¯æ—¥æ±‡æŠ¥', 'äº‘ç«¯åŒæ­¥']
            };
            
            return permissions[role]?.includes(permission) || false;
        }

        // ==================== ç™»å½• ====================
        function renderUserSelect() {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è´¦å·...</option>';
            
            Object.values(appData.users).forEach(user => {
                if (user && user.username) {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = `${user.display_name || user.username} (${user.role || 'user'})`;
                    select.appendChild(option);
                }
            });
        }

        function handleLogin() {
            const username = document.getElementById('userSelect').value;
            const password = document.getElementById('password').value;
            
            if (!username) {
                alert('è¯·é€‰æ‹©è´¦å·');
                return;
            }
            
            const user = appData.users[username];
            if (!user || user.password !== password) {
                alert('å¯†ç é”™è¯¯');
                return;
            }
            
            currentUser = { ...user, username };
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            
            document.getElementById('userAvatar').textContent = currentUser.avatar || 'ğŸ‘¤';
            document.getElementById('userDisplayName').textContent = currentUser.display_name || username;
            const roleNames = { user: 'ğŸ‘¤ å­¦ç”Ÿ', admin: 'ğŸ”§ ç®¡ç†å‘˜', root: 'âš¡ è¶…çº§ç®¡ç†å‘˜' };
            document.getElementById('userRole').textContent = roleNames[currentUser.role] || 'å­¦ç”Ÿ';
            
            const fridayBadge = document.getElementById('fridayBadge');
            fridayBadge.innerHTML = isFridayAfternoon() ? 
                'ğŸ‰ ç°åœ¨æ˜¯å‘¨äº”ä¸‹åˆï¼Œå¯ä»¥æŠ½å¥–å•¦ï¼' : 
                'â° æŠ½å¥–æ—¶é—´ï¼šå‘¨äº”ä¸‹åˆ12:00å';
            
            renderSidebar();
            showDashboard();
        }

        // ==================== ä¾§è¾¹æ  ====================
        function renderSidebar() {
            const menuItems = [
                { id: 'dashboard', icon: 'ğŸ ', name: 'æ§åˆ¶å°', permission: null },
                { id: 'myScore', icon: 'ğŸ“Š', name: 'æˆ‘çš„åˆ†æ•°', permission: 'æˆ‘çš„åˆ†æ•°' },
                { id: 'score', icon: 'ğŸ“Š', name: 'åˆ†æ•°ç®¡ç†', permission: 'åˆ†æ•°ç®¡ç†' },
                { id: 'group', icon: 'ğŸ‘¥', name: 'åˆ†ç»„ç®¡ç†', permission: 'åˆ†ç»„ç®¡ç†' },
                { id: 'ranking', icon: 'ğŸ†', name: 'æ’åç®¡ç†', permission: 'æ’åç®¡ç†' },
                { id: 'dailyReport', icon: 'ğŸ“‹', name: 'æ¯æ—¥æ±‡æŠ¥', permission: 'æ¯æ—¥æ±‡æŠ¥' },
                { id: 'gacha', icon: 'ğŸ°', name: 'å­¦åˆ†æŠ½å¥–', permission: 'å­¦åˆ†æŠ½å¥–' },
                { id: 'punishment', icon: 'ğŸ¯', name: 'æƒ©ç½šç®¡ç†', permission: 'æƒ©ç½šç®¡ç†' },
                { id: 'gold', icon: 'ğŸ’°', name: 'é‡‘å¸ç³»ç»Ÿ', permission: 'é‡‘å¸ç³»ç»Ÿ' },
                { id: 'logs', icon: 'ğŸ“‹', name: 'æ“ä½œæ—¥å¿—', permission: 'æ“ä½œæ—¥å¿—' },
                { id: 'cloudSync', icon: 'â˜ï¸', name: 'äº‘ç«¯åŒæ­¥', permission: 'äº‘ç«¯åŒæ­¥' },
                { id: 'backup', icon: 'ğŸ’¾', name: 'æ•°æ®å¤‡ä»½', permission: 'æ•°æ®å¤‡ä»½' },
                { id: 'account', icon: 'ğŸ‘¤', name: 'è´¦å·ç®¡ç†', permission: null },
                { id: 'logout', icon: 'ğŸšª', name: 'é€€å‡ºç³»ç»Ÿ', permission: null }
            ];
            
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';
            
            menuItems.forEach(item => {
                if (item.permission && !hasPermission(item.permission)) return;
                
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `${item.icon} ${item.name}`;
                div.onclick = () => {
                    if (item.id === 'logout') {
                        if (confirm('ç¡®å®šè¦é€€å‡ºç³»ç»Ÿå—ï¼Ÿ')) {
                            currentUser = null;
                            document.getElementById('loginScreen').style.display = 'block';
                            document.getElementById('mainScreen').style.display = 'none';
                            document.getElementById('password').value = '';
                        }
                        return;
                    }
                    
                    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
                    div.classList.add('active');
                    
                    switch(item.id) {
                        case 'dashboard': showDashboard(); break;
                        case 'myScore': showMyScore(); break;
                        case 'score': showScoreManagement(); break;
                        case 'group': showGroupManagement(); break;
                        case 'ranking': showRanking(); break;
                        case 'dailyReport': showDailyReport(); break;
                        case 'gacha': showGacha(); break;
                        case 'punishment': showPunishment(); break;
                        case 'gold': showGoldSystem(); break;
                        case 'logs': showLogs(); break;
                        case 'cloudSync': showCloudSync(); break;
                        case 'backup': showBackup(); break;
                        case 'account': showAccountManagement(); break;
                    }
                };
                sidebar.appendChild(div);
            });
        }

        // ==================== æ§åˆ¶å° ====================
        function showDashboard() {
            const studentId = currentUser.student_id;
            const score = getStudentScore(studentId);
            const gold = getStudentGold(studentId);
            
            const studentCount = Object.keys(appData.scores).filter(id => id !== '0').length;
            const today = getBeijingDate();
            const reportedToday = (appData.dailyReport[today] || []).length;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ“Š ç³»ç»Ÿæ§åˆ¶å°</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${score}</div>
                            <div class="stat-label">æˆ‘çš„å­¦åˆ†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${gold}</div>
                            <div class="stat-label">æˆ‘çš„é‡‘å¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${studentCount}</div>
                            <div class="stat-label">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${reportedToday}</div>
                            <div class="stat-label">ä»Šæ—¥å·²æ±‡æŠ¥</div>
                        </div>
                    </div>
                    
                    <h3>ğŸ“¢ ç³»ç»Ÿå…¬å‘Š</h3>
                    <ul style="margin: 20px 0; list-style: none;">
                        <li style="margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 8px;">
                            ğŸ‰ å­¦åˆ†æŠ½å¥–åªåœ¨å‘¨äº”ä¸‹åˆå¼€æ”¾
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 8px;">
                            ğŸ¯ æƒ©ç½šæŠ½å–æ¡ä»¶ï¼šåˆ†æ•°ä½äº100åˆ†
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 8px;">
                            ğŸ’° é‡‘å¸ç³»ç»Ÿå·²ä¸Šçº¿ï¼Œå¯ä»¥å…‘æ¢å­¦åˆ†ï¼
                        </li>
                    </ul>
                    
                    <h3>ğŸ“ˆ è¿‘æœŸæ´»åŠ¨</h3>
                    <div style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                        ${(appData.logs || []).slice(0, 5).map(log => `
                            <div style="padding: 10px; border-left: 3px solid #667eea; margin: 10px 0; background: #f7fafc;">
                                <div>ğŸ“… ${log.timestamp}</div>
                                <div>${log.student_name || 'æœªçŸ¥'} ${log.action}: ${log.score_change > 0 ? '+' : ''}${log.score_change}åˆ†</div>
                                ${log.reason ? `<div style="color: #718096;">ğŸ“ ${log.reason}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ==================== æˆ‘çš„åˆ†æ•° ====================
        function showMyScore() {
            const studentId = currentUser.student_id;
            const studentName = appData.scores[studentId]?.[0] || 'æœªçŸ¥';
            const score = getStudentScore(studentId);
            
            const myLogs = (appData.logs || []).filter(log => log.student_id === studentId);
            
            let totalAdd = 0, totalDeduct = 0;
            myLogs.forEach(log => {
                if (log.score_change > 0) totalAdd += log.score_change;
                else totalDeduct += Math.abs(log.score_change);
            });
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ“Š æˆ‘çš„åˆ†æ•°</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${score}</div>
                            <div class="stat-label">å½“å‰åˆ†æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">+${totalAdd}</div>
                            <div class="stat-label">æ€»åŠ åˆ†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">-${totalDeduct}</div>
                            <div class="stat-label">æ€»æ‰£åˆ†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${myLogs.length}</div>
                            <div class="stat-label">å˜åŒ–æ¬¡æ•°</div>
                        </div>
                    </div>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="showMyScoreDetail()">æŸ¥çœ‹è¯¦ç»†</button>
                        <button class="btn btn-primary" onclick="showMyScoreHistory()">å†å²è®°å½•</button>
                        <button class="btn btn-primary" onclick="showMyScoreAnalysis()">æ•°æ®åˆ†æ</button>
                    </div>
                    
                    <h3 style="margin-top: 30px;">ğŸ•’ æœ€è¿‘å˜åŒ–</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                                <th>å˜åŒ–</th>
                                <th>åŸå› </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${myLogs.slice(0, 10).map(log => `
                                <tr>
                                    <td>${log.timestamp ? log.timestamp.split(' ')[1] : ''}</td>
                                    <td>${log.action || ''}</td>
                                    <td style="color: ${log.score_change > 0 ? '#48bb78' : '#f56565'}">
                                        ${log.score_change > 0 ? '+' : ''}${log.score_change}
                                    </td>
                                    <td>${log.reason || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showMyScoreDetail() {
            const studentId = currentUser.student_id;
            const studentName = appData.scores[studentId]?.[0] || 'æœªçŸ¥';
            const score = getStudentScore(studentId);
            
            showModal('æˆ‘çš„åˆ†æ•°è¯¦æƒ…', `
                <div style="text-align: center; margin: 20px 0;">
                    <div style="font-size: 3em;">${score}</div>
                    <div style="color: #718096;">å½“å‰å­¦åˆ†</div>
                </div>
                
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px;">
                    <p><strong>ğŸ‘¤ å§“åï¼š</strong>${studentName}</p>
                    <p><strong>ğŸ“ å­¦å·ï¼š</strong>${studentId}</p>
                    <p><strong>ğŸ† æ’åï¼š</strong>${getStudentRank(studentId)}</p>
                    <p><strong>ğŸ’° é‡‘å¸ï¼š</strong>${getStudentGold(studentId)}</p>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showMyScoreHistory() {
            const studentId = currentUser.student_id;
            const myLogs = (appData.logs || []).filter(log => log.student_id === studentId);
            
            showModal('åˆ†æ•°å†å²', `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${myLogs.map(log => `
                        <div style="padding: 15px; border-bottom: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>ğŸ“… ${log.timestamp}</span>
                                <span style="color: ${log.score_change > 0 ? '#48bb78' : '#f56565'}; font-weight: bold;">
                                    ${log.score_change > 0 ? '+' : ''}${log.score_change}
                                </span>
                            </div>
                            <div style="margin-top: 5px; color: #718096;">
                                ${log.action} ${log.reason ? `- ${log.reason}` : ''}
                            </div>
                            <div>â¡ï¸ åˆ†æ•°å˜ä¸º: ${log.current_score}</div>
                        </div>
                    `).join('')}
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showMyScoreAnalysis() {
            const studentId = currentUser.student_id;
            const myLogs = (appData.logs || []).filter(log => log.student_id === studentId);
            const score = getStudentScore(studentId);
            
            let totalAdd = 0, totalDeduct = 0, addCount = 0, deductCount = 0;
            
            myLogs.forEach(log => {
                if (log.score_change > 0) {
                    totalAdd += log.score_change;
                    addCount++;
                } else if (log.score_change < 0) {
                    totalDeduct += Math.abs(log.score_change);
                    deductCount++;
                }
            });
            
            const avgChange = myLogs.length ? (totalAdd - totalDeduct) / myLogs.length : 0;
            
            showModal('åˆ†æ•°åˆ†ææŠ¥å‘Š', `
                <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="stat-card">
                        <div class="stat-value">${totalAdd}</div>
                        <div class="stat-label">æ€»åŠ åˆ†</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalDeduct}</div>
                        <div class="stat-label">æ€»æ‰£åˆ†</div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <p><strong>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</strong></p>
                    <p>åŠ åˆ†æ¬¡æ•°: ${addCount}æ¬¡</p>
                    <p>æ‰£åˆ†æ¬¡æ•°: ${deductCount}æ¬¡</p>
                    <p>å‡€å˜åŒ–: ${totalAdd - totalDeduct}åˆ†</p>
                    <p>å¹³å‡æ¯æ¬¡: ${avgChange.toFixed(1)}åˆ†</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <p><strong>ğŸ¯ åˆ†æå»ºè®®</strong></p>
                    ${totalAdd > totalDeduct * 2 ? '<p>âœ… è¡¨ç°ä¼˜ç§€ï¼Œç»§ç»­ä¿æŒï¼</p>' : ''}
                    ${totalAdd > totalDeduct ? '<p>âœ… è¡¨ç°è‰¯å¥½ï¼Œç»§ç»­åŠªåŠ›ï¼</p>' : ''}
                    ${totalAdd === totalDeduct ? '<p>â¡ï¸ è¡¨ç°ç¨³å®šï¼Œäº‰å–æ›´å¤šåŠ åˆ†ï¼</p>' : ''}
                    ${totalAdd < totalDeduct ? '<p>âš ï¸ éœ€æ³¨æ„æ”¹è¿›è¡¨ç°ï¼</p>' : ''}
                    ${deductCount > addCount ? '<p>âš ï¸ æ‰£åˆ†æ¬¡æ•°è¾ƒå¤šï¼Œè¯·æ³¨æ„éµå®ˆçºªå¾‹</p>' : ''}
                    ${score < 100 ? '<p>ğŸ¯ åˆ†æ•°ä½äº100åˆ†ï¼Œå¯ä»¥æŠ½å–æƒ©ç½š</p>' : ''}
                    ${score >= 100 && score < 150 ? '<p>ğŸ¯ åˆ†æ•°è‰¯å¥½ï¼Œå¯ä»¥å‚ä¸æŠ½å¥–</p>' : ''}
                    ${score >= 150 ? '<p>ğŸ¯ åˆ†æ•°ä¼˜ç§€ï¼Œç»§ç»­ä¿æŒï¼</p>' : ''}
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function getStudentRank(studentId) {
            const scores = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id, data]) => ({ id, score: data[1] }))
                .sort((a, b) => b.score - a.score);
            
            const rank = scores.findIndex(s => s.id === studentId) + 1;
            return rank > 0 ? `ç¬¬${rank}å / å…±${scores.length}äºº` : 'æœªæ‰¾åˆ°';
        }

        // ==================== åˆ†æ•°ç®¡ç† ====================
        function showScoreManagement() {
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            const rules = Object.entries(appData.rules || {});
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ“Š åˆ†æ•°ç®¡ç†</h2>
                    
                    <div class="tab-container">
                        <div class="tab active" onclick="showScoreTab('manage')">ğŸ“ åˆ†æ•°æ“ä½œ</div>
                        <div class="tab" onclick="showScoreTab('rules')">ğŸ“‹ ç§¯åˆ†è§„åˆ™</div>
                        <div class="tab" onclick="showScoreTab('list')">ğŸ“‘ å­¦ç”Ÿåˆ—è¡¨</div>
                    </div>
                    
                    <div id="scoreManageTab" class="tab-content active">
                        <div class="btn-grid">
                            <button class="btn btn-primary" onclick="showScoreAddSingle()">â• å•ä¸ªåŠ åˆ†</button>
                            <button class="btn btn-primary" onclick="showScoreAddBatch()">ğŸ”¢ æ‰¹é‡åŠ åˆ†</button>
                            <button class="btn btn-primary" onclick="showScoreByReason()">ğŸ¯ åŸå› åŠ åˆ†</button>
                            <button class="btn btn-primary" onclick="showScoreSet()">ğŸ“ è®¾ç½®åˆ†æ•°</button>
                            <button class="btn btn-primary" onclick="showScoreGroupAdd()">ğŸ‘¥ åˆ†ç»„åŠ åˆ†</button>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <input type="text" placeholder="æœç´¢å­¦ç”Ÿ..." style="width: 100%; padding: 10px; margin-bottom: 20px; border: 2px solid #e2e8f0; border-radius: 8px;" 
                                   onkeyup="filterStudents(this.value)">
                            
                            <table class="data-table" id="scoreTable">
                                <thead>
                                    <tr>
                                        <th>å­¦å·</th>
                                        <th>å§“å</th>
                                        <th>åˆ†æ•°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${students.map(([id, [name, score]]) => `
                                        <tr data-name="${name}">
                                            <td>${id}</td>
                                            <td>${name}</td>
                                            <td>${score}</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="quickAddScore('${id}', 2)">+2</button>
                                                <button class="btn btn-sm" onclick="quickAddScore('${id}', -2)">-2</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="scoreRulesTab" class="tab-content">
                        <h3 style="margin-bottom: 15px;">ğŸ“‹ å½“å‰ç§¯åˆ†è§„åˆ™</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>è§„åˆ™åç§°</th>
                                    <th>åˆ†å€¼</th>
                                    <th>ç±»å‹</th>
                                    <th>Excelåˆ—</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rules.map(([name, rule]) => `
                                    <tr>
                                        <td>${name}</td>
                                        <td style="color: ${rule.value > 0 ? '#48bb78' : '#f56565'}">${rule.value > 0 ? '+' : ''}${rule.value}</td>
                                        <td>${rule.type}</td>
                                        <td>${rule.column}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div class="btn-grid" style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="showAddRule()">â• æ·»åŠ è§„åˆ™</button>
                            <button class="btn btn-danger" onclick="showDeleteRule()">ğŸ—‘ï¸ åˆ é™¤è§„åˆ™</button>
                        </div>
                    </div>
                    
                    <div id="scoreListTab" class="tab-content">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>å­¦å·</th>
                                    <th>å§“å</th>
                                    <th>åˆ†æ•°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map(([id, [name, score]]) => `
                                    <tr>
                                        <td>${id}</td>
                                        <td>${name}</td>
                                        <td>${score}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showScoreTab(tabName) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            
            if (tabName === 'manage') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('scoreManageTab').classList.add('active');
            } else if (tabName === 'rules') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('scoreRulesTab').classList.add('active');
            } else if (tabName === 'list') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('scoreListTab').classList.add('active');
            }
        }

        function showAddRule() {
            showModal('æ·»åŠ ç§¯åˆ†è§„åˆ™', `
                <div style="margin: 20px 0;">
                    <label>è§„åˆ™åç§°ï¼š</label>
                    <input type="text" id="ruleName" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                    
                    <label>åˆ†å€¼ï¼ˆæ­£æ•°åŠ åˆ†ï¼Œè´Ÿæ•°æ‰£åˆ†ï¼‰ï¼š</label>
                    <input type="number" id="ruleValue" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                    
                    <label>ç±»å‹ï¼š</label>
                    <select id="ruleType" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <option value="åŠ åˆ†">åŠ åˆ†</option>
                        <option value="æ‰£åˆ†">æ‰£åˆ†</option>
                    </select>
                    
                    <label>Excelåˆ—ï¼ˆC-Vï¼‰ï¼š</label>
                    <input type="text" id="ruleColumn" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="ä¾‹å¦‚: C, D, E...">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'æ·»åŠ ', onclick: 'handleAddRule()', className: 'btn-primary' }
            ]);
        }

        function handleAddRule() {
            const name = document.getElementById('ruleName').value.trim();
            const value = parseFloat(document.getElementById('ruleValue').value);
            const type = document.getElementById('ruleType').value;
            const column = document.getElementById('ruleColumn').value.toUpperCase();
            
            if (!name || isNaN(value) || !column) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            appData.rules[name] = { value, type, column };
            saveData('rules');
            alert('è§„åˆ™æ·»åŠ æˆåŠŸ');
            closeModal();
            showScoreManagement();
        }

        function showDeleteRule() {
            const rules = Object.keys(appData.rules || {});
            if (rules.length === 0) {
                alert('æš‚æ— è§„åˆ™å¯åˆ é™¤');
                return;
            }
            
            showModal('åˆ é™¤è§„åˆ™', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©è¦åˆ é™¤çš„è§„åˆ™ï¼š</label>
                    <select id="deleteRuleSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${rules.map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'åˆ é™¤', onclick: 'handleDeleteRule()', className: 'btn-danger' }
            ]);
        }

        function handleDeleteRule() {
            const name = document.getElementById('deleteRuleSelect').value;
            if (confirm(`ç¡®å®šè¦åˆ é™¤è§„åˆ™"${name}"å—ï¼Ÿ`)) {
                delete appData.rules[name];
                saveData('rules');
                alert('è§„åˆ™å·²åˆ é™¤');
                closeModal();
                showScoreManagement();
            }
        }

        function showScoreGroupAdd() {
            const groups = Object.keys(appData.groups || {});
            if (groups.length === 0) {
                alert('è¯·å…ˆåˆ›å»ºåˆ†ç»„');
                return;
            }
            
            showModal('åˆ†ç»„åŠ åˆ†', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©åˆ†ç»„ï¼š</label>
                    <select id="scoreGroupSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${groups.map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                    
                    <label>åŠ åˆ†/æ‰£åˆ†æ•°å€¼ï¼š</label>
                    <input type="number" id="groupScoreChange" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                    
                    <label>åŸå› ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <input type="text" id="groupScoreReason" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤', onclick: 'handleGroupScore()', className: 'btn-primary' }
            ]);
        }

        function handleGroupScore() {
            const groupName = document.getElementById('scoreGroupSelect').value;
            const change = parseFloat(document.getElementById('groupScoreChange').value);
            const reason = document.getElementById('groupScoreReason').value || 'åˆ†ç»„æ“ä½œ';
            
            if (isNaN(change)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°');
                return;
            }
            
            const members = appData.groups[groupName] || [];
            const validMembers = members.filter(id => appData.scores[id] && id !== '0');
            
            let success = 0;
            validMembers.forEach(id => {
                if (updateStudentScore(id, change, reason)) success++;
            });
            
            alert(`æ“ä½œæˆåŠŸï¼æˆåŠŸä¸º ${success} åå­¦ç”Ÿ${change > 0 ? 'åŠ ' : 'å‡'}åˆ†`);
            closeModal();
            showScoreManagement();
        }

        function filterStudents(keyword) {
            const rows = document.querySelectorAll('#scoreTable tbody tr');
            rows.forEach(row => {
                const name = row.getAttribute('data-name') || '';
                row.style.display = name.includes(keyword) ? '' : 'none';
            });
        }

        function quickAddScore(studentId, change) {
            if (updateStudentScore(studentId, change, 'å¿«é€Ÿè°ƒæ•´')) {
                showScoreManagement();
            }
        }

        function showScoreAddSingle() {
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id, [name, score]]) => `${id} - ${name} (${score}åˆ†)`);
            
            showModal('å•ä¸ªåŠ åˆ†', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
                    <select id="scoreStudentSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${students.map(s => `<option value="${s.split(' - ')[0]}">${s}</option>`).join('')}
                    </select>
                    
                    <label>åŠ åˆ†/æ‰£åˆ†æ•°å€¼ï¼š</label>
                    <input type="number" id="scoreChangeValue" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="æ­£æ•°ä¸ºåŠ åˆ†ï¼Œè´Ÿæ•°ä¸ºæ‰£åˆ†">
                    
                    <label>åŸå› ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <input type="text" id="scoreChangeReason" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="è¯·è¾“å…¥åŸå› ">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤', onclick: 'handleScoreAddSingle()', className: 'btn-primary' }
            ]);
        }

        function handleScoreAddSingle() {
            const studentId = document.getElementById('scoreStudentSelect').value;
            const change = parseFloat(document.getElementById('scoreChangeValue').value);
            const reason = document.getElementById('scoreChangeReason').value;
            
            if (isNaN(change)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°');
                return;
            }
            
            if (updateStudentScore(studentId, change, reason)) {
                closeModal();
                showScoreManagement();
            }
        }

        function showScoreAddBatch() {
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id, [name, score]]) => `<label style="display: block; margin: 5px;">
                    <input type="checkbox" value="${id}" class="batch-student"> ${id} - ${name} (${score}åˆ†)
                </label>`);
            
            showModal('æ‰¹é‡åŠ åˆ†', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px;">
                        ${students.join('')}
                    </div>
                    
                    <label style="margin-top: 15px; display: block;">
                        <input type="checkbox" onclick="toggleAllStudents(this)"> å…¨é€‰
                    </label>
                    
                    <label style="margin-top: 15px; display: block;">åŠ åˆ†/æ‰£åˆ†æ•°å€¼ï¼š</label>
                    <input type="number" id="batchScoreChange" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                    
                    <label>åŸå› ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <input type="text" id="batchScoreReason" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤', onclick: 'handleScoreAddBatch()', className: 'btn-primary' }
            ]);
        }

        function toggleAllStudents(checkbox) {
            document.querySelectorAll('.batch-student').forEach(cb => cb.checked = checkbox.checked);
        }

        function handleScoreAddBatch() {
            const checkboxes = document.querySelectorAll('.batch-student:checked');
            const change = parseFloat(document.getElementById('batchScoreChange').value);
            const reason = document.getElementById('batchScoreReason').value;
            
            if (checkboxes.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªå­¦ç”Ÿ');
                return;
            }
            
            if (isNaN(change)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°');
                return;
            }
            
            let success = 0;
            checkboxes.forEach(cb => {
                if (updateStudentScore(cb.value, change, reason)) success++;
            });
            
            alert(`æ“ä½œæˆåŠŸï¼æˆåŠŸä¸º ${success} åå­¦ç”Ÿ${change > 0 ? 'åŠ ' : 'å‡'}åˆ†`);
            closeModal();
            showScoreManagement();
        }

        function showScoreByReason() {
            const rules = Object.entries(appData.rules || {});
            
            if (rules.length === 0) {
                alert('æš‚æ— ç§¯åˆ†è§„åˆ™');
                return;
            }
            
            showModal('åŸå› åŠ åˆ†', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©åŸå› ï¼š</label>
                    <select id="reasonSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${rules.map(([name, rule]) => `
                            <option value="${name}">${name} (${rule.value > 0 ? '+' : ''}${rule.value}åˆ†)</option>
                        `).join('')}
                    </select>
                    
                    <label>é€‰æ‹©æ¨¡å¼ï¼š</label>
                    <div style="margin: 10px 0;">
                        <label><input type="radio" name="reasonMode" value="single" checked> å•ä¸ªå­¦ç”Ÿ</label>
                        <label style="margin-left: 20px;"><input type="radio" name="reasonMode" value="batch"> æ‰¹é‡å­¦ç”Ÿ</label>
                    </div>
                    
                    <div id="reasonStudentSelect" style="margin-top: 15px;">
                        <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
                        <select id="singleStudent" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                            ${Object.entries(appData.scores || {}).filter(([id]) => id !== '0').map(([id, [name, score]]) => `
                                <option value="${id}">${id} - ${name} (${score}åˆ†)</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤', onclick: 'handleScoreByReason()', className: 'btn-primary' }
            ]);
            
            document.querySelectorAll('input[name="reasonMode"]').forEach(radio => {
                radio.onclick = function() {
                    const selectDiv = document.getElementById('reasonStudentSelect');
                    if (this.value === 'batch') {
                        const students = Object.entries(appData.scores || {})
                            .filter(([id]) => id !== '0')
                            .map(([id, [name, score]]) => 
                                `<label style="display: block; margin: 5px;">
                                    <input type="checkbox" value="${id}" class="batch-reason-student"> ${id} - ${name} (${score}åˆ†)
                                </label>`
                            ).join('');
                        selectDiv.innerHTML = `
                            <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px;">
                                ${students}
                            </div>
                            <label style="margin-top: 10px;">
                                <input type="checkbox" onclick="toggleAllReasonStudents(this)"> å…¨é€‰
                            </label>
                        `;
                    } else {
                        selectDiv.innerHTML = `
                            <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
                            <select id="singleStudent" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                                ${Object.entries(appData.scores || {}).filter(([id]) => id !== '0').map(([id, [name, score]]) => `
                                    <option value="${id}">${id} - ${name} (${score}åˆ†)</option>
                                `).join('')}
                            </select>
                        `;
                    }
                };
            });
        }

        function toggleAllReasonStudents(checkbox) {
            document.querySelectorAll('.batch-reason-student').forEach(cb => cb.checked = checkbox.checked);
        }

        function handleScoreByReason() {
            const reason = document.getElementById('reasonSelect').value;
            const rule = appData.rules[reason];
            const mode = document.querySelector('input[name="reasonMode"]:checked').value;
            
            let studentIds = [];
            if (mode === 'single') {
                const studentId = document.getElementById('singleStudent')?.value;
                if (studentId) studentIds.push(studentId);
            } else {
                studentIds = Array.from(document.querySelectorAll('.batch-reason-student:checked')).map(cb => cb.value);
            }
            
            if (studentIds.length === 0) {
                alert('è¯·é€‰æ‹©å­¦ç”Ÿ');
                return;
            }
            
            let success = 0;
            studentIds.forEach(id => {
                if (updateStudentScore(id, rule.value, reason)) success++;
            });
            
            alert(`æ“ä½œæˆåŠŸï¼æˆåŠŸä¸º ${success} åå­¦ç”Ÿæ‰§è¡Œ "${reason}"`);
            closeModal();
            showScoreManagement();
        }

        function showScoreSet() {
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id, [name, score]]) => `${id} - ${name} (${score}åˆ†)`);
            
            showModal('è®¾ç½®åˆ†æ•°', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
                    <select id="setStudentSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${students.map(s => `<option value="${s.split(' - ')[0]}">${s}</option>`).join('')}
                    </select>
                    
                    <label>æ–°åˆ†æ•°ï¼š</label>
                    <input type="number" id="setScoreValue" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤', onclick: 'handleScoreSet()', className: 'btn-primary' }
            ]);
        }

        function handleScoreSet() {
            const studentId = document.getElementById('setStudentSelect').value;
            const newScore = parseFloat(document.getElementById('setScoreValue').value);
            
            if (isNaN(newScore)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°');
                return;
            }
            
            const oldScore = getStudentScore(studentId);
            appData.scores[studentId][1] = newScore;
            saveData('scores');
            addLog('è®¾ç½®åˆ†æ•°', studentId, newScore - oldScore, newScore, `ä»${oldScore}è®¾ç½®ä¸º${newScore}`);
            
            alert('è®¾ç½®æˆåŠŸ');
            closeModal();
            showScoreManagement();
        }

        // ==================== åˆ†ç»„ç®¡ç† ====================
        function showGroupManagement() {
            const groups = appData.groups || {};
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h2>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="showGroupCreate()">ğŸ†• åˆ›å»ºåˆ†ç»„</button>
                        <button class="btn btn-primary" onclick="showGroupAddMember()">â• æ·»åŠ æˆå‘˜</button>
                        <button class="btn btn-primary" onclick="showGroupRemoveMember()">â– ç§»é™¤æˆå‘˜</button>
                        <button class="btn btn-primary" onclick="showGroupList()">ğŸ“‹ æŸ¥çœ‹åˆ†ç»„</button>
                        <button class="btn btn-primary" onclick="showGroupAll()">ğŸ‘¥ å…¨éƒ¨è¯¦æƒ…</button>
                        <button class="btn btn-primary" onclick="showGroupScore()">ğŸ¯ åˆ†ç»„åŠ åˆ†</button>
                        <button class="btn btn-danger" onclick="showGroupDelete()">ğŸ—‘ï¸ åˆ é™¤åˆ†ç»„</button>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3>ğŸ“Š åˆ†ç»„æ¦‚è§ˆ</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${Object.keys(groups).length}</div>
                                <div class="stat-label">æ€»åˆ†ç»„æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${Object.values(groups).reduce((sum, g) => sum + g.length, 0)}</div>
                                <div class="stat-label">æ€»æˆå‘˜æ•°</div>
                            </div>
                        </div>
                        
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>åˆ†ç»„åç§°</th>
                                    <th>æˆå‘˜æ•°</th>
                                    <th>å¹³å‡åˆ†</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(groups).map(([name, members]) => {
                                    const validMembers = members.filter(id => appData.scores[id] && id !== '0');
                                    const avgScore = validMembers.length > 0 
                                        ? (validMembers.reduce((sum, id) => sum + appData.scores[id][1], 0) / validMembers.length).toFixed(1)
                                        : 0;
                                    return `
                                        <tr>
                                            <td>${name}</td>
                                            <td>${validMembers.length}</td>
                                            <td>${avgScore}</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="viewGroupDetails('${name}')">æŸ¥çœ‹</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function viewGroupDetails(groupName) {
            const members = appData.groups[groupName] || [];
            const validMembers = members.filter(id => appData.scores[id] && id !== '0');
            
            showModal(`åˆ†ç»„è¯¦æƒ… - ${groupName}`, `
                <div style="max-height: 400px; overflow-y: auto;">
                    <p><strong>æˆå‘˜åˆ—è¡¨ (${validMembers.length}äºº):</strong></p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>å­¦å·</th>
                                <th>å§“å</th>
                                <th>åˆ†æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${validMembers.map(id => `
                                <tr>
                                    <td>${id}</td>
                                    <td>${appData.scores[id][0]}</td>
                                    <td>${appData.scores[id][1]}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showGroupCreate() {
            showModal('åˆ›å»ºåˆ†ç»„', `
                <div style="margin: 20px 0;">
                    <label>åˆ†ç»„åç§°ï¼š</label>
                    <input type="text" id="groupName" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'åˆ›å»º', onclick: 'handleGroupCreate()', className: 'btn-primary' }
            ]);
        }

        function handleGroupCreate() {
            const name = document.getElementById('groupName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                return;
            }
            
            if (!appData.groups) appData.groups = {};
            if (appData.groups[name]) {
                alert('åˆ†ç»„å·²å­˜åœ¨');
                return;
            }
            
            appData.groups[name] = [];
            saveData('groups');
            alert('åˆ›å»ºæˆåŠŸ');
            closeModal();
            showGroupManagement();
        }

        function showGroupDelete() {
            const groups = Object.keys(appData.groups || {});
            if (groups.length === 0) {
                alert('æš‚æ— åˆ†ç»„');
                return;
            }
            
            showModal('åˆ é™¤åˆ†ç»„', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©è¦åˆ é™¤çš„åˆ†ç»„ï¼š</label>
                    <select id="deleteGroupSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${groups.map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'åˆ é™¤', onclick: 'handleGroupDelete()', className: 'btn-danger' }
            ]);
        }

        function handleGroupDelete() {
            const name = document.getElementById('deleteGroupSelect').value;
            if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„"${name}"å—ï¼Ÿ`)) {
                delete appData.groups[name];
                saveData('groups');
                alert('åˆ†ç»„å·²åˆ é™¤');
                closeModal();
                showGroupManagement();
            }
        }

        function showGroupAddMember() {
            const groupNames = Object.keys(appData.groups || {});
            
            if (groupNames.length === 0) {
                alert('è¯·å…ˆåˆ›å»ºåˆ†ç»„');
                return;
            }
            
            showModal('æ·»åŠ æˆå‘˜', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©åˆ†ç»„ï¼š</label>
                    <select id="addGroupSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" onchange="updateAddMemberList(this.value)">
                        ${groupNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                    
                    <div id="addMembersList" style="margin-top: 20px;"></div>
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'æ·»åŠ ', onclick: 'handleGroupAddMember()', className: 'btn-primary' }
            ]);
            
            setTimeout(() => updateAddMemberList(groupNames[0]), 100);
        }

        function updateAddMemberList(groupName) {
            const members = appData.groups[groupName] || [];
            
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id, [name, score]]) => {
                    const inGroup = members.includes(id);
                    return `
                        <label style="display: block; margin: 5px; ${inGroup ? 'opacity: 0.5;' : ''}">
                            <input type="checkbox" value="${id}" class="add-member" ${inGroup ? 'disabled' : ''}> 
                            ${id} - ${name} (${score}åˆ†) ${inGroup ? '(å·²åœ¨åˆ†ç»„ä¸­)' : ''}
                        </label>
                    `;
                }).join('');
            
            document.getElementById('addMembersList').innerHTML = `
                <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px;">
                    ${students || '<p>æš‚æ— å­¦ç”Ÿå¯é€‰</p>'}
                </div>
            `;
        }

        function handleGroupAddMember() {
            const groupName = document.getElementById('addGroupSelect').value;
            const checkboxes = document.querySelectorAll('.add-member:checked');
            
            if (checkboxes.length === 0) {
                alert('è¯·é€‰æ‹©å­¦ç”Ÿ');
                return;
            }
            
            if (!appData.groups[groupName]) appData.groups[groupName] = [];
            
            checkboxes.forEach(cb => {
                const studentId = cb.value;
                if (!appData.groups[groupName].includes(studentId)) {
                    appData.groups[groupName].push(studentId);
                }
            });
            
            saveData('groups');
            alert(`æˆåŠŸæ·»åŠ  ${checkboxes.length} åå­¦ç”Ÿ`);
            closeModal();
            showGroupManagement();
        }

        function showGroupRemoveMember() {
            const groupNames = Object.keys(appData.groups || {});
            
            if (groupNames.length === 0) {
                alert('æš‚æ— åˆ†ç»„');
                return;
            }
            
            showModal('ç§»é™¤æˆå‘˜', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©åˆ†ç»„ï¼š</label>
                    <select id="removeGroupSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" onchange="showGroupMembers(this.value)">
                        ${groupNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                    
                    <div id="removeMembersList" style="margin-top: 20px;"></div>
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç§»é™¤', onclick: 'handleGroupRemoveMember()', className: 'btn-danger' }
            ]);
            
            setTimeout(() => showGroupMembers(groupNames[0]), 100);
        }

        function showGroupMembers(groupName) {
            const members = appData.groups[groupName] || [];
            const validMembers = members.filter(id => appData.scores[id] && id !== '0');
            
            document.getElementById('removeMembersList').innerHTML = `
                <label>é€‰æ‹©æˆå‘˜ï¼š</label>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px;">
                    ${validMembers.map(id => {
                        const [name, score] = appData.scores[id] || ['æœªçŸ¥', 0];
                        return `
                            <label style="display: block; margin: 5px;">
                                <input type="checkbox" value="${id}" class="remove-member"> ${id} - ${name} (${score}åˆ†)
                            </label>
                        `;
                    }).join('')}
                    ${validMembers.length === 0 ? '<p style="color: #718096;">è¯¥åˆ†ç»„æš‚æ— æˆå‘˜</p>' : ''}
                </div>
            `;
        }

        function handleGroupRemoveMember() {
            const groupName = document.getElementById('removeGroupSelect').value;
            const checkboxes = document.querySelectorAll('.remove-member:checked');
            
            if (checkboxes.length === 0) {
                alert('è¯·é€‰æ‹©è¦ç§»é™¤çš„å­¦ç”Ÿ');
                return;
            }
            
            checkboxes.forEach(cb => {
                const studentId = cb.value;
                const index = appData.groups[groupName].indexOf(studentId);
                if (index > -1) {
                    appData.groups[groupName].splice(index, 1);
                }
            });
            
            saveData('groups');
            alert(`æˆåŠŸç§»é™¤ ${checkboxes.length} åå­¦ç”Ÿ`);
            closeModal();
            showGroupManagement();
        }

        function showGroupList() {
            const groups = appData.groups || {};
            
            showModal('åˆ†ç»„åˆ—è¡¨', `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${Object.entries(groups).map(([name, members]) => {
                        const validMembers = members.filter(id => appData.scores[id] && id !== '0');
                        const names = validMembers.map(id => appData.scores[id][0]).join(', ');
                        return `
                            <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 10px;">
                                <h4 style="margin-bottom: 10px;">ğŸ”¹ ${name} (${validMembers.length}äºº)</h4>
                                <p style="color: #718096;">${names || 'æš‚æ— æˆå‘˜'}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showGroupAll() {
            const allStudents = new Set();
            Object.values(appData.groups || {}).forEach(members => {
                members.forEach(id => allStudents.add(id));
            });
            
            const ungrouped = Object.keys(appData.scores || {})
                .filter(id => id !== '0' && !allStudents.has(id));
            
            showModal('å…¨éƒ¨åˆ†ç»„è¯¦æƒ…', `
                <div style="max-height: 400px; overflow-y: auto;">
                    <h4>ğŸ“ å·²åˆ†ç»„å­¦ç”Ÿ</h4>
                    ${Object.entries(appData.groups || {}).map(([name, members]) => {
                        const validMembers = members.filter(id => appData.scores[id] && id !== '0');
                        if (validMembers.length === 0) return '';
                        
                        const names = validMembers.map(id => `${appData.scores[id][0]}(${id})`).join(' ');
                        return `
                            <div style="margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 8px;">
                                <strong>${name}:</strong> ${names}
                            </div>
                        `;
                    }).join('')}
                    
                    <h4 style="margin-top: 20px;">ğŸ“‹ æœªåˆ†ç»„å­¦ç”Ÿ</h4>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                        ${ungrouped.length > 0 
                            ? ungrouped.map(id => `${appData.scores[id][0]}(${id})`).join(' ')
                            : 'æ‰€æœ‰å­¦ç”Ÿéƒ½å·²åˆ†ç»„'}
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <p>æ€»è®¡: ${Object.keys(appData.scores || {}).filter(id => id !== '0').length}äºº</p>
                        <p>å·²åˆ†ç»„: ${allStudents.size}äºº</p>
                        <p>æœªåˆ†ç»„: ${ungrouped.length}äºº</p>
                    </div>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showGroupScore() {
            const groupNames = Object.keys(appData.groups || {});
            
            if (groupNames.length === 0) {
                alert('æš‚æ— åˆ†ç»„');
                return;
            }
            
            showModal('åˆ†ç»„åŠ åˆ†', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©åˆ†ç»„ï¼š</label>
                    <select id="scoreGroupSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${groupNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                    
                    <label>åŠ åˆ†/æ‰£åˆ†æ•°å€¼ï¼š</label>
                    <input type="number" id="groupScoreChange" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                    
                    <label>åŸå› ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <input type="text" id="groupScoreReason" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤', onclick: 'handleGroupScore()', className: 'btn-primary' }
            ]);
        }

        // ==================== æ’åç®¡ç† ====================
        function showRanking() {
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ† æ’åç®¡ç†</h2>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="showIndividualRanking()">ğŸ‘¤ ä¸ªäººæ’å</button>
                        <button class="btn btn-primary" onclick="showGroupRanking()">ğŸ‘¥ åˆ†ç»„æ’å</button>
                        <button class="btn btn-primary" onclick="showGroupMemberRanking()">ğŸ” ç»„å†…æ’å</button>
                        <button class="btn btn-primary" onclick="showScoreDistribution()">ğŸ“Š åˆ†æ•°åˆ†å¸ƒ</button>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3>ğŸ“Š ä¸ªäººæ’å TOP 10</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>å§“å</th>
                                    <th>å­¦å·</th>
                                    <th>åˆ†æ•°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getTopRanking(10).map((rank, index) => `
                                    <tr ${rank.id === currentUser.student_id ? 'style="background: #fef3c7;"' : ''}>
                                        <td>${index + 1}</td>
                                        <td>${rank.name}</td>
                                        <td>${rank.id}</td>
                                        <td><strong>${rank.score}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function getTopRanking(limit = 999) {
            return Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id, [name, score]]) => ({ id, name, score }))
                .sort((a, b) => b.score - a.score)
                .slice(0, limit);
        }

        function showIndividualRanking() {
            const rankings = getTopRanking();
            
            showModal('ä¸ªäººæ’å', `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>å§“å</th>
                                <th>å­¦å·</th>
                                <th>åˆ†æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankings.map((rank, index) => `
                                <tr ${rank.id === currentUser.student_id ? 'style="background: #fef3c7;"' : ''}>
                                    <td>${index + 1}</td>
                                    <td>${rank.name}</td>
                                    <td>${rank.id}</td>
                                    <td><strong>${rank.score}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showGroupRanking() {
            const groupScores = [];
            
            Object.entries(appData.groups || {}).forEach(([name, members]) => {
                const validMembers = members.filter(id => appData.scores[id] && id !== '0');
                if (validMembers.length > 0) {
                    const totalScore = validMembers.reduce((sum, id) => sum + appData.scores[id][1], 0);
                    const avgScore = totalScore / validMembers.length;
                    groupScores.push({ name, avgScore, count: validMembers.length, totalScore });
                }
            });
            
            groupScores.sort((a, b) => b.avgScore - a.avgScore);
            
            showModal('åˆ†ç»„æ’å', `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>åˆ†ç»„</th>
                                <th>å¹³å‡åˆ†</th>
                                <th>æˆå‘˜æ•°</th>
                                <th>æ€»åˆ†</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${groupScores.map((group, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td><strong>${group.name}</strong></td>
                                    <td>${group.avgScore.toFixed(2)}</td>
                                    <td>${group.count}</td>
                                    <td>${group.totalScore}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showGroupMemberRanking() {
            const groupNames = Object.keys(appData.groups || {});
            
            if (groupNames.length === 0) {
                alert('æš‚æ— åˆ†ç»„');
                return;
            }
            
            showModal('ç»„å†…æ’å', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©åˆ†ç»„ï¼š</label>
                    <select id="rankingGroupSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" onchange="showGroupRankingDetail(this.value)">
                        ${groupNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                    
                    <div id="groupRankingDetail" style="margin-top: 20px;"></div>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
            
            setTimeout(() => showGroupRankingDetail(groupNames[0]), 100);
        }

        function showGroupRankingDetail(groupName) {
            const members = appData.groups[groupName] || [];
            const validMembers = members
                .filter(id => appData.scores[id] && id !== '0')
                .map(id => ({
                    id,
                    name: appData.scores[id][0],
                    score: appData.scores[id][1]
                }))
                .sort((a, b) => b.score - a.score);
            
            document.getElementById('groupRankingDetail').innerHTML = `
                <h4>åˆ†ç»„ "${groupName}" æˆå‘˜æ’å</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ç»„å†…æ’å</th>
                            <th>å§“å</th>
                            <th>å­¦å·</th>
                            <th>åˆ†æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${validMembers.map((member, index) => `
                            <tr ${member.id === currentUser.student_id ? 'style="background: #fef3c7;"' : ''}>
                                <td>${index + 1}</td>
                                <td>${member.name}</td>
                                <td>${member.id}</td>
                                <td>${member.score}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showScoreDistribution() {
            const scores = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([, [, score]]) => score);
            
            const ranges = [
                { min: 0, max: 60, label: '0-60åˆ†' },
                { min: 60, max: 80, label: '60-80åˆ†' },
                { min: 80, max: 100, label: '80-100åˆ†' },
                { min: 100, max: 120, label: '100-120åˆ†' },
                { min: 120, max: 140, label: '120-140åˆ†' },
                { min: 140, max: 160, label: '140-160åˆ†' },
                { min: 160, max: 180, label: '160-180åˆ†' },
                { min: 180, max: 200, label: '180-200åˆ†' },
                { min: 200, max: Infinity, label: '200åˆ†ä»¥ä¸Š' }
            ];
            
            const distribution = ranges.map(range => ({
                ...range,
                count: scores.filter(s => s >= range.min && s < range.max).length
            }));
            
            const maxCount = Math.max(...distribution.map(d => d.count));
            
            showModal('åˆ†æ•°åˆ†å¸ƒç»Ÿè®¡', `
                <div style="padding: 10px;">
                    <p><strong>ğŸ“Š åˆ†æ•°åˆ†å¸ƒç»Ÿè®¡ï¼ˆå…±${scores.length}äººï¼‰</strong></p>
                    ${distribution.map(d => `
                        <div style="margin: 10px 0;">
                            <div style="display: flex; align-items: center;">
                                <span style="width: 80px;">${d.label}</span>
                                <span style="width: 40px;">${d.count}äºº</span>
                                <div style="flex: 1; height: 20px; background: #edf2f7; border-radius: 10px; margin-left: 10px;">
                                    <div style="height: 100%; width: ${(d.count / maxCount) * 100}%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 10px;"></div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    
                    <p style="margin-top: 20px; color: #718096;">ğŸ“ˆ å¹³å‡åˆ†: ${(scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2)}åˆ†</p>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        // ==================== æ¯æ—¥æ±‡æŠ¥ ====================
        function showDailyReport() {
            if (!hasPermission('æ¯æ—¥æ±‡æŠ¥')) {
                alert('æƒé™ä¸è¶³');
                return;
            }
            
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            const today = getBeijingDate();
            const reportedToday = appData.dailyReport[today] || [];
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ“‹ æ¯æ—¥æ±‡æŠ¥</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${reportedToday.length}</div>
                            <div class="stat-label">ä»Šæ—¥å·²æ±‡æŠ¥</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${students.length}</div>
                            <div class="stat-label">æ€»å­¦ç”Ÿæ•°</div>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <strong>â° æ“ä½œè¯´æ˜ï¼š</strong> ç‚¹å‡»æ±‡æŠ¥çŠ¶æ€åˆ‡æ¢ï¼Œç‚¹å‡»æŒ‰é’®å¿«é€ŸåŠ å‡åˆ†
                    </div>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="selectAllReport()">âœ… å…¨é€‰ä»Šæ—¥æ±‡æŠ¥</button>
                        <button class="btn btn-primary" onclick="clearAllReport()">ğŸ”„ æ¸…ç©ºä»Šæ—¥æ±‡æŠ¥</button>
                        <button class="btn btn-primary" onclick="showReportHistory()">ğŸ“Š å†å²è®°å½•</button>
                    </div>
                    
                    <div style="margin-top: 30px; overflow-x: auto;">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>å­¦å·</th>
                                    <th>å§“å</th>
                                    <th>å½“å‰åˆ†æ•°</th>
                                    <th>ä»Šæ—¥æ±‡æŠ¥</th>
                                    <th colspan="3">å¿«é€Ÿæ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map(([id, [name, score]]) => {
                                    const isReported = reportedToday.includes(id);
                                    return `
                                        <tr data-id="${id}">
                                            <td>${id}</td>
                                            <td>${name}</td>
                                            <td class="current-score">${score}</td>
                                            <td>
                                                <span class="report-status ${isReported ? 'status-reported' : 'status-unreported'}" 
                                                      onclick="toggleReport('${id}')">
                                                    ${isReported ? 'âœ“ å·²æ±‡æŠ¥' : 'â­• æœªæ±‡æŠ¥'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="action-btn btn-minus" onclick="quickAdjust('${id}', -2)">-2</button>
                                            </td>
                                            <td>
                                                <input type="number" class="score-input" id="input-${id}" value="-2" 
                                                       onchange="customAdjust('${id}', this.value)">
                                            </td>
                                            <td>
                                                <button class="action-btn btn-plus" onclick="quickAdjust('${id}', 2)">+2</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showReportHistory() {
            const dates = Object.keys(appData.dailyReport || {}).sort().reverse();
            
            showModal('æ±‡æŠ¥å†å²è®°å½•', `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${dates.map(date => `
                        <div style="margin: 15px 0; padding: 15px; background: #f7fafc; border-radius: 10px;">
                            <h4>ğŸ“… ${date}</h4>
                            <p>å·²æ±‡æŠ¥äººæ•°: ${appData.dailyReport[date]?.length || 0}äºº</p>
                            <button class="btn btn-sm" onclick="viewReportDetail('${date}')">æŸ¥çœ‹è¯¦æƒ…</button>
                        </div>
                    `).join('')}
                    ${dates.length === 0 ? '<p style="color: #718096;">æš‚æ— å†å²è®°å½•</p>' : ''}
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function viewReportDetail(date) {
            const reported = appData.dailyReport[date] || [];
            const students = reported.map(id => {
                const student = appData.scores[id];
                return student ? `${student[0]} (${id})` : id;
            }).join(', ');
            
            showModal(`æ±‡æŠ¥è¯¦æƒ… - ${date}`, `
                <div>
                    <p><strong>å·²æ±‡æŠ¥å­¦ç”Ÿ (${reported.length}äºº):</strong></p>
                    <p style="background: #f7fafc; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                        ${students || 'æš‚æ— è®°å½•'}
                    </p>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function toggleReport(studentId) {
            const today = getBeijingDate();
            if (!appData.dailyReport[today]) {
                appData.dailyReport[today] = [];
            }
            
            const index = appData.dailyReport[today].indexOf(studentId);
            if (index === -1) {
                appData.dailyReport[today].push(studentId);
            } else {
                appData.dailyReport[today].splice(index, 1);
            }
            
            saveData('dailyReport');
            showDailyReport();
        }

        function quickAdjust(studentId, change) {
            const newScore = getStudentScore(studentId) + change;
            appData.scores[studentId][1] = newScore;
            saveData('scores');
            addLog('æ¯æ—¥æ±‡æŠ¥è°ƒæ•´', studentId, change, newScore, `å¿«é€Ÿ${change > 0 ? '+' : ''}${change}`);
            showDailyReport();
        }

        function customAdjust(studentId, value) {
            const change = parseFloat(value);
            if (isNaN(change)) return;
            
            const newScore = getStudentScore(studentId) + change;
            appData.scores[studentId][1] = newScore;
            saveData('scores');
            addLog('æ¯æ—¥æ±‡æŠ¥è°ƒæ•´', studentId, change, newScore, `è‡ªå®šä¹‰${change > 0 ? '+' : ''}${change}`);
            showDailyReport();
        }

        function selectAllReport() {
            const today = getBeijingDate();
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id]) => id);
            
            appData.dailyReport[today] = students;
            saveData('dailyReport');
            showDailyReport();
        }

        function clearAllReport() {
            const today = getBeijingDate();
            appData.dailyReport[today] = [];
            saveData('dailyReport');
            showDailyReport();
        }

        // ==================== å­¦åˆ†æŠ½å¥– ====================
        function showGacha() {
            if (!hasPermission('å­¦åˆ†æŠ½å¥–')) {
                alert('æƒé™ä¸è¶³');
                return;
            }
            
            const studentId = currentUser.student_id;
            const gold = getStudentGold(studentId);
            const score = getStudentScore(studentId);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ° å­¦åˆ†æŠ½å¥–</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${gold}</div>
                            <div class="stat-label">æˆ‘çš„é‡‘å¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${score}</div>
                            <div class="stat-label">æˆ‘çš„å­¦åˆ†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">160</div>
                            <div class="stat-label">å•æŠ½ä»·æ ¼</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">1600</div>
                            <div class="stat-label">åè¿ä»·æ ¼</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        ${isFridayAfternoon() 
                            ? `<div style="background: #fef3c7; padding: 15px; border-radius: 10px; color: #d97706;">
                                ğŸ‰ ç°åœ¨æ˜¯å‘¨äº”ä¸‹åˆï¼Œå¯ä»¥æŠ½å¥–å•¦ï¼
                               </div>`
                            : `<div style="background: #e2e8f0; padding: 15px; border-radius: 10px;">
                                â° æŠ½å¥–åªåœ¨å‘¨äº”ä¸‹åˆ12:00åå¼€æ”¾
                               </div>`
                        }
                    </div>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" style="font-size: 1.2em; padding: 20px;" onclick="handleSingleGacha()" ${!isFridayAfternoon() ? 'disabled' : ''}>
                            ğŸ¯ å•æ¬¡æŠ½å¥– (160é‡‘å¸)
                        </button>
                        <button class="btn btn-primary" style="font-size: 1.2em; padding: 20px;" onclick="handleMultiGacha()" ${!isFridayAfternoon() ? 'disabled' : ''}>
                            ğŸŠ åè¿æŠ½å¥– (1600é‡‘å¸)
                        </button>
                    </div>
                    
                    <div class="btn-grid" style="margin-top: 10px;">
                        <button class="btn" onclick="showGachaHistory()">ğŸ“‹ æŠ½å¥–è®°å½•</button>
                        <button class="btn" onclick="showRewardPool()">ğŸ å¥–åŠ±é¢„è§ˆ</button>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3>ğŸ“‹ å¥–åŠ±é¢„è§ˆ</h3>
                        <div class="reward-grid">
                            ${Object.entries(appData.rewards || {}).map(([rarity, rewards]) => 
                                (rewards || []).slice(0, 2).map(reward => `
                                    <div class="reward-card reward-rarity-${rarity}">
                                        <div class="reward-name">${reward.name || ''}</div>
                                        <div class="reward-type">${reward.type || ''}</div>
                                        <div class="reward-desc">${reward.description || ''}</div>
                                        <div class="reward-prob">${reward.probability || 0}%</div>
                                    </div>
                                `).join('')
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function showGachaHistory() {
            const studentId = currentUser.student_id;
            const logs = (appData.logs || []).filter(log => 
                log.student_id === studentId && 
                (log.action === 'æŠ½å¥–æ¶ˆè€—' || log.action === 'åè¿æŠ½æ¶ˆè€—')
            );
            
            showModal('æŠ½å¥–è®°å½•', `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${logs.map(log => `
                        <div style="padding: 15px; margin: 10px 0; background: #f7fafc; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>ğŸ“… ${log.timestamp}</span>
                                <span style="color: #f56565;">${log.score_change}é‡‘å¸</span>
                            </div>
                            <div style="margin-top: 5px;">${log.action}: ${log.reason || ''}</div>
                        </div>
                    `).join('')}
                    ${logs.length === 0 ? '<p style="color: #718096;">æš‚æ— æŠ½å¥–è®°å½•</p>' : ''}
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showRewardPool() {
            showModal('å®Œæ•´å¥–åŠ±åˆ—è¡¨', `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${Object.entries(appData.rewards || {}).map(([rarity, rewards]) => `
                        <h4 style="margin-top: 15px;">${rarity} ç¨€æœ‰åº¦</h4>
                        ${rewards.map(reward => `
                            <div style="padding: 10px; margin: 5px 0; background: #f7fafc; border-radius: 8px;">
                                <strong>${reward.name}</strong> (${reward.probability}%)
                                <p style="color: #718096; margin-top: 5px;">${reward.description}</p>
                            </div>
                        `).join('')}
                    `).join('')}
                    
                    <h4 style="margin-top: 20px;">ğŸ éšè—å¥–åŠ±</h4>
                    ${(appData.rewards.hidden_rewards || []).map(reward => `
                        <div style="padding: 10px; margin: 5px 0; background: #fef3c7; border-radius: 8px;">
                            <strong>${reward.name}</strong> (${reward.probability}%)
                            <p style="color: #718096; margin-top: 5px;">${reward.description}</p>
                        </div>
                    `).join('') || '<p>æš‚æ— éšè—å¥–åŠ±</p>'}
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function handleSingleGacha() {
            const studentId = currentUser.student_id;
            const gold = getStudentGold(studentId);
            
            if (gold < 160) {
                alert('é‡‘å¸ä¸è¶³ï¼');
                return;
            }
            
            if (!confirm(`æ¶ˆè€—160é‡‘å¸è¿›è¡Œå•æ¬¡æŠ½å¥–ï¼Œç¡®å®šå—ï¼Ÿ`)) return;
            
            updateStudentGold(studentId, -160);
            
            const reward = drawReward();
            
            if (reward.name.includes('+')) {
                const scoreMatch = reward.name.match(/(\d+)/);
                if (scoreMatch) {
                    const score = parseInt(scoreMatch[0]);
                    updateStudentScore(studentId, score, `æŠ½å¥–è·å¾—: ${reward.name}`);
                }
            }
            
            addLog('æŠ½å¥–æ¶ˆè€—', studentId, -160, getStudentGold(studentId), `è·å¾—: ${reward.name}`);
            
            showModal('æŠ½å¥–ç»“æœ', `
                <div style="text-align: center; padding: 20px;">
                    <div class="reward-card reward-rarity-${reward.rarity}" style="margin: 0 auto; max-width: 300px;">
                        <div class="reward-name">${reward.name}</div>
                        <div class="reward-type">${reward.type}</div>
                        <div class="reward-desc">${reward.description}</div>
                    </div>
                    <p style="margin-top: 20px;">æ¶ˆè€—é‡‘å¸: 160</p>
                    <p>å‰©ä½™é‡‘å¸: ${getStudentGold(studentId)}</p>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal(); showGacha();' }
            ]);
        }

        function handleMultiGacha() {
            const studentId = currentUser.student_id;
            const gold = getStudentGold(studentId);
            
            if (gold < 1600) {
                alert('é‡‘å¸ä¸è¶³ï¼');
                return;
            }
            
            if (!confirm(`æ¶ˆè€—1600é‡‘å¸è¿›è¡Œåè¿æŠ½ï¼Œç¡®å®šå—ï¼Ÿ`)) return;
            
            updateStudentGold(studentId, -1600);
            
            const rewards = [];
            for (let i = 0; i < 10; i++) {
                rewards.push(drawReward());
            }
            
            const stats = {};
            rewards.forEach(r => {
                stats[r.rarity] = (stats[r.rarity] || 0) + 1;
                
                if (r.name.includes('+')) {
                    const scoreMatch = r.name.match(/(\d+)/);
                    if (scoreMatch) {
                        const score = parseInt(scoreMatch[0]);
                        updateStudentScore(studentId, score, `åè¿æŠ½è·å¾—: ${r.name}`);
                    }
                }
            });
            
            addLog('åè¿æŠ½æ¶ˆè€—', studentId, -1600, getStudentGold(studentId), `è·å¾—${rewards.length}ä¸ªå¥–åŠ±`);
            
            showModal('åè¿æŠ½ç»“æœ', `
                <div style="padding: 20px;">
                    <h4 style="margin-bottom: 15px;">ğŸ“Š ç¨€æœ‰åº¦ç»Ÿè®¡</h4>
                    ${Object.entries(stats).map(([rarity, count]) => `
                        <p>${rarity}: ${count}ä¸ª</p>
                    `).join('')}
                    
                    <h4 style="margin: 20px 0 15px;">ğŸ è¯¦ç»†å¥–åŠ±</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${rewards.map((r, i) => `
                            <div style="padding: 10px; margin: 5px 0; background: #f7fafc; border-left: 3px solid #667eea;">
                                ${i+1}. ${r.name} - ${r.description}
                            </div>
                        `).join('')}
                    </div>
                    
                    <p style="margin-top: 20px;">æ¶ˆè€—é‡‘å¸: 1600</p>
                    <p>å‰©ä½™é‡‘å¸: ${getStudentGold(studentId)}</p>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal(); showGacha();' }
            ]);
        }

        function drawReward() {
            const rewards = [];
            Object.entries(appData.rewards || {}).forEach(([rarity, list]) => {
                if (Array.isArray(list)) {
                    (list || []).forEach(reward => {
                        for (let i = 0; i < (reward.probability || 1); i++) {
                            rewards.push({ ...reward, rarity });
                        }
                    });
                }
            });
            
            // æ·»åŠ éšè—å¥–åŠ±
            const hiddenRewards = appData.rewards.hidden_rewards || [];
            hiddenRewards.forEach(reward => {
                for (let i = 0; i < (reward.probability || 1); i++) {
                    rewards.push({ ...reward, rarity: 'SP' });
                }
            });
            
            if (rewards.length === 0) return { name: 'è°¢è°¢å‚ä¸', type: 'è™šæ‹Ÿ', description: 'ä¸‹æ¬¡å¥½è¿ï¼', rarity: 'N' };
            return rewards[Math.floor(Math.random() * rewards.length)];
        }

        // ==================== æƒ©ç½šç®¡ç† ====================
        function showPunishment() {
            if (!hasPermission('æƒ©ç½šç®¡ç†')) {
                alert('æƒé™ä¸è¶³');
                return;
            }
            
            const studentId = currentUser.student_id;
            const score = getStudentScore(studentId);
            const activePuns = (appData.userPunishments?.active?.[studentId]) || [];
            const completedPuns = (appData.userPunishments?.completed?.[studentId]) || [];
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ¯ æƒ©ç½šç®¡ç†</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${score}</div>
                            <div class="stat-label">å½“å‰åˆ†æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${activePuns.length}</div>
                            <div class="stat-label">è¿›è¡Œä¸­</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${completedPuns.length}</div>
                            <div class="stat-label">å·²å®Œæˆ</div>
                        </div>
                    </div>
                    
                    ${score < 100 
                        ? `<div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            ğŸ¯ ä½ çš„åˆ†æ•°ä½äº100åˆ†ï¼Œå¯ä»¥æŠ½å–æƒ©ç½šï¼
                           </div>`
                        : `<div style="background: #e2e8f0; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            âš ï¸ åªæœ‰åˆ†æ•°ä½äº100åˆ†æ‰èƒ½æŠ½å–æƒ©ç½š
                           </div>`
                    }
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="handleDrawPunishment()" ${score >= 100 ? 'disabled' : ''}>
                            ğŸ² æŠ½å–æƒ©ç½š
                        </button>
                        <button class="btn btn-primary" onclick="showMyPunishments()">
                            ğŸ“‹ æˆ‘çš„æƒ©ç½š
                        </button>
                        <button class="btn btn-primary" onclick="showCompletePunishment()">
                            âœ… å®Œæˆæƒ©ç½š
                        </button>
                        <button class="btn btn-primary" onclick="showPunishmentPool()">
                            ğŸ“š æƒ©ç½šæ± 
                        </button>
                    </div>
                    
                    ${activePuns.length > 0 ? `
                        <h3 style="margin-top: 30px;">ğŸ“‹ è¿›è¡Œä¸­çš„æƒ©ç½š</h3>
                        ${activePuns.map(pun => {
                            const deadline = new Date(pun.deadline);
                            const now = new Date();
                            const timeLeft = deadline - now;
                            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            
                            return `
                                <div style="padding: 15px; margin: 10px 0; background: #f7fafc; border-radius: 10px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <strong>${pun.name || ''}</strong>
                                        <span class="reward-rarity-${pun.rarity}" style="padding: 2px 8px; border-radius: 12px;">${pun.rarity || ''}</span>
                                    </div>
                                    <p style="margin: 10px 0; color: #718096;">${pun.description || ''}</p>
                                    <p>â° å‰©ä½™æ—¶é—´: ${days > 0 ? days + 'å¤©' : ''} ${hours}å°æ—¶</p>
                                    <p>âœ… æˆåŠŸ: +${pun.success_gold || 0}é‡‘å¸ | âŒ å¤±è´¥: ${pun.fail_gold || 0}é‡‘å¸</p>
                                </div>
                            `;
                        }).join('')}
                    ` : ''}
                </div>
            `;
        }

        function showPunishmentPool() {
            const punishments = appData.punishments || {};
            
            showModal('æƒ©ç½šæ± ', `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${Object.entries(punishments).map(([rarity, list]) => `
                        <h4 style="margin-top: 15px;">${rarity} ç¨€æœ‰åº¦</h4>
                        ${list.map(pun => `
                            <div style="padding: 10px; margin: 5px 0; background: #f7fafc; border-radius: 8px;">
                                <strong>${pun.name}</strong> (æ¦‚ç‡: ${pun.probability}%)
                                <p style="color: #718096; margin-top: 5px;">${pun.description}</p>
                                <p>â° æ—¶é™: ${pun.time[0]} | ä»»åŠ¡æ—¶é•¿: ${pun.time[1]}</p>
                                <p>ğŸ’° æˆåŠŸ: +${pun.score[0] * 10}é‡‘å¸ | å¤±è´¥: ${pun.score[1] * 10}é‡‘å¸</p>
                            </div>
                        `).join('')}
                    `).join('')}
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function handleDrawPunishment() {
            const studentId = currentUser.student_id;
            const score = getStudentScore(studentId);
            
            if (score >= 100) {
                alert('åˆ†æ•°éœ€ä½äº100åˆ†æ‰èƒ½æŠ½å–æƒ©ç½š');
                return;
            }
            
            const pool = [];
            Object.entries(appData.punishments || {}).forEach(([rarity, list]) => {
                (list || []).forEach(pun => {
                    for (let i = 0; i < (pun.probability || 1); i++) {
                        pool.push({ ...pun, rarity });
                    }
                });
            });
            
            if (pool.length === 0) {
                alert('æš‚æ— å¯ç”¨æƒ©ç½š');
                return;
            }
            
            const punishment = pool[Math.floor(Math.random() * pool.length)];
            
            const deadline = new Date();
            if (punishment.time && punishment.time[0] && punishment.time[0].endsWith('d')) {
                const days = parseInt(punishment.time[0]);
                deadline.setDate(deadline.getDate() + days);
            } else {
                deadline.setHours(deadline.getHours() + 1);
            }
            
            const newPun = {
                id: Date.now().toString(),
                name: punishment.name || '',
                description: punishment.description || '',
                rarity: punishment.rarity || 'N',
                time_limit: punishment.time?.[0] || '',
                task_duration: punishment.time?.[1] || '',
                success_gold: (punishment.score?.[0] || 0) * 10,
                fail_gold: (punishment.score?.[1] || 0) * 10,
                deadline: deadline.toISOString(),
                draw_time: new Date().toISOString(),
                status: 'active'
            };
            
            if (!appData.userPunishments) appData.userPunishments = { active: {}, completed: {} };
            if (!appData.userPunishments.active[studentId]) {
                appData.userPunishments.active[studentId] = [];
            }
            appData.userPunishments.active[studentId].push(newPun);
            saveData('userPunishments');
            
            addLog('æŠ½å–æƒ©ç½š', studentId, 0, score, `æŠ½åˆ°: ${punishment.name}`);
            
            showModal('æŠ½å–ç»“æœ', `
                <div style="text-align: center;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">ğŸ¯ æŠ½åˆ°æƒ©ç½š!</h3>
                    
                    <div class="reward-card reward-rarity-${punishment.rarity}" style="padding: 20px; border-radius: 10px;">
                        <div style="font-size: 1.3em; margin-bottom: 10px;">${punishment.name || ''}</div>
                        <div>${punishment.description || ''}</div>
                    </div>
                    
                    <div style="margin: 20px 0; text-align: left;">
                        <p>â° å®Œæˆæ—¶é™: ${punishment.time?.[0] || ''}</p>
                        <p>â±ï¸ ä»»åŠ¡æ—¶é•¿: ${punishment.time?.[1] || ''}</p>
                        <p>ğŸ’° æˆåŠŸå¥–åŠ±: +${(punishment.score?.[0] || 0) * 10}é‡‘å¸</p>
                        <p>ğŸ’° å¤±è´¥æƒ©ç½š: ${(punishment.score?.[1] || 0) * 10}é‡‘å¸</p>
                    </div>
                    
                    <p>æƒ©ç½šå·²æ·»åŠ åˆ°æ‚¨çš„ä»»åŠ¡åˆ—è¡¨ï¼</p>
                </div>
            `, [
                { text: 'ç¡®å®š', onclick: 'closeModal(); showPunishment();' }
            ]);
        }

        function showMyPunishments() {
            const studentId = currentUser.student_id;
            const active = (appData.userPunishments?.active?.[studentId]) || [];
            const completed = (appData.userPunishments?.completed?.[studentId]) || [];
            
            showModal('æˆ‘çš„æƒ©ç½š', `
                <div style="max-height: 400px; overflow-y: auto;">
                    <h4>ğŸ“‹ è¿›è¡Œä¸­çš„æƒ©ç½š (${active.length})</h4>
                    ${active.map(pun => `
                        <div style="padding: 10px; margin: 10px 0; background: #f7fafc; border-radius: 8px;">
                            <strong>${pun.name || ''}</strong> <span class="reward-rarity-${pun.rarity}" style="padding: 2px 8px; border-radius: 12px;">${pun.rarity || ''}</span>
                            <p style="font-size: 0.9em; color: #718096;">${pun.description || ''}</p>
                            <p>æˆªæ­¢: ${new Date(pun.deadline).toLocaleString()}</p>
                        </div>
                    `).join('') || '<p style="color: #718096;">æš‚æ— è¿›è¡Œä¸­çš„æƒ©ç½š</p>'}
                    
                    <h4 style="margin-top: 20px;">âœ… å·²å®Œæˆçš„æƒ©ç½š (${completed.length})</h4>
                    ${completed.map(pun => `
                        <div style="padding: 10px; margin: 10px 0; background: #f0fdf4; border-radius: 8px;">
                            <strong>${pun.name || ''}</strong>
                            <p>å®Œæˆæ—¶é—´: ${pun.completion_time ? new Date(pun.completion_time).toLocaleString() : ''}</p>
                            <p>ç»“æœ: ${pun.result || ''} | è·å¾—: ${pun.final_gold || 0}é‡‘å¸</p>
                        </div>
                    `).join('') || '<p style="color: #718096;">æš‚æ— å®Œæˆçš„æƒ©ç½š</p>'}
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showCompletePunishment() {
            const studentId = currentUser.student_id;
            const active = (appData.userPunishments?.active?.[studentId]) || [];
            
            if (active.length === 0) {
                alert('æ²¡æœ‰è¿›è¡Œä¸­çš„æƒ©ç½š');
                return;
            }
            
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== studentId && id !== '0')
                .map(([id, [name]]) => `${id} - ${name}`);
            
            if (students.length === 0) {
                alert('æ²¡æœ‰å¯ç”¨çš„è§è¯äºº');
                return;
            }
            
            showModal('å®Œæˆæƒ©ç½š', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©æƒ©ç½šï¼š</label>
                    <select id="completePunSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${active.map(pun => `
                            <option value="${pun.id}">${pun.name || ''} (æˆªæ­¢: ${new Date(pun.deadline).toLocaleDateString()})</option>
                        `).join('')}
                    </select>
                    
                    <label>é€‰æ‹©è§è¯äººï¼š</label>
                    <select id="witnessSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${students.map(s => `<option value="${s.split(' - ')[0]}">${s}</option>`).join('')}
                    </select>
                    
                    <label>å®Œæˆç»“æœï¼š</label>
                    <div style="margin: 10px 0;">
                        <label><input type="radio" name="punResult" value="success" checked> æˆåŠŸå®Œæˆ</label>
                        <label style="margin-left: 20px;"><input type="radio" name="punResult" value="fail"> æœªèƒ½å®Œæˆ</label>
                    </div>
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤å®Œæˆ', onclick: 'handleCompletePunishment()', className: 'btn-primary' }
            ]);
        }

        function handleCompletePunishment() {
            const studentId = currentUser.student_id;
            const punId = document.getElementById('completePunSelect').value;
            const witnessId = document.getElementById('witnessSelect').value;
            const result = document.querySelector('input[name="punResult"]:checked').value;
            
            const active = appData.userPunishments.active[studentId] || [];
            const punIndex = active.findIndex(p => p.id === punId);
            
            if (punIndex === -1) return;
            
            const pun = active[punIndex];
            const finalGold = result === 'success' ? pun.success_gold : pun.fail_gold;
            
            updateStudentGold(studentId, finalGold);
            
            pun.status = 'completed';
            pun.completion_time = new Date().toISOString();
            pun.result = result === 'success' ? 'æˆåŠŸå®Œæˆ' : 'æœªèƒ½å®Œæˆ';
            pun.final_gold = finalGold;
            pun.witness = appData.scores[witnessId]?.[0] || 'æœªçŸ¥';
            pun.witness_id = witnessId;
            
            if (!appData.userPunishments.completed[studentId]) {
                appData.userPunishments.completed[studentId] = [];
            }
            appData.userPunishments.completed[studentId].push(pun);
            
            active.splice(punIndex, 1);
            appData.userPunishments.active[studentId] = active;
            
            saveData('userPunishments');
            addLog('å®Œæˆæƒ©ç½š', studentId, 0, getStudentScore(studentId), `æƒ©ç½š: ${pun.name}, ç»“æœ: ${result}, é‡‘å¸: ${finalGold}`);
            
            alert(`æƒ©ç½šå®Œæˆï¼è·å¾— ${finalGold} é‡‘å¸`);
            closeModal();
            showPunishment();
        }

        // ==================== é‡‘å¸ç³»ç»Ÿ ====================
        function showGoldSystem() {
            if (!hasPermission('é‡‘å¸ç³»ç»Ÿ')) {
                alert('æƒé™ä¸è¶³');
                return;
            }
            
            const studentId = currentUser.student_id;
            const score = getStudentScore(studentId);
            const gold = getStudentGold(studentId);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ’° é‡‘å¸ç³»ç»Ÿ</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${score}</div>
                            <div class="stat-label">å­¦åˆ†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${gold}</div>
                            <div class="stat-label">é‡‘å¸</div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); padding: 20px; border-radius: 10px; color: white; margin: 20px 0;">
                        <h3>ğŸ“ˆ ä»Šæ—¥æ±‡ç‡</h3>
                        <p style="font-size: 1.2em; margin: 10px 0;">å­¦åˆ† â†’ é‡‘å¸: 1 : ${appData.exchangeRate.score_to_gold?.toFixed(4) || '0.1000'}</p>
                        <p style="font-size: 1.2em; margin: 10px 0;">é‡‘å¸ â†’ å­¦åˆ†: 1 : ${appData.exchangeRate.gold_to_score?.toFixed(4) || '1.0000'}</p>
                        <p style="font-size: 0.9em;">æœ€åæ›´æ–°: ${appData.exchangeRate.last_updated || 'æœªçŸ¥'}</p>
                    </div>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="showScoreToGold()">ğŸ”„ å­¦åˆ†å…‘æ¢é‡‘å¸</button>
                        <button class="btn btn-primary" onclick="showGoldToScore()">ğŸ”„ é‡‘å¸å…‘æ¢å­¦åˆ†</button>
                        <button class="btn btn-primary" onclick="showGoldTasks()">ğŸ¯ é‡‘å¸ä»»åŠ¡</button>
                        <button class="btn btn-primary" onclick="showGoldHistory()">ğŸ“‹ é‡‘å¸å†å²</button>
                        <button class="btn btn-primary" onclick="showGoldRanking()">ğŸ† é‡‘å¸æ’å</button>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3>ğŸ“Š é‡‘å¸æ’è¡Œæ¦œ</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>å§“å</th>
                                    <th>é‡‘å¸</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getGoldRanking(10).map((item, index) => `
                                    <tr ${item.id === studentId ? 'style="background: #fef3c7;"' : ''}>
                                        <td>${index + 1}</td>
                                        <td>${item.name}</td>
                                        <td>${item.gold}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function getGoldRanking(limit = 999) {
            const rankings = [];
            Object.entries(appData.gold || {}).forEach(([id, data]) => {
                if (id !== '0' && appData.scores[id]) {
                    rankings.push({
                        id,
                        name: appData.scores[id][0],
                        gold: data.amount || 0
                    });
                }
            });
            return rankings.sort((a, b) => b.gold - a.gold).slice(0, limit);
        }

        function showGoldRanking() {
            const rankings = getGoldRanking();
            
            showModal('é‡‘å¸æ’è¡Œæ¦œ', `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>å§“å</th>
                                <th>é‡‘å¸</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankings.map((item, index) => `
                                <tr ${item.id === currentUser.student_id ? 'style="background: #fef3c7;"' : ''}>
                                    <td>${index + 1}</td>
                                    <td>${item.name}</td>
                                    <td>${item.gold}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showScoreToGold() {
            const studentId = currentUser.student_id;
            const score = getStudentScore(studentId);
            const rate = parseFloat(appData.exchangeRate.score_to_gold || 0.1);
            
            showModal('å­¦åˆ†å…‘æ¢é‡‘å¸', `
                <div style="margin: 20px 0;">
                    <p>å½“å‰å­¦åˆ†: ${score}</p>
                    <p>å½“å‰æ±‡ç‡: 1å­¦åˆ† = ${rate.toFixed(4)}é‡‘å¸</p>
                    
                    <label>å…‘æ¢å­¦åˆ†æ•°é‡ï¼š</label>
                    <input type="number" id="exchangeScore" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" value="10">
                    
                    <div id="exchangePreview" style="margin: 20px 0; padding: 15px; background: #f7fafc; border-radius: 8px;">
                        é¢„è®¡è·å¾—: <span id="goldPreview">0</span> é‡‘å¸
                    </div>
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤å…‘æ¢', onclick: 'handleScoreToGold()', className: 'btn-primary' }
            ]);
            
            document.getElementById('exchangeScore').oninput = function() {
                const score = parseFloat(this.value) || 0;
                const gold = score * rate;
                document.getElementById('goldPreview').textContent = gold.toFixed(2);
            };
            
            document.getElementById('exchangeScore').oninput();
        }

        function handleScoreToGold() {
            const studentId = currentUser.student_id;
            const score = parseFloat(document.getElementById('exchangeScore').value);
            const rate = parseFloat(appData.exchangeRate.score_to_gold || 0.1);
            
            if (isNaN(score) || score <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }
            
            const currentScore = getStudentScore(studentId);
            if (score > currentScore) {
                alert('å­¦åˆ†ä¸è¶³');
                return;
            }
            
            const gold = score * rate;
            
            updateStudentScore(studentId, -score, `å…‘æ¢é‡‘å¸ ${gold.toFixed(2)}`);
            updateStudentGold(studentId, gold);
            
            // æ›´æ–°æ±‡ç‡ï¼ˆéšæœºæ³¢åŠ¨ï¼‰
            updateExchangeRate();
            
            alert(`å…‘æ¢æˆåŠŸï¼è·å¾— ${gold.toFixed(2)} é‡‘å¸`);
            closeModal();
            showGoldSystem();
        }

        function showGoldToScore() {
            const studentId = currentUser.student_id;
            const gold = getStudentGold(studentId);
            const rate = parseFloat(appData.exchangeRate.gold_to_score || 1.0);
            
            showModal('é‡‘å¸å…‘æ¢å­¦åˆ†', `
                <div style="margin: 20px 0;">
                    <p>å½“å‰é‡‘å¸: ${gold}</p>
                    <p>å½“å‰æ±‡ç‡: 1é‡‘å¸ = ${rate.toFixed(4)}å­¦åˆ†</p>
                    
                    <label>å…‘æ¢é‡‘å¸æ•°é‡ï¼š</label>
                    <input type="number" id="exchangeGold" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" value="10">
                    
                    <div id="exchangePreview2" style="margin: 20px 0; padding: 15px; background: #f7fafc; border-radius: 8px;">
                        é¢„è®¡è·å¾—: <span id="scorePreview">0</span> å­¦åˆ†
                    </div>
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤å…‘æ¢', onclick: 'handleGoldToScore()', className: 'btn-primary' }
            ]);
            
            document.getElementById('exchangeGold').oninput = function() {
                const gold = parseFloat(this.value) || 0;
                const score = gold * rate;
                document.getElementById('scorePreview').textContent = score.toFixed(2);
            };
            
            document.getElementById('exchangeGold').oninput();
        }

        function handleGoldToScore() {
            const studentId = currentUser.student_id;
            const gold = parseFloat(document.getElementById('exchangeGold').value);
            const rate = parseFloat(appData.exchangeRate.gold_to_score || 1.0);
            
            if (isNaN(gold) || gold <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }
            
            const currentGold = getStudentGold(studentId);
            if (gold > currentGold) {
                alert('é‡‘å¸ä¸è¶³');
                return;
            }
            
            const score = gold * rate;
            
            updateStudentGold(studentId, -gold);
            updateStudentScore(studentId, score, `ç”¨ ${gold} é‡‘å¸å…‘æ¢`);
            
            // æ›´æ–°æ±‡ç‡ï¼ˆéšæœºæ³¢åŠ¨ï¼‰
            updateExchangeRate();
            
            alert(`å…‘æ¢æˆåŠŸï¼è·å¾— ${score.toFixed(2)} å­¦åˆ†`);
            closeModal();
            showGoldSystem();
        }

        function updateExchangeRate() {
            const rate = appData.exchangeRate;
            // éšæœºæ³¢åŠ¨ Â±5%
            rate.score_to_gold = rate.score_to_gold * (0.95 + Math.random() * 0.1);
            rate.gold_to_score = rate.gold_to_score * (0.95 + Math.random() * 0.1);
            rate.last_updated = formatDate();
            saveData('exchangeRate');
        }

        function showGoldTasks() {
            showModal('é‡‘å¸ä»»åŠ¡', `
                <div style="padding: 20px;">
                    <h4>ğŸ“š æ¯æ—¥å­¦ä¹ ä»»åŠ¡</h4>
                    <p>â€¢ å®Œæˆä½œä¸š: +5é‡‘å¸</p>
                    <p>â€¢ è¯¾å ‚è¡¨ç°ä¼˜ç§€: +3é‡‘å¸</p>
                    <p>â€¢ å¸®åŠ©åŒå­¦: +2é‡‘å¸</p>
                    
                    <h4 style="margin-top: 20px;">ğŸ† æˆç»©è¿›æ­¥ä»»åŠ¡</h4>
                    <p>â€¢ è€ƒè¯•æˆç»©è¿›æ­¥10åˆ†: +10é‡‘å¸</p>
                    <p>â€¢ å•ç§‘æˆç»©ç­çº§å‰3: +15é‡‘å¸</p>
                    <p>â€¢ å…¨ç§‘åŠæ ¼: +8é‡‘å¸</p>
                    
                    <h4 style="margin-top: 20px;">ğŸ’¡ åˆ›æ–°è´¡çŒ®ä»»åŠ¡</h4>
                    <p>â€¢ æå‡ºæ”¹è¿›å»ºè®®: +5é‡‘å¸</p>
                    <p>â€¢ å‚ä¸ç­çº§æ´»åŠ¨: +3é‡‘å¸</p>
                    <p>â€¢ å®Œæˆç‰¹æ®Šé¡¹ç›®: +20é‡‘å¸</p>
                    
                    <p style="margin-top: 20px; color: #718096;">ğŸ”” è¯·è”ç³»è€å¸ˆç¡®è®¤ä»»åŠ¡å®Œæˆæƒ…å†µå¹¶é¢†å–é‡‘å¸ï¼</p>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showGoldHistory() {
            const studentId = currentUser.student_id;
            const goldData = appData.gold[studentId] || { amount: 0, last_updated: formatDate() };
            
            showModal('é‡‘å¸å†å²', `
                <div style="padding: 20px;">
                    <p><strong>å½“å‰é‡‘å¸:</strong> ${goldData.amount.toFixed(2)}</p>
                    <p><strong>æœ€åæ›´æ–°:</strong> ${goldData.last_updated ? new Date(goldData.last_updated).toLocaleString() : ''}</p>
                    
                    <div style="margin-top: 20px;">
                        <p><strong>ğŸ“ˆ æ±‡ç‡ä¿¡æ¯</strong></p>
                        <p>å­¦åˆ† â†’ é‡‘å¸: 1 : ${appData.exchangeRate.score_to_gold?.toFixed(4) || '0.1000'}</p>
                        <p>é‡‘å¸ â†’ å­¦åˆ†: 1 : ${appData.exchangeRate.gold_to_score?.toFixed(4) || '1.0000'}</p>
                        <p>æœ€åæ›´æ–°: ${appData.exchangeRate.last_updated || 'æœªçŸ¥'}</p>
                    </div>
                    
                    <p style="margin-top: 20px; color: #718096;">ğŸ’¡ æ±‡ç‡ä¼šæ¯æ—¥æ³¢åŠ¨ï¼Œè¯·æŠŠæ¡å…‘æ¢æ—¶æœºï¼</p>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        // ==================== æ“ä½œæ—¥å¿— ====================
        function showLogs() {
            if (!hasPermission('æ“ä½œæ—¥å¿—')) {
                alert('æƒé™ä¸è¶³');
                return;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <input type="text" placeholder="æœç´¢æ—¥å¿—..." style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;" 
                               onkeyup="filterLogs(this.value)">
                    </div>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="exportLogs()">ğŸ“¤ å¯¼å‡ºæ—¥å¿—</button>
                        <button class="btn btn-primary" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    
                    <div id="logsList" style="max-height: 500px; overflow-y: auto;">
                        ${(appData.logs || []).map(log => `
                            <div class="log-item" data-content="${log.student_name || ''} ${log.action || ''} ${log.reason || ''}" style="padding: 15px; margin: 10px 0; background: #f7fafc; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>ğŸ“… ${log.timestamp || ''}</span>
                                    <span style="color: ${log.score_change > 0 ? '#48bb78' : '#f56565'}">
                                        ${log.score_change > 0 ? '+' : ''}${log.score_change}
                                    </span>
                                </div>
                                <div style="margin-top: 5px;">
                                    <strong>${log.student_name || 'æœªçŸ¥'}</strong> ${log.action || ''}
                                    ${log.reason ? `- ${log.reason}` : ''}
                                </div>
                                <div style="margin-top: 5px; color: #718096;">
                                    ï½œ å½“å‰åˆ†æ•°: ${log.current_score || 0}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function exportLogs() {
            const logs = appData.logs || [];
            const dataStr = JSON.stringify(logs, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs_${formatDate().replace(/[: ]/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearLogs() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ“ä½œæ—¥å¿—å—ï¼Ÿ')) {
                appData.logs = [];
                saveData('logs');
                showLogs();
            }
        }

        function filterLogs(keyword) {
            const logs = document.querySelectorAll('.log-item');
            logs.forEach(log => {
                const content = log.getAttribute('data-content') || '';
                log.style.display = content.includes(keyword) ? '' : 'none';
            });
        }

        // ==================== äº‘ç«¯åŒæ­¥ï¼ˆä¿®å¤ç‰ˆï¼‰ ====================
        function showCloudSync() {
            if (!hasPermission('äº‘ç«¯åŒæ­¥')) {
                alert('æƒé™ä¸è¶³');
                return;
            }
            
            const lastSync = appData.cloudMeta?.lastSync ? new Date(appData.cloudMeta.lastSync).toLocaleString() : 'ä»æœªåŒæ­¥';
            const isConfigured = CLOUD_CONFIG.binId && CLOUD_CONFIG.masterKey;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">â˜ï¸ äº‘ç«¯åŒæ­¥</h2>
                    
                    <div class="info-box">
                        <strong>ğŸ“Œ äº‘ç«¯çŠ¶æ€ï¼š</strong><br>
                        â€¢ æœ€ååŒæ­¥æ—¶é—´ï¼š${lastSync}<br>
                        â€¢ æœ¬åœ°æ•°æ®ç‰ˆæœ¬ï¼š${appData.cloudMeta?.updated || 0}<br>
                        â€¢ åŒæ­¥æ¨¡å¼ï¼šJSONBin<br>
                        â€¢ é…ç½®çŠ¶æ€ï¼š${isConfigured ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}<br>
                        â€¢ Bin ID: ${CLOUD_CONFIG.binId}
                    </div>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="showCloudUpload()" ${!isConfigured ? 'disabled' : ''}>
                            ğŸ“¤ ä¸Šä¼ åˆ°äº‘ç«¯
                        </button>
                        <button class="btn btn-primary" onclick="showCloudDownload()" ${!isConfigured ? 'disabled' : ''}>
                            ğŸ“¥ ä»äº‘ç«¯ä¸‹è½½
                        </button>
                        <button class="btn btn-primary" onclick="testCloudConnection()" ${!isConfigured ? 'disabled' : ''}>
                            ğŸ“¡ æµ‹è¯•è¿æ¥
                        </button>
                        <button class="btn btn-primary" onclick="showCloudConfig()">
                            âš™ï¸ é‡æ–°é…ç½®
                        </button>
                    </div>
                    
                    <div class="warning-box">
                        <strong>âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>ä¸Šä¼ ä¼šè¦†ç›–äº‘ç«¯æ•°æ®</li>
                            <li>ä¸‹è½½ä¼šè¦†ç›–æœ¬åœ°æ•°æ®</li>
                            <li>å»ºè®®å®šæœŸå¤‡ä»½é‡è¦æ•°æ®</li>
                        </ul>
                    </div>
                    
                    <div id="cloudStatus" style="margin-top: 20px;"></div>
                </div>
            `;
        }

        function showCloudConfig() {
            showModal('äº‘ç«¯é…ç½®', `
                <div style="margin: 20px 0;">
                    <p>å½“å‰é…ç½®çš„ Bin ID:</p>
                    <p style="background: #f7fafc; padding: 10px; border-radius: 8px; font-family: monospace;">${CLOUD_CONFIG.binId}</p>
                    
                    <p>å¦‚éœ€ä¿®æ”¹é…ç½®ï¼Œè¯·ç›´æ¥ä¿®æ”¹ä»£ç ä¸­çš„ CLOUD_CONFIG å˜é‡ã€‚</p>
                    
                    <div class="info-box">
                        <strong>å¦‚ä½•è·å– Bin ID?</strong><br>
                        1. è®¿é—® https://jsonbin.io/<br>
                        2. æ³¨å†Œ/ç™»å½•è´¦å·<br>
                        3. åˆ›å»ºæ–°çš„ Bin<br>
                        4. å¤åˆ¶ Bin ID å’Œ Master Key
                    </div>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        function showCloudUpload() {
            showModal('ä¸Šä¼ åˆ°äº‘ç«¯', `
                <div style="margin: 20px 0;">
                    <p>å°†å½“å‰æ‰€æœ‰æœ¬åœ°æ•°æ®ä¸Šä¼ åˆ°äº‘ç«¯ï¼Œä¼šè¦†ç›–äº‘ç«¯ç°æœ‰æ•°æ®ã€‚</p>
                    
                    <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="stat-card">
                            <div class="stat-value">${Object.keys(appData.users).length}</div>
                            <div class="stat-label">ç”¨æˆ·æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Object.keys(appData.scores).length}</div>
                            <div class="stat-label">å­¦ç”Ÿæ•°</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label>
                            <input type="checkbox" id="confirmUpload"> æˆ‘ç¡®è®¤è¦ä¸Šä¼ æ•°æ®åˆ°äº‘ç«¯
                        </label>
                    </div>
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'å¼€å§‹ä¸Šä¼ ', onclick: 'handleCloudUpload()', className: 'btn-primary' }
            ]);
        }

        async function handleCloudUpload() {
            const confirm = document.getElementById('confirmUpload')?.checked;
            if (!confirm) {
                alert('è¯·å…ˆç¡®è®¤ä¸Šä¼ æ“ä½œ');
                return;
            }
            
            closeModal();
            
            const statusDiv = document.getElementById('cloudStatus');
            if (statusDiv) {
                statusDiv.innerHTML = '<div class="info-box">â³ æ­£åœ¨ä¸Šä¼ æ•°æ®åˆ°äº‘ç«¯...</div>';
            }
            
            try {
                // å‡†å¤‡ä¸Šä¼ æ•°æ®
                const uploadData = {
                    users: appData.users,
                    scores: appData.scores,
                    groups: appData.groups,
                    rules: appData.rules,
                    logs: appData.logs,
                    rewards: appData.rewards,
                    punishments: appData.punishments,
                    userPunishments: appData.userPunishments,
                    gold: appData.gold,
                    exchangeRate: appData.exchangeRate,
                    emoji: appData.emoji,
                    dailyReport: appData.dailyReport,
                    cloudMeta: {
                        updated: (appData.cloudMeta?.updated || 0) + 1,
                        lastSync: new Date().toISOString(),
                        version: '1.0'
                    },
                    timestamp: new Date().toISOString()
                };
                
                // ä¸Šä¼ åˆ°äº‘ç«¯
                const result = await uploadToCloud(uploadData);
                
                // æ›´æ–°æœ¬åœ°å…ƒæ•°æ®
                appData.cloudMeta = uploadData.cloudMeta;
                saveData('cloudMeta');
                
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="success-box">
                            âœ… ä¸Šä¼ æˆåŠŸï¼<br>
                            ç‰ˆæœ¬å·ï¼š${appData.cloudMeta.updated}<br>
                            æ—¶é—´ï¼š${new Date().toLocaleString()}
                        </div>
                    `;
                }
                
                alert('âœ… æ•°æ®ä¸Šä¼ æˆåŠŸï¼');
                
                // æ›´æ–°äº‘ç«¯çŠ¶æ€æ˜¾ç¤º
                const cloudStatus = document.getElementById('cloudStatus');
                const cloudIcon = document.getElementById('cloudIcon');
                const cloudText = document.getElementById('cloudText');
                if (cloudStatus) {
                    cloudIcon.textContent = 'â˜ï¸âœ…';
                    cloudText.textContent = 'äº‘ç«¯å·²åŒæ­¥';
                    cloudStatus.className = 'cloud-status online';
                }
                
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                if (statusDiv) {
                    statusDiv.innerHTML = `<div class="warning-box">âŒ ä¸Šä¼ å¤±è´¥ï¼š${error.message}</div>`;
                }
                alert('âŒ ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
            }
        }

        function showCloudDownload() {
            showModal('ä»äº‘ç«¯ä¸‹è½½', `
                <div style="margin: 20px 0;">
                    <p>ä»äº‘ç«¯ä¸‹è½½æœ€æ–°æ•°æ®ï¼Œä¼šè¦†ç›–å½“å‰æ‰€æœ‰æœ¬åœ°æ•°æ®ã€‚</p>
                    
                    <div class="warning-box">
                        âš ï¸ æ­¤æ“ä½œå°†ç”¨äº‘ç«¯æ•°æ®æ›¿æ¢æœ¬åœ°æ•°æ®ï¼Œè¯·ç¡®è®¤å·²å¤‡ä»½é‡è¦æ•°æ®ã€‚
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label>
                            <input type="checkbox" id="confirmDownload"> æˆ‘ç¡®è®¤è¦ä¸‹è½½å¹¶è¦†ç›–æœ¬åœ°æ•°æ®
                        </label>
                    </div>
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'å¼€å§‹ä¸‹è½½', onclick: 'handleCloudDownload()', className: 'btn-primary' }
            ]);
        }

        async function handleCloudDownload() {
            const confirm = document.getElementById('confirmDownload')?.checked;
            if (!confirm) {
                alert('è¯·å…ˆç¡®è®¤ä¸‹è½½æ“ä½œ');
                return;
            }
            
            closeModal();
            
            const statusDiv = document.getElementById('cloudStatus');
            if (statusDiv) {
                statusDiv.innerHTML = '<div class="info-box">â³ æ­£åœ¨ä»äº‘ç«¯ä¸‹è½½æ•°æ®...</div>';
            }
            
            try {
                // ä»äº‘ç«¯ä¸‹è½½
                const cloudData = await downloadFromCloud();
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                if (cloudData.users) appData.users = cloudData.users;
                if (cloudData.scores) appData.scores = cloudData.scores;
                if (cloudData.groups) appData.groups = cloudData.groups;
                if (cloudData.rules) appData.rules = cloudData.rules;
                if (cloudData.logs) appData.logs = cloudData.logs;
                if (cloudData.rewards) appData.rewards = cloudData.rewards;
                if (cloudData.punishments) appData.punishments = cloudData.punishments;
                if (cloudData.userPunishments) appData.userPunishments = cloudData.userPunishments;
                if (cloudData.gold) appData.gold = cloudData.gold;
                if (cloudData.exchangeRate) appData.exchangeRate = cloudData.exchangeRate;
                if (cloudData.emoji) appData.emoji = cloudData.emoji;
                if (cloudData.dailyReport) appData.dailyReport = cloudData.dailyReport;
                
                // æ›´æ–°äº‘ç«¯å…ƒæ•°æ®
                if (cloudData.cloudMeta) {
                    appData.cloudMeta = cloudData.cloudMeta;
                } else {
                    appData.cloudMeta = {
                        updated: 1,
                        lastSync: new Date().toISOString(),
                        version: '1.0'
                    };
                }
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveAllData();
                
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="success-box">
                            âœ… ä¸‹è½½æˆåŠŸï¼<br>
                            ç‰ˆæœ¬å·ï¼š${appData.cloudMeta.updated}<br>
                            æ—¶é—´ï¼š${new Date().toLocaleString()}
                        </div>
                    `;
                }
                
                alert('âœ… æ•°æ®ä¸‹è½½æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°...');
                setTimeout(() => location.reload(), 1500);
                
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                if (statusDiv) {
                    statusDiv.innerHTML = `<div class="warning-box">âŒ ä¸‹è½½å¤±è´¥ï¼š${error.message}</div>`;
                }
                alert('âŒ ä¸‹è½½å¤±è´¥ï¼š' + error.message);
            }
        }

        // ==================== äº‘ç«¯é…ç½®éªŒè¯ ====================
        async function testCloudConnection() {
            try {
                const statusDiv = document.getElementById('cloudStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '<div class="info-box">â³ æ­£åœ¨æµ‹è¯•äº‘ç«¯è¿æ¥...</div>';
                }
                
                const data = await downloadFromCloud();
                
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="success-box">
                            âœ… äº‘ç«¯è¿æ¥æ­£å¸¸ï¼<br>
                            æ•°æ®ç‰ˆæœ¬ï¼š${data.cloudMeta?.updated || 'æœªçŸ¥'}<br>
                            æœ€ååŒæ­¥ï¼š${data.cloudMeta?.lastSync ? new Date(data.cloudMeta.lastSync).toLocaleString() : 'æœªçŸ¥'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                const statusDiv = document.getElementById('cloudStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = `<div class="warning-box">âŒ äº‘ç«¯è¿æ¥å¤±è´¥ï¼š${error.message}</div>`;
                }
            }
        }

        // ==================== æ•°æ®å¤‡ä»½ ====================
        function showBackup() {
            if (!hasPermission('æ•°æ®å¤‡ä»½')) {
                alert('æƒé™ä¸è¶³');
                return;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ’¾ æ•°æ®å¤‡ä»½</h2>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                        <button class="btn btn-primary" onclick="importData()">ğŸ“‚ å¯¼å…¥æ•°æ®</button>
                        <button class="btn btn-primary" onclick="resetToDefault()">ğŸ”„ æ¢å¤é»˜è®¤</button>
                        <button class="btn btn-primary" onclick="syncToExcel()">ğŸ“Š åŒæ­¥åˆ°Excel</button>
                    </div>
                    
                    <div class="stats-grid" style="margin-top: 30px;">
                        <div class="stat-card">
                            <div class="stat-value">${(JSON.stringify(localStorage).length / 1024).toFixed(2)}</div>
                            <div class="stat-label">æœ¬åœ°å­˜å‚¨ (KB)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Object.keys(appData.users).length}</div>
                            <div class="stat-label">ç”¨æˆ·æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Object.keys(appData.scores).length}</div>
                            <div class="stat-label">å­¦ç”Ÿæ•°</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3>ğŸ“‹ å¤‡ä»½æ–‡ä»¶åˆ—è¡¨</h3>
                        <div id="backupList">
                            <p style="color: #718096;">è¯·åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ localStorage æ•°æ®</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function syncToExcel() {
            alert('ExcelåŒæ­¥åŠŸèƒ½éœ€è¦ä¸åç«¯é…åˆä½¿ç”¨ï¼Œå½“å‰ç‰ˆæœ¬ä»…æ”¯æŒJSONæ•°æ®å¯¼å‡ºã€‚');
        }

        function exportData() {
            const data = {};
            Object.keys(STORAGE_KEYS).forEach(key => {
                data[key] = appData[key.toLowerCase()];
            });
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `studentos_backup_${formatDate().replace(/[: ]/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        let count = 0;
                        Object.keys(STORAGE_KEYS).forEach(key => {
                            const dataKey = key.toLowerCase();
                            if (imported[key]) {
                                localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(imported[key]));
                                appData[dataKey] = imported[key];
                                count++;
                            }
                        });
                        alert(`âœ… æˆåŠŸå¯¼å…¥ ${count} ä¸ªæ•°æ®æ–‡ä»¶`);
                        location.reload();
                    } catch (err) {
                        alert('âŒ å¯¼å…¥å¤±è´¥ï¼šæ— æ•ˆçš„æ•°æ®æ–‡ä»¶');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetToDefault() {
            if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤æ•°æ®å—ï¼Ÿå½“å‰æ‰€æœ‰æ•°æ®å°†è¢«è¦†ç›–ï¼')) {
                appData.users = { ...DEFAULT_DATA.users };
                appData.scores = { ...DEFAULT_DATA.scores };
                appData.groups = { ...DEFAULT_DATA.groups };
                appData.rules = { ...DEFAULT_DATA.rules };
                appData.rewards = { ...DEFAULT_DATA.rewards };
                appData.punishments = { ...DEFAULT_DATA.punishments };
                appData.exchangeRate = { ...DEFAULT_DATA.exchangeRate };
                appData.emoji = DEFAULT_DATA.emoji;
                appData.userPunishments = { ...DEFAULT_DATA.userPunishments };
                appData.gold = { ...DEFAULT_DATA.gold };
                appData.dailyReport = { ...DEFAULT_DATA.dailyReport };
                
                saveAllData();
                alert('âœ… å·²æ¢å¤é»˜è®¤æ•°æ®');
                location.reload();
            }
        }

        // ==================== è´¦å·ç®¡ç† ====================
        function showAccountManagement() {
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ‘¤ è´¦å·ç®¡ç†</h2>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <span style="font-size: 5em; cursor: pointer;" onclick="showAvatarSelector()">${currentUser.avatar || 'ğŸ‘¤'}</span>
                    </div>
                    
                    <table class="data-table">
                        <tr><td><strong>ç”¨æˆ·å</strong></td><td>${currentUser.username}</td></tr>
                        <tr><td><strong>æ˜¾ç¤ºåç§°</strong></td><td>${currentUser.display_name}</td></tr>
                        <tr><td><strong>èº«ä»½</strong></td><td>${currentUser.role}</td></tr>
                        <tr><td><strong>å­¦å·</strong></td><td>${currentUser.student_id || 'æ— '}</td></tr>
                        <tr><td><strong>æœ€åç™»å½•</strong></td><td>${currentUser.last_login || 'é¦–æ¬¡ç™»å½•'}</td></tr>
                    </table>
                    
                    <div class="btn-grid" style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="showChangePassword()">ğŸ”‘ ä¿®æ”¹å¯†ç </button>
                        <button class="btn btn-primary" onclick="showChangeDisplayName()">ğŸ“ ä¿®æ”¹æ˜¾ç¤ºåç§°</button>
                        <button class="btn btn-primary" onclick="showAvatarSelector()">ğŸ–¼ï¸ ä¿®æ”¹å¤´åƒ</button>
                    </div>
                </div>
            `;
        }

        function showChangePassword() {
            showModal('ä¿®æ”¹å¯†ç ', `
                <div style="margin: 20px 0;">
                    <label>å½“å‰å¯†ç ï¼š</label>
                    <input type="password" id="oldPassword" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                    
                    <label>æ–°å¯†ç ï¼š</label>
                    <input type="password" id="newPassword" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                    
                    <label>ç¡®è®¤æ–°å¯†ç ï¼š</label>
                    <input type="password" id="confirmPassword" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤ä¿®æ”¹', onclick: 'handleChangePassword()', className: 'btn-primary' }
            ]);
        }

        function handleChangePassword() {
            const oldPass = document.getElementById('oldPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            
            if (oldPass !== currentUser.password) {
                alert('å½“å‰å¯†ç é”™è¯¯');
                return;
            }
            
            if (newPass.length < 4) {
                alert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº4ä½');
                return;
            }
            
            if (newPass !== confirm) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            currentUser.password = newPass;
            appData.users[currentUser.username].password = newPass;
            saveData('users');
            
            alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            closeModal();
            showAccountManagement();
        }

        function showChangeDisplayName() {
            showModal('ä¿®æ”¹æ˜¾ç¤ºåç§°', `
                <div style="margin: 20px 0;">
                    <label>æ–°æ˜¾ç¤ºåç§°ï¼š</label>
                    <input type="text" id="newDisplayName" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" value="${currentUser.display_name}">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤ä¿®æ”¹', onclick: 'handleChangeDisplayName()', className: 'btn-primary' }
            ]);
        }

        function handleChangeDisplayName() {
            const newName = document.getElementById('newDisplayName').value.trim();
            if (!newName) {
                alert('æ˜¾ç¤ºåç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            currentUser.display_name = newName;
            appData.users[currentUser.username].display_name = newName;
            saveData('users');
            
            document.getElementById('userDisplayName').textContent = newName;
            alert('æ˜¾ç¤ºåç§°ä¿®æ”¹æˆåŠŸï¼');
            closeModal();
            showAccountManagement();
        }

        function showAvatarSelector() {
            const emojis = Array.from(appData.emoji || 'ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜‡ğŸ™‚ğŸ™ƒğŸ˜‰ğŸ˜ŒğŸ˜ğŸ¥°ğŸ˜˜');
            const pageSize = 50;
            let currentPage = 0;
            
            function renderAvatarPage(page) {
                const start = page * pageSize;
                const end = Math.min(start + pageSize, emojis.length);
                const pageEmojis = emojis.slice(start, end);
                
                return `
                    <div style="margin: 20px 0;">
                        <div style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px;">
                            ${pageEmojis.map(emoji => `
                                <div onclick="selectAvatar('${emoji}')" style="font-size: 1.5em; text-align: center; padding: 5px; cursor: pointer; border-radius: 5px; background: #f7fafc;">
                                    ${emoji}
                                </div>
                            `).join('')}
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            ${page > 0 ? '<button class="btn btn-sm" onclick="changeAvatarPage(-1)">â¬…ï¸ ä¸Šä¸€é¡µ</button>' : ''}
                            <span style="margin: 0 20px;">ç¬¬ ${page + 1}/${Math.ceil(emojis.length / pageSize)} é¡µ</span>
                            ${end < emojis.length ? '<button class="btn btn-sm" onclick="changeAvatarPage(1)">ä¸‹ä¸€é¡µ â¡ï¸</button>' : ''}
                        </div>
                    </div>
                `;
            }
            
            window.changeAvatarPage = function(delta) {
                currentPage += delta;
                document.getElementById('avatarGrid').innerHTML = renderAvatarPage(currentPage);
            };
            
            window.selectAvatar = function(emoji) {
                currentUser.avatar = emoji;
                appData.users[currentUser.username].avatar = emoji;
                saveData('users');
                document.getElementById('userAvatar').textContent = emoji;
                alert('å¤´åƒä¿®æ”¹æˆåŠŸï¼');
                closeModal();
            };
            
            showModal('é€‰æ‹©å¤´åƒ', `
                <div id="avatarGrid">
                    ${renderAvatarPage(0)}
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' }
            ]);
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function getStudentScore(studentId) {
            return appData.scores[studentId]?.[1] || 0;
        }

        function getStudentGold(studentId) {
            return appData.gold[studentId]?.amount || 0;
        }

        function updateStudentScore(studentId, change, reason = '') {
            if (!appData.scores[studentId]) return false;
            const oldScore = appData.scores[studentId][1];
            appData.scores[studentId][1] = oldScore + change;
            saveData('scores');
            addLog('åˆ†æ•°è°ƒæ•´', studentId, change, appData.scores[studentId][1], reason);
            return true;
        }

        function updateStudentGold(studentId, change) {
            if (!appData.gold[studentId]) {
                appData.gold[studentId] = { amount: 0, last_updated: formatDate() };
            }
            appData.gold[studentId].amount += change;
            appData.gold[studentId].last_updated = formatDate();
            saveData('gold');
            return true;
        }

        function addLog(action, studentId, scoreChange, currentScore, reason = '') {
            const studentName = appData.scores[studentId]?.[0] || 'æœªçŸ¥';
            const log = {
                timestamp: formatDate(),
                action,
                student_id: studentId,
                student_name: studentName,
                score_change: scoreChange,
                current_score: currentScore,
                reason
            };
            appData.logs = appData.logs || [];
            appData.logs.unshift(log);
            if (appData.logs.length > 200) appData.logs.pop();
            saveData('logs');
        }

        // ==================== æ¨¡æ€æ¡† ====================
        function showModal(title, body, buttons) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            
            const buttonsDiv = document.getElementById('modalButtons');
            buttonsDiv.innerHTML = '';
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `btn ${btn.className || ''}`;
                button.textContent = btn.text;
                button.onclick = new Function(btn.onclick);
                buttonsDiv.appendChild(button);
            });
            
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // ==================== åˆå§‹åŒ– ====================
        window.onload = async function() {
            // æ˜¾ç¤ºåŠ è½½ç•Œé¢
            const loadingScreen = document.getElementById('loadingScreen');
            const progressFill = document.getElementById('progressFill');
            const syncStatus = document.getElementById('syncStatus');
            const loadingAnimation = document.getElementById('loadingAnimation');
            
            // æ›´æ–°åŠ è½½çŠ¶æ€
            function updateProgress(percent, message, emoji = 'â˜ï¸') {
                progressFill.style.width = percent + '%';
                syncStatus.textContent = message;
                loadingAnimation.textContent = emoji;
            }
            
            try {
                // æ­¥éª¤1: å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                updateProgress(20, 'æ­£åœ¨è¯»å–æœ¬åœ°æ•°æ®...', 'ğŸ’¾');
                const hasData = loadFromStorage();
                
                // æ­¥éª¤2: å°è¯•ä»äº‘ç«¯ä¸‹è½½
                updateProgress(40, 'æ­£åœ¨è¿æ¥äº‘ç«¯...', 'â˜ï¸');
                
                let cloudData = null;
                let cloudSuccess = false;
                
                try {
                    cloudData = await downloadFromCloud();
                    cloudSuccess = true;
                    updateProgress(60, 'äº‘ç«¯è¿æ¥æˆåŠŸï¼Œæ­£åœ¨åŒæ­¥...', 'âœ…');
                } catch (cloudError) {
                    console.warn('äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼:', cloudError);
                    updateProgress(60, 'äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼', 'âš ï¸');
                }
                
                // æ­¥éª¤3: åˆå¹¶äº‘ç«¯æ•°æ®
                if (cloudSuccess && cloudData) {
                    updateProgress(70, 'æ­£åœ¨åˆå¹¶äº‘ç«¯æ•°æ®...', 'ğŸ”„');
                    
                    // åˆå¹¶ç”¨æˆ·æ•°æ®
                    if (cloudData.users) {
                        appData.users = { ...appData.users, ...cloudData.users };
                    }
                    
                    // åˆå¹¶åˆ†æ•°æ•°æ®
                    if (cloudData.scores) {
                        appData.scores = { ...appData.scores, ...cloudData.scores };
                    }
                    
                    // åˆå¹¶åˆ†ç»„æ•°æ®
                    if (cloudData.groups) {
                        Object.entries(cloudData.groups).forEach(([groupName, members]) => {
                            if (!appData.groups[groupName]) {
                                appData.groups[groupName] = [];
                            }
                            members.forEach(member => {
                                if (!appData.groups[groupName].includes(member)) {
                                    appData.groups[groupName].push(member);
                                }
                            });
                        });
                    }
                    
                    // åˆå¹¶è§„åˆ™æ•°æ®
                    if (cloudData.rules) appData.rules = cloudData.rules;
                    
                    // åˆå¹¶æ—¥å¿—æ•°æ®ï¼ˆä¿ç•™æœ€æ–°200æ¡ï¼‰
                    if (cloudData.logs && Array.isArray(cloudData.logs)) {
                        const allLogs = [...cloudData.logs, ...(appData.logs || [])];
                        allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        appData.logs = allLogs.slice(0, 200);
                    }
                    
                    // åˆå¹¶å¥–åŠ±æ•°æ®
                    if (cloudData.rewards) appData.rewards = cloudData.rewards;
                    
                    // åˆå¹¶æƒ©ç½šæ•°æ®
                    if (cloudData.punishments) appData.punishments = cloudData.punishments;
                    
                    // åˆå¹¶ç”¨æˆ·æƒ©ç½šæ•°æ®
                    if (cloudData.userPunishments) {
                        if (!appData.userPunishments) {
                            appData.userPunishments = { active: {}, completed: {} };
                        }
                        
                        if (cloudData.userPunishments.active) {
                            Object.entries(cloudData.userPunishments.active).forEach(([userId, puns]) => {
                                if (!appData.userPunishments.active[userId]) {
                                    appData.userPunishments.active[userId] = [];
                                }
                                appData.userPunishments.active[userId] = [
                                    ...appData.userPunishments.active[userId],
                                    ...puns
                                ];
                            });
                        }
                        
                        if (cloudData.userPunishments.completed) {
                            Object.entries(cloudData.userPunishments.completed).forEach(([userId, puns]) => {
                                if (!appData.userPunishments.completed[userId]) {
                                    appData.userPunishments.completed[userId] = [];
                                }
                                appData.userPunishments.completed[userId] = [
                                    ...appData.userPunishments.completed[userId],
                                    ...puns
                                ];
                            });
                        }
                    }
                    
                    // åˆå¹¶é‡‘å¸æ•°æ®
                    if (cloudData.gold) {
                        Object.entries(cloudData.gold).forEach(([userId, goldData]) => {
                            if (!appData.gold[userId] || appData.gold[userId].amount < goldData.amount) {
                                appData.gold[userId] = goldData;
                            }
                        });
                    }
                    
                    // åˆå¹¶æ±‡ç‡æ•°æ®
                    if (cloudData.exchangeRate) appData.exchangeRate = cloudData.exchangeRate;
                    
                    // åˆå¹¶æ¯æ—¥æ±‡æŠ¥æ•°æ®
                    if (cloudData.dailyReport) {
                        appData.dailyReport = { ...appData.dailyReport, ...cloudData.dailyReport };
                    }
                    
                    // æ›´æ–°äº‘ç«¯å…ƒæ•°æ®
                    if (cloudData.cloudMeta) {
                        appData.cloudMeta = {
                            ...cloudData.cloudMeta,
                            lastSync: new Date().toISOString(),
                            autoSync: true
                        };
                    } else {
                        appData.cloudMeta = {
                            updated: 1,
                            lastSync: new Date().toISOString(),
                            autoSync: true
                        };
                    }
                    
                    updateProgress(85, 'äº‘ç«¯æ•°æ®åˆå¹¶å®Œæˆ', 'ğŸ‰');
                } else if (!hasData) {
                    // æ—¢æ²¡æœ‰æœ¬åœ°æ•°æ®ä¹Ÿæ²¡æœ‰äº‘ç«¯æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
                    updateProgress(70, 'æ­£åœ¨åŠ è½½é»˜è®¤æ•°æ®...', 'ğŸ“¦');
                    
                    appData.users = { ...DEFAULT_DATA.users };
                    appData.scores = { ...DEFAULT_DATA.scores };
                    appData.groups = { ...DEFAULT_DATA.groups };
                    appData.rules = { ...DEFAULT_DATA.rules };
                    appData.rewards = { ...DEFAULT_DATA.rewards };
                    appData.punishments = { ...DEFAULT_DATA.punishments };
                    appData.exchangeRate = { ...DEFAULT_DATA.exchangeRate };
                    appData.emoji = DEFAULT_DATA.emoji;
                    appData.userPunishments = { ...DEFAULT_DATA.userPunishments };
                    appData.gold = { ...DEFAULT_DATA.gold };
                    
                    appData.cloudMeta = {
                        updated: 0,
                        lastSync: null,
                        autoSync: false
                    };
                }
                
                // æ­¥éª¤4: ä¿å­˜æ‰€æœ‰æ•°æ®åˆ°æœ¬åœ°
                updateProgress(95, 'æ­£åœ¨ä¿å­˜æ•°æ®...', 'ğŸ’¿');
                saveAllData();
                
                // æ­¥éª¤5: å®Œæˆï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢
                updateProgress(100, 'åŠ è½½å®Œæˆï¼', 'âœ¨');
                
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'block';
                    renderUserSelect();
                    
                    // æ˜¾ç¤ºäº‘ç«¯åŒæ­¥çŠ¶æ€
                    const cloudStatus = document.getElementById('cloudStatus');
                    if (cloudStatus) {
                        const cloudIcon = document.getElementById('cloudIcon');
                        const cloudText = document.getElementById('cloudText');
                        
                        if (cloudSuccess) {
                            cloudIcon.textContent = 'â˜ï¸âœ…';
                            cloudText.textContent = 'äº‘ç«¯å·²åŒæ­¥';
                            cloudStatus.className = 'cloud-status online';
                        } else {
                            cloudIcon.textContent = 'â˜ï¸âš ï¸';
                            cloudText.textContent = 'æœ¬åœ°æ¨¡å¼';
                            cloudStatus.className = 'cloud-status offline';
                        }
                    }
                }, 500);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                
                // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤æ•°æ®
                updateProgress(100, 'åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®', 'âŒ');
                
                appData.users = { ...DEFAULT_DATA.users };
                appData.scores = { ...DEFAULT_DATA.scores };
                appData.groups = { ...DEFAULT_DATA.groups };
                appData.rules = { ...DEFAULT_DATA.rules };
                appData.rewards = { ...DEFAULT_DATA.rewards };
                appData.punishments = { ...DEFAULT_DATA.punishments };
                appData.exchangeRate = { ...DEFAULT_DATA.exchangeRate };
                appData.emoji = DEFAULT_DATA.emoji;
                appData.userPunishments = { ...DEFAULT_DATA.userPunishments };
                appData.gold = { ...DEFAULT_DATA.gold };
                
                saveAllData();
                
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'block';
                    renderUserSelect();
                    
                    alert('âš ï¸ äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œå·²ä½¿ç”¨æœ¬åœ°æ•°æ®ã€‚é”™è¯¯ï¼š' + error.message);
                }, 1000);
            }
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudentOS ç­çº§ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            width: 1400px;
            max-width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        /* åŠ è½½ç•Œé¢ */
        .loading-screen {
            padding: 40px;
            text-align: center;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loading-header {
            margin-bottom: 40px;
        }

        .loading-header h1 {
            font-size: 3em;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .loading-header .subtitle {
            color: #718096;
            font-size: 1.2em;
        }

        .loading-animation {
            font-size: 4em;
            margin: 30px 0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        .progress-bar {
            width: 80%;
            max-width: 500px;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .sync-status {
            color: #4a5568;
            margin: 20px 0;
            font-size: 1.1em;
        }

        /* ç™»å½•ç•Œé¢ */
        .login-screen {
            padding: 40px;
            text-align: center;
            display: none;
        }

        .login-header {
            margin-bottom: 40px;
        }

        .login-header h1 {
            font-size: 3em;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .login-header .subtitle {
            color: #718096;
            font-size: 1.2em;
        }

        .login-box {
            max-width: 400px;
            margin: 0 auto;
        }

        .user-select {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            background: white;
            cursor: pointer;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* ä¸»ç•Œé¢ */
        .main-screen {
            display: none;
            min-height: 700px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            font-size: 2.5em;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-details {
            text-align: left;
        }

        .user-name {
            font-size: 1.3em;
            font-weight: bold;
        }

        .user-role {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .cloud-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 250px;
            background: #f7fafc;
            border-right: 1px solid #e2e8f0;
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4a5568;
            font-size: 1.1em;
        }

        .menu-item:hover {
            background: #edf2f7;
            padding-left: 30px;
        }

        .menu-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: 600px;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.4em;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #718096;
            margin-top: 5px;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            background: #edf2f7;
            color: #4a5568;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-warning {
            background: #f6ad55;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th,
        .report-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .report-table th {
            background: #f7fafc;
            font-weight: 600;
        }

        .report-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .status-reported {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-unreported {
            background: #fed7d7;
            color: #742a2a;
        }

        .score-input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
        }

        .action-btn {
            padding: 5px 10px;
            margin: 0 2px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-minus {
            background: #f56565;
            color: white;
        }

        .btn-plus {
            background: #48bb78;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .folder-input {
            display: none;
        }

        .folder-label {
            display: block;
            padding: 30px;
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
        }

        .folder-label:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .file-list {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            padding: 5px;
            border-bottom: 1px solid #e2e8f0;
            font-family: monospace;
            font-size: 12px;
        }

        .file-item.success {
            color: #48bb78;
        }

        .file-item.error {
            color: #f56565;
        }

        .reward-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .reward-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .reward-rarity-SP { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .reward-rarity-SSR { background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%); }
        .reward-rarity-SR { background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); }
        .reward-rarity-R { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .reward-rarity-N { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }

        .reward-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
            color: white;
        }

        .reward-type {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .reward-desc {
            color: white;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .reward-prob {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.2);
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .info-box {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- åŠ è½½ç•Œé¢ -->
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-header">
                <h1>ğŸ“ StudentOS</h1>
                <div class="subtitle">æ­£åœ¨åŒæ­¥æ•°æ®...</div>
            </div>
            
            <div class="loading-animation" id="loadingAnimation">â˜ï¸</div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="sync-status" id="syncStatus">
                è¿æ¥ä¸­...
            </div>
        </div>

        <!-- ç™»å½•ç•Œé¢ -->
        <div class="login-screen" id="loginScreen">
            <div class="login-header">
                <h1>ğŸ“ StudentOS</h1>
                <div class="subtitle">ç­çº§ç®¡ç†ç³»ç»Ÿ</div>
            </div>
            <div class="login-box">
                <select class="user-select" id="userSelect">
                    <option value="">è¯·é€‰æ‹©è´¦å·...</option>
                </select>
                <input type="password" class="password-input" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                <button class="login-btn" onclick="handleLogin()">ç™»å½•ç³»ç»Ÿ</button>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div class="main-screen" id="mainScreen">
            <div class="header">
                <div class="user-info">
                    <span class="user-avatar" id="userAvatar" onclick="showAvatarSelector()">ğŸ‘¤</span>
                    <div class="user-details">
                        <div class="user-name" id="userDisplayName">åŠ è½½ä¸­...</div>
                        <div class="user-role" id="userRole">å­¦ç”Ÿ</div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div class="cloud-status" id="cloudStatus">
                        <span id="cloudIcon">â˜ï¸</span>
                        <span id="cloudText">æœ¬åœ°æ¨¡å¼</span>
                    </div>
                    <div class="friday-badge" id="fridayBadge">â° æŠ½å¥–æ—¶é—´ï¼šå‘¨äº”ä¸‹åˆ</div>
                </div>
            </div>
            
            <div class="main-content">
                <!-- ä¾§è¾¹æ èœå• -->
                <div class="sidebar" id="sidebar"></div>
                
                <!-- å†…å®¹åŒºåŸŸ -->
                <div class="content-area" id="contentArea"></div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨æ¨¡æ€æ¡† -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <div class="modal-title" id="modalTitle"></div>
            <div id="modalBody"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <script>
        // ==================== é…ç½® ====================
        const CONFIG = {
            binId: "6975bf17d0ea881f4083a3af",
            masterKey: "$2a$10$jC76j4CEGgqz842YvvDucuoWG6emHsBbdqNr56rj8..53SEVCpp/u"
        };

        // ==================== æ•°æ®å­˜å‚¨é”® ====================
        const STORAGE_KEYS = {
            USERS: 'studentos_users',
            SCORES: 'studentos_scores',
            GROUPS: 'studentos_groups',
            RULES: 'studentos_rules',
            LOGS: 'studentos_logs',
            REWARDS: 'studentos_rewards',
            PUNISHMENTS: 'studentos_punishments',
            USER_PUNISHMENTS: 'studentos_user_punishments',
            GOLD: 'studentos_gold',
            EXCHANGE_RATE: 'studentos_exchange_rate',
            EMOJI: 'studentos_emoji',
            DAILY_REPORT: 'studentos_daily_report'
        };

        // ==================== å…¨å±€çŠ¶æ€ ====================
        let currentUser = null;
        let appData = {
            users: {},
            scores: {},
            groups: {},
            rules: {},
            logs: [],
            rewards: {},
            punishments: {},
            userPunishments: { active: {}, completed: {} },
            gold: {},
            exchangeRate: { score_to_gold: 0.1, gold_to_score: 1.0 },
            emoji: '',
            dailyReport: {}
        };

        // ==================== æ–‡ä»¶æ˜ å°„ ====================
        const FILE_MAPPING = {
            'user.json': 'users',
            'score.json': 'scores',
            'gold_data.json': 'gold',
            'rewards.json': 'rewards',
            'punishment.json': 'punishments',
            'usr_pun.json': 'userPunishments',
            'log.json': 'logs',
            'score_rules.json': 'rules',
            'exchange_rate.json': 'exchangeRate',
            'emoji.json': 'emoji'
        };

        // ==================== å·¥å…·å‡½æ•° ====================
        function formatDate(date = new Date()) {
            return date.toISOString().slice(0, 19).replace('T', ' ');
        }

        function getBeijingDate(date = new Date()) {
            const beijingTime = new Date(date.getTime() + 8 * 60 * 60 * 1000);
            return beijingTime.toISOString().split('T')[0];
        }

        function isFridayAfternoon() {
            const now = new Date();
            return now.getDay() === 5 && now.getHours() >= 12;
        }

        function saveData(key) {
            const storageKey = STORAGE_KEYS[key.toUpperCase()];
            if (storageKey) {
                localStorage.setItem(storageKey, JSON.stringify(appData[key]));
            }
        }

        function loadFromStorage() {
            for (const [key, storageKey] of Object.entries(STORAGE_KEYS)) {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    try {
                        appData[key.toLowerCase()] = JSON.parse(stored);
                    } catch (e) {
                        console.error(`è§£æ ${key} å¤±è´¥:`, e);
                    }
                }
            }
        }

        // ==================== äº‘ç«¯åŒæ­¥ï¼ˆä»…ä¸Šä¼ ï¼‰====================
        async function handleFolderSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            document.getElementById('syncStatus').innerHTML = 'æ­£åœ¨è¯»å–æ–‡ä»¶...';
            document.getElementById('progressFill').style.width = '30%';
            
            const fileData = {};
            let jsonCount = 0;
            
            for (let file of files) {
                const fileName = file.name;
                const dataKey = FILE_MAPPING[fileName];
                
                if (dataKey) {
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        if (fileName === 'user.json') {
                            fileData.users = data.users || data;
                        } else if (fileName === 'score.json') {
                            fileData.scores = data.studentDefaultScore || data;
                            fileData.groups = data.studentGroups || {};
                        } else {
                            fileData[dataKey] = data;
                        }
                        
                        jsonCount++;
                        
                    } catch (e) {
                        console.error(`è¯»å–å¤±è´¥ ${fileName}:`, e);
                    }
                }
            }
            
            document.getElementById('progressFill').style.width = '60%';
            document.getElementById('syncStatus').innerHTML = `å·²è¯»å– ${jsonCount} ä¸ªæ–‡ä»¶ï¼Œæ­£åœ¨ä¸Šä¼ ...`;
            
            if (jsonCount === 0) {
                alert('æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„JSONæ–‡ä»¶');
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
                renderUserSelect();
                return;
            }
            
            // æ·»åŠ  updated=1 æ ‡è®°
            fileData.updated = 1;
            
            try {
                // ä¸Šä¼ åˆ°äº‘ç«¯
                await uploadToCloud(fileData);
                
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('syncStatus').innerHTML = 'åŒæ­¥å®Œæˆï¼';
                
                // ä¿å­˜åˆ°æœ¬åœ°
                if (fileData.users) appData.users = fileData.users;
                if (fileData.scores) appData.scores = fileData.scores;
                if (fileData.groups) appData.groups = fileData.groups;
                if (fileData.rules) appData.rules = fileData.rules;
                if (fileData.rewards) appData.rewards = fileData.rewards;
                if (fileData.punishments) appData.punishments = fileData.punishments;
                if (fileData.gold) appData.gold = fileData.gold;
                if (fileData.exchangeRate) appData.exchangeRate = fileData.exchangeRate;
                if (fileData.emoji) appData.emoji = fileData.emoji;
                if (fileData.dailyReport) appData.dailyReport = fileData.dailyReport;
                
                // ä¿å­˜åˆ°localStorage
                Object.keys(STORAGE_KEYS).forEach(key => {
                    if (appData[key.toLowerCase()]) {
                        localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(appData[key.toLowerCase()]));
                    }
                });
                
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'block';
                    renderUserSelect();
                }, 1000);
                
            } catch (error) {
                alert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
                renderUserSelect();
            }
        }

        async function uploadToCloud(data) {
            const url = `https://api.jsonbin.io/v3/b/${CONFIG.binId}`;
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": CONFIG.masterKey
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`ä¸Šä¼ å¤±è´¥: HTTP ${response.status}`);
            }
            
            return await response.json();
        }

        // ==================== æƒé™æ£€æŸ¥ ====================
        function hasPermission(permission) {
            if (!currentUser) return false;
            const role = currentUser.role;
            
            const permissions = {
                user: ['æˆ‘çš„åˆ†æ•°', 'æ’åç®¡ç†', 'å­¦åˆ†æŠ½å¥–', 'æƒ©ç½šç®¡ç†', 'é‡‘å¸ç³»ç»Ÿ'],
                admin: ['åˆ†æ•°ç®¡ç†', 'åˆ†ç»„ç®¡ç†', 'æ’åç®¡ç†', 'æ•°æ®å¤‡ä»½', 'å­¦åˆ†æŠ½å¥–', 'æƒ©ç½šç®¡ç†', 'é‡‘å¸ç³»ç»Ÿ', 'æˆ‘çš„åˆ†æ•°', 'æ¯æ—¥æ±‡æŠ¥', 'äº‘ç«¯åŒæ­¥'],
                root: ['åˆ†æ•°ç®¡ç†', 'åˆ†ç»„ç®¡ç†', 'æ’åç®¡ç†', 'æ“ä½œæ—¥å¿—', 'æ•°æ®å¤‡ä»½', 'å­¦åˆ†æŠ½å¥–', 'æƒ©ç½šç®¡ç†', 'é‡‘å¸ç³»ç»Ÿ', 'æˆ‘çš„åˆ†æ•°', 'æ¯æ—¥æ±‡æŠ¥', 'äº‘ç«¯åŒæ­¥']
            };
            
            return permissions[role]?.includes(permission) || false;
        }

        // ==================== ç™»å½• ====================
        function renderUserSelect() {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è´¦å·...</option>';
            
            Object.values(appData.users).forEach(user => {
                if (user && user.username) {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = `${user.display_name || user.username} (${user.role || 'user'})`;
                    select.appendChild(option);
                }
            });
        }

        function handleLogin() {
            const username = document.getElementById('userSelect').value;
            const password = document.getElementById('password').value;
            
            if (!username) {
                alert('è¯·é€‰æ‹©è´¦å·');
                return;
            }
            
            const user = appData.users[username];
            if (!user || user.password !== password) {
                alert('å¯†ç é”™è¯¯');
                return;
            }
            
            currentUser = { ...user, username };
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            
            document.getElementById('userAvatar').textContent = currentUser.avatar || 'ğŸ‘¤';
            document.getElementById('userDisplayName').textContent = currentUser.display_name || username;
            const roleNames = { user: 'ğŸ‘¤ å­¦ç”Ÿ', admin: 'ğŸ”§ ç®¡ç†å‘˜', root: 'âš¡ è¶…çº§ç®¡ç†å‘˜' };
            document.getElementById('userRole').textContent = roleNames[currentUser.role] || 'å­¦ç”Ÿ';
            
            const fridayBadge = document.getElementById('fridayBadge');
            fridayBadge.innerHTML = isFridayAfternoon() ? 
                'ğŸ‰ ç°åœ¨æ˜¯å‘¨äº”ä¸‹åˆï¼Œå¯ä»¥æŠ½å¥–å•¦ï¼' : 
                'â° æŠ½å¥–æ—¶é—´ï¼šå‘¨äº”ä¸‹åˆ12:00å';
            
            renderSidebar();
            showDashboard();
        }

        // ==================== ä¾§è¾¹æ  ====================
        function renderSidebar() {
            const menuItems = [
                { id: 'dashboard', icon: 'ğŸ ', name: 'æ§åˆ¶å°', permission: null },
                { id: 'myScore', icon: 'ğŸ“Š', name: 'æˆ‘çš„åˆ†æ•°', permission: 'æˆ‘çš„åˆ†æ•°' },
                { id: 'score', icon: 'ğŸ“Š', name: 'åˆ†æ•°ç®¡ç†', permission: 'åˆ†æ•°ç®¡ç†' },
                { id: 'group', icon: 'ğŸ‘¥', name: 'åˆ†ç»„ç®¡ç†', permission: 'åˆ†ç»„ç®¡ç†' },
                { id: 'ranking', icon: 'ğŸ†', name: 'æ’åç®¡ç†', permission: 'æ’åç®¡ç†' },
                { id: 'dailyReport', icon: 'ğŸ“‹', name: 'æ¯æ—¥æ±‡æŠ¥', permission: 'æ¯æ—¥æ±‡æŠ¥' },
                { id: 'gacha', icon: 'ğŸ°', name: 'å­¦åˆ†æŠ½å¥–', permission: 'å­¦åˆ†æŠ½å¥–' },
                { id: 'punishment', icon: 'ğŸ¯', name: 'æƒ©ç½šç®¡ç†', permission: 'æƒ©ç½šç®¡ç†' },
                { id: 'gold', icon: 'ğŸ’°', name: 'é‡‘å¸ç³»ç»Ÿ', permission: 'é‡‘å¸ç³»ç»Ÿ' },
                { id: 'logs', icon: 'ğŸ“‹', name: 'æ“ä½œæ—¥å¿—', permission: 'æ“ä½œæ—¥å¿—' },
                { id: 'cloudSync', icon: 'â˜ï¸', name: 'äº‘ç«¯åŒæ­¥', permission: 'äº‘ç«¯åŒæ­¥' },
                { id: 'backup', icon: 'ğŸ’¾', name: 'æ•°æ®å¤‡ä»½', permission: 'æ•°æ®å¤‡ä»½' },
                { id: 'account', icon: 'ğŸ‘¤', name: 'è´¦å·ç®¡ç†', permission: null },
                { id: 'logout', icon: 'ğŸšª', name: 'é€€å‡ºç³»ç»Ÿ', permission: null }
            ];
            
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';
            
            menuItems.forEach(item => {
                if (item.permission && !hasPermission(item.permission)) return;
                
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `${item.icon} ${item.name}`;
                div.onclick = () => {
                    if (item.id === 'logout') {
                        if (confirm('ç¡®å®šè¦é€€å‡ºç³»ç»Ÿå—ï¼Ÿ')) {
                            currentUser = null;
                            document.getElementById('loginScreen').style.display = 'block';
                            document.getElementById('mainScreen').style.display = 'none';
                            document.getElementById('password').value = '';
                        }
                        return;
                    }
                    
                    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
                    div.classList.add('active');
                    
                    switch(item.id) {
                        case 'dashboard': showDashboard(); break;
                        case 'myScore': showMyScore(); break;
                        case 'score': showScoreManagement(); break;
                        case 'group': showGroupManagement(); break;
                        case 'ranking': showRanking(); break;
                        case 'dailyReport': showDailyReport(); break;
                        case 'gacha': showGacha(); break;
                        case 'punishment': showPunishment(); break;
                        case 'gold': showGoldSystem(); break;
                        case 'logs': showLogs(); break;
                        case 'cloudSync': showCloudSync(); break;
                        case 'backup': showBackup(); break;
                        case 'account': showAccountManagement(); break;
                    }
                };
                sidebar.appendChild(div);
            });
        }

        // ==================== æ§åˆ¶å° ====================
        function showDashboard() {
            const studentId = currentUser.student_id;
            const score = getStudentScore(studentId);
            const gold = getStudentGold(studentId);
            
            const studentCount = Object.keys(appData.scores).filter(id => id !== '0').length;
            const today = getBeijingDate();
            const reportedToday = (appData.dailyReport[today] || []).length;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ“Š ç³»ç»Ÿæ§åˆ¶å°</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${score}</div>
                            <div class="stat-label">æˆ‘çš„å­¦åˆ†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${gold}</div>
                            <div class="stat-label">æˆ‘çš„é‡‘å¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${studentCount}</div>
                            <div class="stat-label">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${reportedToday}</div>
                            <div class="stat-label">ä»Šæ—¥å·²æ±‡æŠ¥</div>
                        </div>
                    </div>
                    
                    <h3>ğŸ“¢ ç³»ç»Ÿå…¬å‘Š</h3>
                    <ul style="margin: 20px 0; list-style: none;">
                        <li style="margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 8px;">
                            ğŸ‰ å­¦åˆ†æŠ½å¥–åªåœ¨å‘¨äº”ä¸‹åˆå¼€æ”¾
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 8px;">
                            ğŸ¯ æƒ©ç½šæŠ½å–æ¡ä»¶ï¼šåˆ†æ•°ä½äº100åˆ†
                        </li>
                        <li style="margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 8px;">
                            ğŸ’° é‡‘å¸ç³»ç»Ÿå·²ä¸Šçº¿ï¼Œå¯ä»¥å…‘æ¢å­¦åˆ†ï¼
                        </li>
                    </ul>
                    
                    <h3>ğŸ“ˆ è¿‘æœŸæ´»åŠ¨</h3>
                    <div style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                        ${(appData.logs || []).slice(0, 5).map(log => `
                            <div style="padding: 10px; border-left: 3px solid #667eea; margin: 10px 0; background: #f7fafc;">
                                <div>ğŸ“… ${log.timestamp}</div>
                                <div>${log.student_name || 'æœªçŸ¥'} ${log.action}: ${log.score_change > 0 ? '+' : ''}${log.score_change}åˆ†</div>
                                ${log.reason ? `<div style="color: #718096;">ğŸ“ ${log.reason}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ==================== æˆ‘çš„åˆ†æ•° ====================
        function showMyScore() {
            const studentId = currentUser.student_id;
            const studentName = appData.scores[studentId]?.[0] || 'æœªçŸ¥';
            const score = getStudentScore(studentId);
            
            const myLogs = (appData.logs || []).filter(log => log.student_id === studentId);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ“Š æˆ‘çš„åˆ†æ•°</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${score}</div>
                            <div class="stat-label">å½“å‰åˆ†æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${myLogs.length}</div>
                            <div class="stat-label">å˜åŒ–æ¬¡æ•°</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">ğŸ•’ æœ€è¿‘å˜åŒ–</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                                <th>å˜åŒ–</th>
                                <th>åŸå› </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${myLogs.slice(0, 10).map(log => `
                                <tr>
                                    <td>${log.timestamp ? log.timestamp.split(' ')[1] : ''}</td>
                                    <td>${log.action || ''}</td>
                                    <td style="color: ${log.score_change > 0 ? '#48bb78' : '#f56565'}">
                                        ${log.score_change > 0 ? '+' : ''}${log.score_change}
                                    </td>
                                    <td>${log.reason || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ==================== åˆ†æ•°ç®¡ç† ====================
        function showScoreManagement() {
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ“Š åˆ†æ•°ç®¡ç†</h2>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="showScoreAddSingle()">â• å•ä¸ªåŠ åˆ†</button>
                        <button class="btn btn-primary" onclick="showScoreAddBatch()">ğŸ”¢ æ‰¹é‡åŠ åˆ†</button>
                        <button class="btn btn-primary" onclick="showScoreSet()">ğŸ“ è®¾ç½®åˆ†æ•°</button>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <input type="text" placeholder="æœç´¢å­¦ç”Ÿ..." style="width: 100%; padding: 10px; margin-bottom: 20px; border: 2px solid #e2e8f0; border-radius: 8px;" 
                               onkeyup="filterStudents(this.value)">
                        
                        <table class="data-table" id="scoreTable">
                            <thead>
                                <tr>
                                    <th>å­¦å·</th>
                                    <th>å§“å</th>
                                    <th>åˆ†æ•°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map(([id, [name, score]]) => `
                                    <tr data-name="${name}">
                                        <td>${id}</td>
                                        <td>${name}</td>
                                        <td>${score}</td>
                                        <td>
                                            <button class="btn btn-sm" onclick="quickAddScore('${id}', 2)">+2</button>
                                            <button class="btn btn-sm" onclick="quickAddScore('${id}', -2)">-2</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function filterStudents(keyword) {
            const rows = document.querySelectorAll('#scoreTable tbody tr');
            rows.forEach(row => {
                const name = row.getAttribute('data-name') || '';
                row.style.display = name.includes(keyword) ? '' : 'none';
            });
        }

        function quickAddScore(studentId, change) {
            if (updateStudentScore(studentId, change, 'å¿«é€Ÿè°ƒæ•´')) {
                showScoreManagement();
            }
        }

        function showScoreAddSingle() {
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id, [name, score]]) => `${id} - ${name} (${score}åˆ†)`);
            
            showModal('å•ä¸ªåŠ åˆ†', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
                    <select id="scoreStudentSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${students.map(s => `<option value="${s.split(' - ')[0]}">${s}</option>`).join('')}
                    </select>
                    
                    <label>åŠ åˆ†/æ‰£åˆ†æ•°å€¼ï¼š</label>
                    <input type="number" id="scoreChangeValue" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="æ­£æ•°ä¸ºåŠ åˆ†ï¼Œè´Ÿæ•°ä¸ºæ‰£åˆ†">
                    
                    <label>åŸå› ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <input type="text" id="scoreChangeReason" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="è¯·è¾“å…¥åŸå› ">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤', onclick: 'handleScoreAddSingle()', className: 'btn-primary' }
            ]);
        }

        function handleScoreAddSingle() {
            const studentId = document.getElementById('scoreStudentSelect').value;
            const change = parseFloat(document.getElementById('scoreChangeValue').value);
            const reason = document.getElementById('scoreChangeReason').value;
            
            if (isNaN(change)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°');
                return;
            }
            
            if (updateStudentScore(studentId, change, reason)) {
                closeModal();
                showScoreManagement();
            }
        }

        function showScoreAddBatch() {
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id, [name, score]]) => `<label style="display: block; margin: 5px;">
                    <input type="checkbox" value="${id}" class="batch-student"> ${id} - ${name} (${score}åˆ†)
                </label>`);
            
            showModal('æ‰¹é‡åŠ åˆ†', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px;">
                        ${students.join('')}
                    </div>
                    
                    <label style="margin-top: 15px; display: block;">
                        <input type="checkbox" onclick="toggleAllStudents(this)"> å…¨é€‰
                    </label>
                    
                    <label style="margin-top: 15px; display: block;">åŠ åˆ†/æ‰£åˆ†æ•°å€¼ï¼š</label>
                    <input type="number" id="batchScoreChange" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                    
                    <label>åŸå› ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <input type="text" id="batchScoreReason" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤', onclick: 'handleScoreAddBatch()', className: 'btn-primary' }
            ]);
        }

        function toggleAllStudents(checkbox) {
            document.querySelectorAll('.batch-student').forEach(cb => cb.checked = checkbox.checked);
        }

        function handleScoreAddBatch() {
            const checkboxes = document.querySelectorAll('.batch-student:checked');
            const change = parseFloat(document.getElementById('batchScoreChange').value);
            const reason = document.getElementById('batchScoreReason').value;
            
            if (checkboxes.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªå­¦ç”Ÿ');
                return;
            }
            
            if (isNaN(change)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°');
                return;
            }
            
            let success = 0;
            checkboxes.forEach(cb => {
                if (updateStudentScore(cb.value, change, reason)) success++;
            });
            
            alert(`æ“ä½œæˆåŠŸï¼æˆåŠŸä¸º ${success} åå­¦ç”Ÿ${change > 0 ? 'åŠ ' : 'å‡'}åˆ†`);
            closeModal();
            showScoreManagement();
        }

        function showScoreSet() {
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id, [name, score]]) => `${id} - ${name} (${score}åˆ†)`);
            
            showModal('è®¾ç½®åˆ†æ•°', `
                <div style="margin: 20px 0;">
                    <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
                    <select id="setStudentSelect" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                        ${students.map(s => `<option value="${s.split(' - ')[0]}">${s}</option>`).join('')}
                    </select>
                    
                    <label>æ–°åˆ†æ•°ï¼š</label>
                    <input type="number" id="setScoreValue" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤', onclick: 'handleScoreSet()', className: 'btn-primary' }
            ]);
        }

        function handleScoreSet() {
            const studentId = document.getElementById('setStudentSelect').value;
            const newScore = parseFloat(document.getElementById('setScoreValue').value);
            
            if (isNaN(newScore)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°');
                return;
            }
            
            const oldScore = getStudentScore(studentId);
            appData.scores[studentId][1] = newScore;
            saveData('scores');
            addLog('è®¾ç½®åˆ†æ•°', studentId, newScore - oldScore, newScore, `ä»${oldScore}è®¾ç½®ä¸º${newScore}`);
            
            alert('è®¾ç½®æˆåŠŸ');
            closeModal();
            showScoreManagement();
        }

        // ==================== åˆ†ç»„ç®¡ç† ====================
        function showGroupManagement() {
            const groups = appData.groups || {};
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ‘¥ åˆ†ç»„ç®¡ç†</h2>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="showGroupCreate()">ğŸ†• åˆ›å»ºåˆ†ç»„</button>
                        <button class="btn btn-primary" onclick="showGroupList()">ğŸ“‹ æŸ¥çœ‹åˆ†ç»„</button>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3>ğŸ“Š åˆ†ç»„æ¦‚è§ˆ</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${Object.keys(groups).length}</div>
                                <div class="stat-label">æ€»åˆ†ç»„æ•°</div>
                            </div>
                        </div>
                        
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>åˆ†ç»„åç§°</th>
                                    <th>æˆå‘˜æ•°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(groups).map(([name, members]) => `
                                    <tr>
                                        <td>${name}</td>
                                        <td>${(members || []).length}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showGroupCreate() {
            showModal('åˆ›å»ºåˆ†ç»„', `
                <div style="margin: 20px 0;">
                    <label>åˆ†ç»„åç§°ï¼š</label>
                    <input type="text" id="groupName" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'åˆ›å»º', onclick: 'handleGroupCreate()', className: 'btn-primary' }
            ]);
        }

        function handleGroupCreate() {
            const name = document.getElementById('groupName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                return;
            }
            
            if (!appData.groups) appData.groups = {};
            if (appData.groups[name]) {
                alert('åˆ†ç»„å·²å­˜åœ¨');
                return;
            }
            
            appData.groups[name] = [];
            saveData('groups');
            alert('åˆ›å»ºæˆåŠŸ');
            closeModal();
            showGroupManagement();
        }

        function showGroupList() {
            const groups = appData.groups || {};
            
            showModal('åˆ†ç»„åˆ—è¡¨', `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${Object.entries(groups).map(([name, members]) => `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 10px;">
                            <h4 style="margin-bottom: 10px;">ğŸ”¹ ${name} (${members.length}äºº)</h4>
                            <p style="color: #718096;">${members.join(', ') || 'æš‚æ— æˆå‘˜'}</p>
                        </div>
                    `).join('')}
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        // ==================== æ’åç®¡ç† ====================
        function showRanking() {
            const rankings = getTopRanking();
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ† æ’åç®¡ç†</h2>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="showIndividualRanking()">ğŸ‘¤ ä¸ªäººæ’å</button>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3>ğŸ“Š ä¸ªäººæ’å TOP 10</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>å§“å</th>
                                    <th>å­¦å·</th>
                                    <th>åˆ†æ•°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rankings.slice(0, 10).map((rank, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${rank.name}</td>
                                        <td>${rank.id}</td>
                                        <td><strong>${rank.score}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function getTopRanking() {
            return Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .map(([id, [name, score]]) => ({ id, name, score }))
                .sort((a, b) => b.score - a.score);
        }

        function showIndividualRanking() {
            const rankings = getTopRanking();
            
            showModal('ä¸ªäººæ’å', `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>å§“å</th>
                                <th>å­¦å·</th>
                                <th>åˆ†æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankings.map((rank, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${rank.name}</td>
                                    <td>${rank.id}</td>
                                    <td><strong>${rank.score}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        // ==================== æ¯æ—¥æ±‡æŠ¥ ====================
        function showDailyReport() {
            const students = Object.entries(appData.scores || {})
                .filter(([id]) => id !== '0')
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            const today = getBeijingDate();
            const reportedToday = appData.dailyReport[today] || [];
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ“‹ æ¯æ—¥æ±‡æŠ¥</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${reportedToday.length}</div>
                            <div class="stat-label">ä»Šæ—¥å·²æ±‡æŠ¥</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; overflow-x: auto;">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>å­¦å·</th>
                                    <th>å§“å</th>
                                    <th>åˆ†æ•°</th>
                                    <th>ä»Šæ—¥æ±‡æŠ¥</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map(([id, [name, score]]) => {
                                    const isReported = reportedToday.includes(id);
                                    return `
                                        <tr>
                                            <td>${id}</td>
                                            <td>${name}</td>
                                            <td>${score}</td>
                                            <td>
                                                <span class="report-status ${isReported ? 'status-reported' : 'status-unreported'}" 
                                                      onclick="toggleReport('${id}')">
                                                    ${isReported ? 'âœ“ å·²æ±‡æŠ¥' : 'â­• æœªæ±‡æŠ¥'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="action-btn btn-minus" onclick="quickAdjust('${id}', -2)">-2</button>
                                                <button class="action-btn btn-plus" onclick="quickAdjust('${id}', 2)">+2</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function toggleReport(studentId) {
            const today = getBeijingDate();
            if (!appData.dailyReport[today]) {
                appData.dailyReport[today] = [];
            }
            
            const index = appData.dailyReport[today].indexOf(studentId);
            if (index === -1) {
                appData.dailyReport[today].push(studentId);
            } else {
                appData.dailyReport[today].splice(index, 1);
            }
            
            saveData('dailyReport');
            showDailyReport();
        }

        function quickAdjust(studentId, change) {
            updateStudentScore(studentId, change, 'æ¯æ—¥æ±‡æŠ¥è°ƒæ•´');
            showDailyReport();
        }

        // ==================== å­¦åˆ†æŠ½å¥– ====================
        function showGacha() {
            const studentId = currentUser.student_id;
            const gold = getStudentGold(studentId);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ° å­¦åˆ†æŠ½å¥–</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${gold}</div>
                            <div class="stat-label">æˆ‘çš„é‡‘å¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">160</div>
                            <div class="stat-label">å•æŠ½ä»·æ ¼</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        ${isFridayAfternoon() 
                            ? `<div style="background: #fef3c7; padding: 15px; border-radius: 10px; color: #d97706;">
                                ğŸ‰ ç°åœ¨æ˜¯å‘¨äº”ä¸‹åˆï¼Œå¯ä»¥æŠ½å¥–å•¦ï¼
                               </div>`
                            : `<div style="background: #e2e8f0; padding: 15px; border-radius: 10px;">
                                â° æŠ½å¥–åªåœ¨å‘¨äº”ä¸‹åˆ12:00åå¼€æ”¾
                               </div>`
                        }
                    </div>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="handleSingleGacha()" ${!isFridayAfternoon() ? 'disabled' : ''}>
                            ğŸ¯ å•æ¬¡æŠ½å¥– (160é‡‘å¸)
                        </button>
                    </div>
                </div>
            `;
        }

        function handleSingleGacha() {
            const studentId = currentUser.student_id;
            const gold = getStudentGold(studentId);
            
            if (gold < 160) {
                alert('é‡‘å¸ä¸è¶³ï¼');
                return;
            }
            
            if (!confirm(`æ¶ˆè€—160é‡‘å¸è¿›è¡ŒæŠ½å¥–ï¼Œç¡®å®šå—ï¼Ÿ`)) return;
            
            updateStudentGold(studentId, -160);
            
            const rewards = Object.values(appData.rewards || {}).flat() || [{ name: 'è°¢è°¢å‚ä¸', type: 'è™šæ‹Ÿ', description: 'ä¸‹æ¬¡å¥½è¿ï¼' }];
            const reward = rewards[Math.floor(Math.random() * rewards.length)];
            
            if (reward.name.includes('+')) {
                const scoreMatch = reward.name.match(/(\d+)/);
                if (scoreMatch) {
                    const score = parseInt(scoreMatch[0]);
                    updateStudentScore(studentId, score, `æŠ½å¥–è·å¾—: ${reward.name}`);
                }
            }
            
            alert(`ğŸ‰ è·å¾—: ${reward.name}\n${reward.description}`);
            showGacha();
        }

        // ==================== æƒ©ç½šç®¡ç† ====================
        function showPunishment() {
            const studentId = currentUser.student_id;
            const score = getStudentScore(studentId);
            const activePuns = (appData.userPunishments?.active?.[studentId]) || [];
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ¯ æƒ©ç½šç®¡ç†</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${score}</div>
                            <div class="stat-label">å½“å‰åˆ†æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${activePuns.length}</div>
                            <div class="stat-label">è¿›è¡Œä¸­</div>
                        </div>
                    </div>
                    
                    ${score < 100 
                        ? `<div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            ğŸ¯ ä½ çš„åˆ†æ•°ä½äº100åˆ†ï¼Œå¯ä»¥æŠ½å–æƒ©ç½šï¼
                           </div>`
                        : `<div style="background: #e2e8f0; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            âš ï¸ åªæœ‰åˆ†æ•°ä½äº100åˆ†æ‰èƒ½æŠ½å–æƒ©ç½š
                           </div>`
                    }
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="handleDrawPunishment()" ${score >= 100 ? 'disabled' : ''}>
                            ğŸ² æŠ½å–æƒ©ç½š
                        </button>
                        <button class="btn btn-primary" onclick="showMyPunishments()">
                            ğŸ“‹ æˆ‘çš„æƒ©ç½š
                        </button>
                    </div>
                </div>
            `;
        }

        function handleDrawPunishment() {
            const studentId = currentUser.student_id;
            const score = getStudentScore(studentId);
            
            if (score >= 100) {
                alert('åˆ†æ•°éœ€ä½äº100åˆ†æ‰èƒ½æŠ½å–æƒ©ç½š');
                return;
            }
            
            const pool = Object.values(appData.punishments || {}).flat() || [{ name: 'é»˜è®¤æƒ©ç½š', description: 'å®Œæˆä¸€é¡¹ä»»åŠ¡', score: [5, -2] }];
            const punishment = pool[Math.floor(Math.random() * pool.length)];
            
            const newPun = {
                id: Date.now().toString(),
                name: punishment.name || 'æœªçŸ¥æƒ©ç½š',
                description: punishment.description || '',
                success_gold: (punishment.score?.[0] || 0) * 10,
                fail_gold: (punishment.score?.[1] || 0) * 10,
                deadline: new Date(Date.now() + 7*24*60*60*1000).toISOString(),
                status: 'active'
            };
            
            if (!appData.userPunishments) appData.userPunishments = { active: {}, completed: {} };
            if (!appData.userPunishments.active[studentId]) {
                appData.userPunishments.active[studentId] = [];
            }
            appData.userPunishments.active[studentId].push(newPun);
            saveData('userPunishments');
            
            alert(`ğŸ¯ æŠ½åˆ°æƒ©ç½š: ${newPun.name}\n${newPun.description}`);
            showPunishment();
        }

        function showMyPunishments() {
            const studentId = currentUser.student_id;
            const active = (appData.userPunishments?.active?.[studentId]) || [];
            
            showModal('æˆ‘çš„æƒ©ç½š', `
                <div>
                    <h4>ğŸ“‹ è¿›è¡Œä¸­çš„æƒ©ç½š (${active.length})</h4>
                    ${active.map(pun => `
                        <div style="padding: 10px; margin: 10px 0; background: #f7fafc; border-radius: 8px;">
                            <strong>${pun.name}</strong>
                            <p style="font-size: 0.9em; color: #718096;">${pun.description}</p>
                            <p>âœ… æˆåŠŸ: +${pun.success_gold}é‡‘å¸ | âŒ å¤±è´¥: ${pun.fail_gold}é‡‘å¸</p>
                        </div>
                    `).join('') || '<p style="color: #718096;">æš‚æ— è¿›è¡Œä¸­çš„æƒ©ç½š</p>'}
                </div>
            `, [
                { text: 'å…³é—­', onclick: 'closeModal()' }
            ]);
        }

        // ==================== é‡‘å¸ç³»ç»Ÿ ====================
        function showGoldSystem() {
            const studentId = currentUser.student_id;
            const score = getStudentScore(studentId);
            const gold = getStudentGold(studentId);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ’° é‡‘å¸ç³»ç»Ÿ</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${score}</div>
                            <div class="stat-label">å­¦åˆ†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${gold}</div>
                            <div class="stat-label">é‡‘å¸</div>
                        </div>
                    </div>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="showScoreToGold()">ğŸ”„ å­¦åˆ†å…‘æ¢é‡‘å¸</button>
                        <button class="btn btn-primary" onclick="showGoldToScore()">ğŸ”„ é‡‘å¸å…‘æ¢å­¦åˆ†</button>
                    </div>
                </div>
            `;
        }

        function showScoreToGold() {
            const studentId = currentUser.student_id;
            const score = getStudentScore(studentId);
            const rate = 0.1;
            
            showModal('å­¦åˆ†å…‘æ¢é‡‘å¸', `
                <div style="margin: 20px 0;">
                    <p>å½“å‰å­¦åˆ†: ${score}</p>
                    <p>æ±‡ç‡: 1å­¦åˆ† = ${rate}é‡‘å¸</p>
                    
                    <label>å…‘æ¢å­¦åˆ†æ•°é‡ï¼š</label>
                    <input type="number" id="exchangeScore" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" value="10">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤å…‘æ¢', onclick: 'handleScoreToGold()', className: 'btn-primary' }
            ]);
        }

        function handleScoreToGold() {
            const studentId = currentUser.student_id;
            const score = parseFloat(document.getElementById('exchangeScore').value);
            
            if (isNaN(score) || score <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }
            
            const currentScore = getStudentScore(studentId);
            if (score > currentScore) {
                alert('å­¦åˆ†ä¸è¶³');
                return;
            }
            
            const gold = score * 0.1;
            
            updateStudentScore(studentId, -score, `å…‘æ¢é‡‘å¸ ${gold.toFixed(2)}`);
            updateStudentGold(studentId, gold);
            
            alert(`å…‘æ¢æˆåŠŸï¼è·å¾— ${gold.toFixed(2)} é‡‘å¸`);
            closeModal();
            showGoldSystem();
        }

        function showGoldToScore() {
            const studentId = currentUser.student_id;
            const gold = getStudentGold(studentId);
            const rate = 1.0;
            
            showModal('é‡‘å¸å…‘æ¢å­¦åˆ†', `
                <div style="margin: 20px 0;">
                    <p>å½“å‰é‡‘å¸: ${gold}</p>
                    <p>æ±‡ç‡: 1é‡‘å¸ = ${rate}å­¦åˆ†</p>
                    
                    <label>å…‘æ¢é‡‘å¸æ•°é‡ï¼š</label>
                    <input type="number" id="exchangeGold" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" value="10">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤å…‘æ¢', onclick: 'handleGoldToScore()', className: 'btn-primary' }
            ]);
        }

        function handleGoldToScore() {
            const studentId = currentUser.student_id;
            const gold = parseFloat(document.getElementById('exchangeGold').value);
            
            if (isNaN(gold) || gold <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }
            
            const currentGold = getStudentGold(studentId);
            if (gold > currentGold) {
                alert('é‡‘å¸ä¸è¶³');
                return;
            }
            
            const score = gold * 1.0;
            
            updateStudentGold(studentId, -gold);
            updateStudentScore(studentId, score, `ç”¨ ${gold} é‡‘å¸å…‘æ¢`);
            
            alert(`å…‘æ¢æˆåŠŸï¼è·å¾— ${score.toFixed(2)} å­¦åˆ†`);
            closeModal();
            showGoldSystem();
        }

        // ==================== æ“ä½œæ—¥å¿— ====================
        function showLogs() {
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
                    
                    <div style="max-height: 500px; overflow-y: auto;">
                        ${(appData.logs || []).map(log => `
                            <div style="padding: 15px; margin: 10px 0; background: #f7fafc; border-radius: 8px;">
                                <div>ğŸ“… ${log.timestamp}</div>
                                <div><strong>${log.student_name}</strong> ${log.action}: ${log.score_change > 0 ? '+' : ''}${log.score_change}åˆ†</div>
                                ${log.reason ? `<div style="color: #718096;">ğŸ“ ${log.reason}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ==================== äº‘ç«¯åŒæ­¥ï¼ˆä»…ä¸Šä¼ ï¼‰====================
        function showCloudSync() {
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">â˜ï¸ äº‘ç«¯åŒæ­¥</h2>
                    
                    <div class="info-box">
                        <strong>ğŸ“Œ è¯´æ˜ï¼š</strong><br>
                        â€¢ é€‰æ‹©åŒ…å«JSONæ–‡ä»¶çš„æ–‡ä»¶å¤¹<br>
                        â€¢ è‡ªåŠ¨ä¸Šä¼ æ‰€æœ‰æ•°æ®åˆ°äº‘ç«¯<br>
                        â€¢ ä¸Šä¼ åè®¾ç½® updated=1
                    </div>
                    
                    <input type="file" id="cloudFolderInput" class="folder-input" webkitdirectory directory multiple onchange="handleCloudUpload(event)">
                    <label for="cloudFolderInput" class="folder-label">
                        ğŸ“ é€‰æ‹©æ•°æ®æ–‡ä»¶å¤¹<br>
                        <span style="font-size: 0.9em; color: #718096;">å°†è‡ªåŠ¨ä¸Šä¼ æ‰€æœ‰JSONæ–‡ä»¶</span>
                    </label>
                    
                    <div id="cloudFileList" class="file-list"></div>
                </div>
            `;
        }

        async function handleCloudUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const fileList = document.getElementById('cloudFileList');
            fileList.style.display = 'block';
            fileList.innerHTML = '';
            
            const fileData = {};
            let jsonCount = 0;
            
            for (let file of files) {
                const fileName = file.name;
                const dataKey = FILE_MAPPING[fileName];
                
                if (dataKey) {
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        fileList.innerHTML += `<div class="file-item success">âœ… ${fileName} - å·²è¯»å–</div>`;
                        
                        if (fileName === 'user.json') {
                            fileData.users = data.users || data;
                        } else if (fileName === 'score.json') {
                            fileData.scores = data.studentDefaultScore || data;
                            fileData.groups = data.studentGroups || {};
                        } else {
                            fileData[dataKey] = data;
                        }
                        
                        jsonCount++;
                        
                    } catch (e) {
                        fileList.innerHTML += `<div class="file-item error">âŒ ${fileName} - è¯»å–å¤±è´¥</div>`;
                    }
                }
            }
            
            if (jsonCount === 0) {
                alert('æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°JSONæ–‡ä»¶');
                return;
            }
            
            fileList.innerHTML += `<div class="file-item success">ğŸ“¤ æ­£åœ¨ä¸Šä¼  ${jsonCount} ä¸ªæ–‡ä»¶...</div>`;
            
            fileData.updated = 1;
            
            try {
                await uploadToCloud(fileData);
                fileList.innerHTML += `<div class="file-item success">âœ… ä¸Šä¼ æˆåŠŸï¼</div>`;
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                if (fileData.users) appData.users = fileData.users;
                if (fileData.scores) appData.scores = fileData.scores;
                if (fileData.groups) appData.groups = fileData.groups;
                
                Object.keys(STORAGE_KEYS).forEach(key => {
                    if (appData[key.toLowerCase()]) {
                        localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(appData[key.toLowerCase()]));
                    }
                });
                
            } catch (error) {
                fileList.innerHTML += `<div class="file-item error">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ==================== æ•°æ®å¤‡ä»½ ====================
        function showBackup() {
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ’¾ æ•°æ®å¤‡ä»½</h2>
                    
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                        <button class="btn btn-primary" onclick="importData()">ğŸ“‚ å¯¼å…¥æ•°æ®</button>
                    </div>
                </div>
            `;
        }

        function exportData() {
            const data = {};
            Object.keys(STORAGE_KEYS).forEach(key => {
                data[key] = appData[key.toLowerCase()];
            });
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `studentos_backup_${formatDate().replace(/[: ]/g, '_')}.json`;
            a.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        Object.keys(STORAGE_KEYS).forEach(key => {
                            if (imported[key]) {
                                localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(imported[key]));
                            }
                        });
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                        location.reload();
                    } catch (err) {
                        alert('å¯¼å…¥å¤±è´¥ï¼šæ— æ•ˆçš„æ•°æ®æ–‡ä»¶');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ==================== è´¦å·ç®¡ç† ====================
        function showAccountManagement() {
            document.getElementById('contentArea').innerHTML = `
                <div class="content-card">
                    <h2 class="card-title">ğŸ‘¤ è´¦å·ç®¡ç†</h2>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <span style="font-size: 5em; cursor: pointer;" onclick="showAvatarSelector()">${currentUser.avatar || 'ğŸ‘¤'}</span>
                    </div>
                    
                    <table class="data-table">
                        <tr><td><strong>ç”¨æˆ·å</strong></td><td>${currentUser.username}</td></tr>
                        <tr><td><strong>æ˜¾ç¤ºåç§°</strong></td><td>${currentUser.display_name}</td></tr>
                        <tr><td><strong>èº«ä»½</strong></td><td>${currentUser.role}</td></tr>
                        <tr><td><strong>å­¦å·</strong></td><td>${currentUser.student_id || 'æ— '}</td></tr>
                    </table>
                    
                    <div class="btn-grid" style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="showChangePassword()">ğŸ”‘ ä¿®æ”¹å¯†ç </button>
                        <button class="btn btn-primary" onclick="showChangeDisplayName()">ğŸ“ ä¿®æ”¹æ˜¾ç¤ºåç§°</button>
                    </div>
                </div>
            `;
        }

        function showChangePassword() {
            showModal('ä¿®æ”¹å¯†ç ', `
                <div style="margin: 20px 0;">
                    <label>æ–°å¯†ç ï¼š</label>
                    <input type="password" id="newPassword" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                    
                    <label>ç¡®è®¤æ–°å¯†ç ï¼š</label>
                    <input type="password" id="confirmPassword" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤ä¿®æ”¹', onclick: 'handleChangePassword()', className: 'btn-primary' }
            ]);
        }

        function handleChangePassword() {
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            
            if (newPass.length < 4) {
                alert('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº4ä½');
                return;
            }
            
            if (newPass !== confirm) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            currentUser.password = newPass;
            appData.users[currentUser.username].password = newPass;
            saveData('users');
            
            alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            closeModal();
        }

        function showChangeDisplayName() {
            showModal('ä¿®æ”¹æ˜¾ç¤ºåç§°', `
                <div style="margin: 20px 0;">
                    <label>æ–°æ˜¾ç¤ºåç§°ï¼š</label>
                    <input type="text" id="newDisplayName" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;" value="${currentUser.display_name}">
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' },
                { text: 'ç¡®è®¤ä¿®æ”¹', onclick: 'handleChangeDisplayName()', className: 'btn-primary' }
            ]);
        }

        function handleChangeDisplayName() {
            const newName = document.getElementById('newDisplayName').value.trim();
            if (!newName) {
                alert('æ˜¾ç¤ºåç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            currentUser.display_name = newName;
            appData.users[currentUser.username].display_name = newName;
            saveData('users');
            
            document.getElementById('userDisplayName').textContent = newName;
            alert('æ˜¾ç¤ºåç§°ä¿®æ”¹æˆåŠŸï¼');
            closeModal();
            showAccountManagement();
        }

        function showAvatarSelector() {
            const emojis = Array.from('ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜‡ğŸ™‚ğŸ™ƒğŸ˜‰ğŸ˜ŒğŸ˜ğŸ¥°ğŸ˜˜');
            
            showModal('é€‰æ‹©å¤´åƒ', `
                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px;">
                    ${emojis.map(emoji => `
                        <div onclick="selectAvatar('${emoji}')" style="font-size: 2em; text-align: center; padding: 5px; cursor: pointer; border-radius: 5px; background: #f7fafc;">
                            ${emoji}
                        </div>
                    `).join('')}
                </div>
            `, [
                { text: 'å–æ¶ˆ', onclick: 'closeModal()' }
            ]);
        }

        function selectAvatar(emoji) {
            currentUser.avatar = emoji;
            appData.users[currentUser.username].avatar = emoji;
            saveData('users');
            document.getElementById('userAvatar').textContent = emoji;
            closeModal();
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function getStudentScore(studentId) {
            return appData.scores[studentId]?.[1] || 0;
        }

        function getStudentGold(studentId) {
            return appData.gold[studentId]?.amount || 0;
        }

        function updateStudentScore(studentId, change, reason = '') {
            if (!appData.scores[studentId]) return false;
            const oldScore = appData.scores[studentId][1];
            appData.scores[studentId][1] = oldScore + change;
            saveData('scores');
            addLog('åˆ†æ•°è°ƒæ•´', studentId, change, appData.scores[studentId][1], reason);
            return true;
        }

        function updateStudentGold(studentId, change) {
            if (!appData.gold[studentId]) {
                appData.gold[studentId] = { amount: 0, last_updated: formatDate() };
            }
            appData.gold[studentId].amount += change;
            appData.gold[studentId].last_updated = formatDate();
            saveData('gold');
            return true;
        }

        function addLog(action, studentId, scoreChange, currentScore, reason = '') {
            const studentName = appData.scores[studentId]?.[0] || 'æœªçŸ¥';
            const log = {
                timestamp: formatDate(),
                action,
                student_id: studentId,
                student_name: studentName,
                score_change: scoreChange,
                current_score: currentScore,
                reason
            };
            appData.logs.unshift(log);
            if (appData.logs.length > 100) appData.logs.pop();
            saveData('logs');
        }

        // ==================== æ¨¡æ€æ¡† ====================
        function showModal(title, body, buttons) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            
            const buttonsDiv = document.getElementById('modalButtons');
            buttonsDiv.innerHTML = '';
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `btn ${btn.className || ''}`;
                button.textContent = btn.text;
                button.onclick = new Function(btn.onclick);
                buttonsDiv.appendChild(button);
            });
            
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // ==================== åˆå§‹åŒ– ====================
        window.onload = function() {
            loadFromStorage();
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ 
            if (Object.keys(appData.users).length === 0) {
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="loading-header">
                        <h1>ğŸ“ StudentOS</h1>
                        <div class="subtitle">é¦–æ¬¡è¿è¡Œï¼Œè¯·é€‰æ‹©æ•°æ®æ–‡ä»¶å¤¹</div>
                    </div>
                    
                    <input type="file" id="initialFolderInput" class="folder-input" webkitdirectory directory multiple onchange="handleInitialUpload(event)">
                    <label for="initialFolderInput" class="folder-label">
                        ğŸ“ é€‰æ‹©æ•°æ®æ–‡ä»¶å¤¹<br>
                        <span style="font-size: 0.9em; color: #718096;">å°†è‡ªåŠ¨è¯»å–æ‰€æœ‰JSONæ–‡ä»¶</span>
                    </label>
                `;
            } else {
                // æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'block';
                    renderUserSelect();
                }, 1000);
            }
        };

        async function handleInitialUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            document.getElementById('loadingScreen').innerHTML = `
                <div class="loading-header">
                    <h1>ğŸ“ StudentOS</h1>
                    <div class="subtitle">æ­£åœ¨åŠ è½½æ•°æ®...</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 50%"></div>
                </div>
            `;
            
            for (let file of files) {
                const fileName = file.name;
                const dataKey = FILE_MAPPING[fileName];
                
                if (dataKey) {
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        if (fileName === 'user.json') {
                            appData.users = data.users || data;
                        } else if (fileName === 'score.json') {
                            appData.scores = data.studentDefaultScore || data;
                            appData.groups = data.studentGroups || {};
                        } else {
                            appData[dataKey] = data;
                        }
                        
                    } catch (e) {
                        console.error(`è¯»å–å¤±è´¥ ${fileName}:`, e);
                    }
                }
            }
            
            // ä¿å­˜åˆ°localStorage
            Object.keys(STORAGE_KEYS).forEach(key => {
                if (appData[key.toLowerCase()]) {
                    localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(appData[key.toLowerCase()]));
                }
            });
            
            document.getElementById('progressFill').style.width = '100%';
            
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
                renderUserSelect();
            }, 1000);
        }
    </script>
</body>
</html>